<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>两岸网络延迟监测工具 - 增强版</title>
    <!-- 使用本地可访问的CDN链接 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        /* [样式代码保持不变，与原始文件相同] */
        :root {
            --primary-color: #2563eb;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border-radius: 0 0 12px 12px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .current-time {
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tabs {
            display: flex;
            background-color: white;
            border-radius: 10px;
            padding: 6px;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab:hover {
            background-color: #f3f4f6;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        
        .card-title i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .stat-box {
            background-color: #f8fafc;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .latency-good {
            color: var(--secondary-color);
        }
        
        .latency-medium {
            color: var(--warning-color);
        }
        
        .latency-bad {
            color: var(--danger-color);
        }
        
        .time-period-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .peak-period {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .offpeak-period {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .control-group {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .control-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        select, input, button {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: #1d4ed8;
        }
        
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        button.secondary {
            background-color: #6b7280;
        }
        
        button.secondary:hover {
            background-color: #4b5563;
        }
        
        button.success {
            background-color: var(--secondary-color);
        }
        
        button.success:hover {
            background-color: #0da271;
        }
        
        button.warning {
            background-color: var(--warning-color);
        }
        
        button.warning:hover {
            background-color: #d97706;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .button-group button {
            flex: 1;
        }
        
        .chart-container {
            height: 400px;
            margin-bottom: 1.5rem;
        }
        
        .nodes-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .node-card {
            background-color: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s;
        }
        
        .node-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .node-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .node-location {
            font-size: 0.9rem;
            color: #6b7280;
            background-color: #f3f4f6;
            padding: 3px 8px;
            border-radius: 4px;
        }
        
        .node-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .node-stat {
            text-align: center;
        }
        
        .node-stat-value {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .node-stat-label {
            color: #6b7280;
            font-size: 0.8rem;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .history-table th, .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .history-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        
        .history-table tr:hover {
            background-color: #f9fafb;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: var(--secondary-color);
        }
        
        .status-offline {
            background-color: var(--danger-color);
        }
        
        .status-warning {
            background-color: var(--warning-color);
        }
        
        .import-export-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin-top: 1rem;
            background-color: #f9fafb;
        }
        
        .import-export-area:hover {
            border-color: var(--primary-color);
        }
        
        .file-input {
            margin-bottom: 1rem;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            transform: translateX(150%);
            transition: transform 0.5s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--secondary-color);
        }
        
        .notification.error {
            background-color: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger-color);
        }
        
        .notification.info {
            background-color: #dbeafe;
            color: #1e40af;
            border-left: 4px solid var(--primary-color);
        }
        
        .notification.warning {
            background-color: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--warning-color);
        }
        
        .footer {
            text-align: center;
            margin-top: 2rem;
            color: #6b7280;
            font-size: 0.9rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .nodes-upload-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: #f8fafc;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .nodes-template {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.85rem;
            overflow-x: auto;
        }
        
        .cloudflare-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: #f0f9ff;
            border-radius: 10px;
            border: 1px solid #bae6fd;
        }
        
        /* 新增的用户ID管理样式 */
        .user-id-management {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }
        
        .user-id-actions {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .user-id-actions button {
            flex: 1;
            min-width: 150px;
        }
        
        .data-integration {
            background-color: #f0f9ff;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #bae6fd;
        }
        
        /* 新增：同步状态监控样式 */
        .sync-status-panel {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #bae6fd;
            margin-bottom: 1.5rem;
        }
        
        .sync-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .sync-status-item {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .sync-status-item.warning {
            border-left-color: var(--warning-color);
            background-color: #fef3c7;
        }
        
        .sync-status-item.error {
            border-left-color: var(--danger-color);
            background-color: #fee2e2;
        }
        
        .sync-status-item.success {
            border-left-color: var(--secondary-color);
            background-color: #d1fae5;
        }
        
        .sync-progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        
        .sync-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .sync-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .sync-history-table th {
            background-color: #f8fafc;
            font-weight: 600;
            text-align: left;
            padding: 10px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .sync-history-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sync-history-table tr:hover {
            background-color: #f9fafb;
        }
        
        .sync-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .sync-action-buttons button {
            flex: 1;
        }
        
        .kv-stats-panel {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        
        .kv-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .kv-stat-item {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .kv-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }
        
        .kv-stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .data-consistency-panel {
            background-color: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        
        .consistency-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .consistency-status.good {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .consistency-status.warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .consistency-status.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .consistency-details {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-top: 1rem;
        }
        
        .consistency-details table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .consistency-details td {
            padding: 8px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .consistency-details td:first-child {
            font-weight: 500;
            color: #6b7280;
        }
        
        .conflict-resolution-panel {
            background-color: #fef3c7;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--warning-color);
            margin-bottom: 1.5rem;
        }
        
        .conflict-item {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--warning-color);
        }
        
        .conflict-actions {
            display: flex;
            gap: 10px;
            margin-top: 0.5rem;
        }
        
        .conflict-actions button {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .device-management-panel {
            background-color: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        
        .device-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .device-card {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .device-name {
            font-weight: 600;
        }
        
        .device-status {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .device-status.online {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .device-status.offline {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        
        .device-status.syncing {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .user-id-actions button {
                min-width: 100%;
            }
            
            .sync-status-grid,
            .kv-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .sync-action-buttons,
            .conflict-actions {
                flex-direction: column;
            }
            
            .device-list {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .sync-status-grid,
            .kv-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-satellite-dish"></i>
                    <span>两岸网络延迟监测工具</span>
                </div>
                <div class="current-time">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">--:--:--</span>
                    <span id="time-period" class="time-period-indicator offpeak-period">离峰时段</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> 仪表板
            </div>
            <div class="tab" data-tab="monitoring">
                <i class="fas fa-desktop"></i> 实时监控
            </div>
            <div class="tab" data-tab="analysis">
                <i class="fas fa-chart-line"></i> 数据分析
            </div>
            <div class="tab" data-tab="nodes">
                <i class="fas fa-server"></i> 节点管理
            </div>
            <div class="tab" data-tab="history">
                <i class="fas fa-history"></i> 历史数据
            </div>
            <div class="tab" data-tab="import-export">
                <i class="fas fa-file-import"></i> 导入/导出
            </div>
            <div class="tab" data-tab="cloudflare">
                <i class="fas fa-cloud"></i> 云端同步
            </div>
            <!-- 新增的用户ID管理标签 -->
            <div class="tab" data-tab="userid">
                <i class="fas fa-users"></i> 用户管理
            </div>
            <!-- 新增的KV状态标签 -->
            <div class="tab" data-tab="kv-status">
                <i class="fas fa-database"></i> KV状态
            </div>
        </div>

        <!-- 仪表板标签 -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard">
                <div class="card">
                    <div class="card-title">
                        <span><i class="fas fa-globe-asia"></i> 当前网络状态</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value latency-good" id="current-mainland-latency">--</div>
                            <div class="stat-label">大陆节点延迟</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value latency-good" id="current-taiwan-latency">--</div>
                            <div class="stat-label">台湾节点延迟</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="network-quality">--</div>
                            <div class="stat-label">网络质量</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="packet-loss">0%</div>
                            <div class="stat-label">丢包率</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span><i class="fas fa-clock"></i> 定时器状态</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="next-test-timer">--:--</div>
                            <div class="stat-label">下次测试</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="next-save-timer">--:--</div>
                            <div class="stat-label">下次自动保存</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="tests-count">0</div>
                            <div class="stat-label">今日测试次数</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="data-points">0</div>
                            <div class="stat-label">数据点数</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-area"></i> 延迟趋势 (24小时)</span>
                    <div>
                        <select id="chart-period">
                            <option value="24h">24小时</option>
                            <option value="7d">7天</option>
                            <option value="30d">30天</option>
                            <option value="90d">90天</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-info-circle"></i> 状态信息</span>
                </div>
                <div id="status-message">
                    <p><i class="fas fa-user-circle"></i> 用户位置: <span id="user-location-display">未设置</span></p>
                    <p><i class="fas fa-wifi"></i> 监测状态: <span id="monitoring-status" class="latency-good">未启动</span></p>
                    <p><i class="fas fa-bell"></i> 时段建议: <span id="period-suggestion">--</span></p>
                    <p><i class="fas fa-cloud"></i> 云端状态: <span id="cloud-status">未连接</span></p>
                    <p><i class="fas fa-id-card"></i> 用户ID: <span id="current-user-id-display">未设置</span></p>
                </div>
            </div>
        </div>

        <!-- 实时监控标签 -->
        <div id="monitoring" class="tab-content">
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-map-marker-alt"></i> 用户位置设置
                    </div>
                    <div class="form-group">
                        <label for="user-location">选择您的位置</label>
                        <select id="user-location">
                            <option value="">请选择位置</option>
                            <optgroup label="中国大陆">
                                <option value="beijing">北京</option>
                                <option value="shanghai">上海</option>
                                <option value="shenzhen">深圳</option>
                                <option value="guangzhou">广州</option>
                                <option value="hangzhou">杭州</option>
                                <option value="chengdu">成都</option>
                                <option value="wuhan">武汉</option>
                                <option value="nanjing">南京</option>
                            </optgroup>
                            <optgroup label="台湾地区">
                                <option value="taipei">台北市</option>
                                <option value="taoyuan">桃园市</option>
                                <option value="taichung">台中市</option>
                                <option value="tainan">台南市</option>
                                <option value="kaohsiung">高雄市</option>
                                <option value="hsinchu">新竹市</option>
                            </optgroup>
                        </select>
                    </div>
                    <button id="save-location" class="success">
                        <i class="fas fa-save"></i> 保存位置设置
                    </button>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-sliders-h"></i> 定时设置
                    </div>
                    <div class="form-group">
                        <label for="test-interval">测试频率</label>
                        <select id="test-interval">
                            <option value="30">每30秒</option>
                            <option value="60" selected>每1分钟</option>
                            <option value="300">每5分钟</option>
                            <option value="600">每10分钟</option>
                            <option value="1800">每30分钟</option>
                            <option value="3600">每1小时</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="save-interval">自动保存频率</label>
                        <select id="save-interval">
                            <option value="300">每5分钟</option>
                            <option value="600">每10分钟</option>
                            <option value="1800" selected>每30分钟</option>
                            <option value="3600">每1小时</option>
                            <option value="7200">每2小时</option>
                            <option value="14400">每4小时</option>
                            <option value="28800">每8小时</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button id="start-monitoring" class="success">
                            <i class="fas fa-play"></i> 开始监控
                        </button>
                        <button id="stop-monitoring" class="warning">
                            <i class="fas fa-stop"></i> 停止监控
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-bolt"></i> 立即测试
                    </div>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #6b7280;">
                        点击下方按钮立即执行一次网络延迟测试
                    </p>
                    <button id="test-now">
                        <i class="fas fa-sync-alt"></i> 立即测试
                    </button>
                    <div class="button-group">
                        <button id="test-mainland" class="secondary">
                            <i class="fas fa-map"></i> 仅测试大陆节点
                        </button>
                        <button id="test-taiwan" class="secondary">
                            <i class="fas fa-map"></i> 仅测试台湾节点
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-list"></i> 最近测试结果</span>
                </div>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>大陆节点延迟</th>
                            <th>台湾节点延迟</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="recent-tests">
                        <tr>
                            <td colspan="4" style="text-align: center;">暂无测试数据</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 数据分析标签 -->
        <div id="analysis" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-bar"></i> 延迟统计分析</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="avg-latency-mainland">--</div>
                        <div class="stat-label">大陆平均延迟</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avg-latency-taiwan">--</div>
                        <div class="stat-label">台湾平均延迟</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="std-dev-mainland">--</div>
                        <div class="stat-label">大陆延迟标准差</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="std-dev-taiwan">--</div>
                        <div class="stat-label">台湾延迟标准差</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-pie"></i> 时段分析</span>
                </div>
                <div class="chart-container">
                    <canvas id="periodAnalysisChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-percentage"></i> 延迟基准分析</span>
                </div>
                <div id="baseline-analysis">
                    <p><i class="fas fa-arrow-up"></i> 尖峰时段基准延迟: <span id="peak-baseline">--</span> ms</p>
                    <p><i class="fas fa-arrow-down"></i> 离峰时段基准延迟: <span id="offpeak-baseline">--</span> ms</p>
                    <p><i class="fas fa-arrows-alt-h"></i> 正常波动范围: <span id="normal-range">--</span> ms</p>
                    <p><i class="fas fa-exclamation-triangle"></i> 异常检测: <span id="anomaly-count">0</span> 个异常点</p>
                </div>
                <button id="run-analysis" class="success" style="margin-top: 1rem;">
                    <i class="fas fa-calculator"></i> 重新分析数据
                </button>
            </div>
        </div>

        <!-- 节点管理标签 -->
        <div id="nodes" class="tab-content">
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-plus-circle"></i> 添加自定义节点
                    </div>
                    <div class="form-group">
                        <label for="node-name">节点名称</label>
                        <input type="text" id="node-name" placeholder="例如: 台北主节点">
                    </div>
                    <div class="form-group">
                        <label for="node-host">主机地址/IP</label>
                        <input type="text" id="node-host" placeholder="例如: ping.tpe.example.com 或 8.8.8.8">
                    </div>
                    <div class="form-group">
                        <label for="node-location">节点位置</label>
                        <select id="node-location">
                            <option value="mainland">中国大陆</option>
                            <option value="taiwan">台湾地区</option>
                        </select>
                    </div>
                    <button id="add-custom-node" class="success">
                        <i class="fas fa-plus"></i> 添加节点
                    </button>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-cog"></i> 节点设置
                    </div>
                    <div class="form-group">
                        <label for="default-mainland-node">默认大陆测试节点</label>
                        <select id="default-mainland-node">
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-taiwan-node">默认台湾测试节点</label>
                        <select id="default-taiwan-node">
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    <button id="save-node-settings">
                        <i class="fas fa-save"></i> 保存节点设置
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-server"></i> 节点列表</span>
                    <div>
                        <button id="export-nodes" class="secondary">
                            <i class="fas fa-download"></i> 导出节点列表
                        </button>
                    </div>
                </div>
                <div class="nodes-list" id="nodes-list">
                    <!-- 节点将通过JavaScript动态添加 -->
                </div>
                
                <!-- 节点上传功能区域 -->
                <div class="nodes-upload-section">
                    <div class="control-title">
                        <i class="fas fa-file-upload"></i> 上传节点列表
                    </div>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #6b7280;">
                        上传JSON格式的节点列表文件，将更新当前节点配置
                    </p>
                    <div class="import-export-area">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #9ca3af; margin-bottom: 1rem;"></i>
                        <p style="margin-bottom: 1rem; font-weight: 600;">拖放节点文件到此处或点击选择</p>
                        <input type="file" id="upload-nodes-file" class="file-input" accept=".json">
                        <p style="font-size: 0.85rem; color: #6b7280;">支持JSON格式节点列表，上传后将替换现有节点</p>
                    </div>
                    <div class="button-group" style="margin-top: 1rem;">
                        <button id="upload-nodes" class="secondary">
                            <i class="fas fa-upload"></i> 上传并更新节点
                        </button>
                        <button id="reset-nodes" class="warning">
                            <i class="fas fa-undo"></i> 重置为默认节点
                        </button>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <p><strong>节点文件格式说明:</strong></p>
                        <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">JSON文件应包含节点对象，键为节点ID，值为节点信息：</p>
                        <div class="nodes-template">
<pre>{
  "cn_bj_cloud": {
    "name": "北京腾讯云节点",
    "host": "49.232.189.68",
    "location": "mainland",
    "type": "ping"
  },
  "tw_nchc": {
    "name": "台湾杉一号 (NCHC)",
    "host": "140.110.148.11",
    "location": "taiwan", 
    "type": "ping"
  }
  // ... 更多节点
}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 历史数据标签 -->
        <div id="history" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-database"></i> 历史数据</span>
                    <div>
                        <button id="clear-history" class="warning">
                            <i class="fas fa-trash"></i> 清除历史
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>时间戳</th>
                                <th>用户位置</th>
                                <th>大陆节点</th>
                                <th>大陆延迟</th>
                                <th>台湾节点</th>
                                <th>台湾延迟</th>
                                <th>时段</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="history-data">
                            <tr>
                                <td colspan="8" style="text-align: center;">暂无历史数据</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="button-group" style="margin-top: 1rem;">
                    <button id="prev-page" class="secondary">
                        <i class="fas fa-chevron-left"></i> 上一页
                    </button>
                    <button id="next-page" class="secondary">
                        下一页 <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <p style="text-align: center; margin-top: 1rem; color: #6b7280;">
                    显示第 <span id="current-page">1</span> 页，共 <span id="total-pages">1</span> 页
                </p>
            </div>
        </div>

        <!-- 导入/导出标签 -->
        <div id="import-export" class="tab-content">
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-file-export"></i> 导出数据
                    </div>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #6b7280;">
                        将历史数据导出为JSON或CSV格式
                    </p>
                    <div class="button-group">
                        <button id="export-json" class="success">
                            <i class="fas fa-file-code"></i> 导出为JSON
                        </button>
                        <button id="export-csv" class="success">
                            <i class="fas fa-file-csv"></i> 导出为CSV
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-file-import"></i> 导入数据
                    </div>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #6b7280;">
                        导入JSON或CSV格式的历史数据，系统会自动去重
                    </p>
                    <div class="import-export-area">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #9ca3af; margin-bottom: 1rem;"></i>
                        <p style="margin-bottom: 1rem; font-weight: 600;">拖放文件到此处或点击选择</p>
                        <input type="file" id="import-file" class="file-input" accept=".json,.csv" multiple>
                        <p style="font-size: 0.85rem; color: #6b7280;">支持多个文件同时导入，系统会自动合并和去重</p>
                    </div>
                    <div class="button-group" style="margin-top: 1rem;">
                        <button id="import-data" class="secondary">
                            <i class="fas fa-upload"></i> 导入数据
                        </button>
                        <button id="clear-import" class="warning">
                            <i class="fas fa-times"></i> 清除选择
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-info-circle"></i> 导入/导出说明</span>
                </div>
                <div>
                    <p><strong>导出功能:</strong></p>
                    <ul style="padding-left: 1.5rem; margin-bottom: 1rem;">
                        <li>JSON格式: 包含完整数据，适合备份和迁移</li>
                        <li>CSV格式: 适合在电子表格中打开和分析</li>
                    </ul>
                    
                    <p><strong>导入功能:</strong></p>
                    <ul style="padding-left: 1.5rem; margin-bottom: 1rem;">
                        <li>支持多个文件同时导入</li>
                        <li>系统会自动去重（基于时间戳和节点）</li>
                        <li>导入数据会与现有数据合并</li>
                        <li>导入后请运行数据分析以更新统计信息</li>
                    </ul>
                    
                    <p><strong>数据格式:</strong></p>
                    <pre style="background-color: #f3f4f6; padding: 1rem; border-radius: 8px; font-size: 0.85rem; overflow-x: auto;">
{
  "timestamp": "2024-01-01T12:00:00Z",
  "userLocation": "shenzhen",
  "mainlandNode": "cn_bj_cloud",
  "mainlandLatency": 45,
  "taiwanNode": "tw_nchc",
  "taiwanLatency": 68,
  "period": "peak"
}</pre>
                </div>
            </div>
        </div>

        <!-- Cloudflare 云端同步标签 - 增强版 -->
        <div id="cloudflare" class="tab-content">
            <!-- 同步状态监控面板 -->
            <div class="sync-status-panel">
                <div class="card-title">
                    <span><i class="fas fa-sync-alt"></i> 同步状态监控</span>
                    <div>
                        <button id="refresh-sync-status" class="secondary">
                            <i class="fas fa-redo"></i> 刷新状态
                        </button>
                    </div>
                </div>
                
                <div class="sync-status-grid">
                    <div class="sync-status-item" id="sync-overall-status">
                        <h4><i class="fas fa-cloud"></i> 整体状态</h4>
                        <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0;">--</p>
                        <p style="color: #6b7280; font-size: 0.9rem;">最后同步: <span id="sync-last-time">从未同步</span></p>
                    </div>
                    
                    <div class="sync-status-item" id="sync-connection-status">
                        <h4><i class="fas fa-plug"></i> 连接状态</h4>
                        <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0;">--</p>
                        <p style="color: #6b7280; font-size: 0.9rem;">延迟: <span id="sync-latency">-- ms</span></p>
                    </div>
                    
                    <div class="sync-status-item" id="sync-data-status">
                        <h4><i class="fas fa-database"></i> 数据状态</h4>
                        <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0;">--</p>
                        <p style="color: #6b7280; font-size: 0.9rem;">本地/云端: <span id="sync-data-count">0/0</span></p>
                    </div>
                    
                    <div class="sync-status-item" id="sync-progress-status">
                        <h4><i class="fas fa-spinner"></i> 同步进度</h4>
                        <div class="sync-progress-bar">
                            <div class="sync-progress-fill" id="sync-progress-fill" style="width: 0%"></div>
                        </div>
                        <p style="color: #6b7280; font-size: 0.9rem; margin-top: 0.25rem;">状态: <span id="sync-progress-text">空闲</span></p>
                    </div>
                </div>
                
                <!-- 同步操作按钮 -->
                <div class="sync-action-buttons">
                    <button id="full-sync" class="success">
                        <i class="fas fa-sync-alt"></i> 完整同步
                    </button>
                    <button id="sync-upload-only" class="secondary">
                        <i class="fas fa-cloud-upload-alt"></i> 仅上传
                    </button>
                    <button id="sync-download-only" class="secondary">
                        <i class="fas fa-cloud-download-alt"></i> 仅下载
                    </button>
                    <button id="validate-sync" class="warning">
                        <i class="fas fa-check-circle"></i> 验证数据
                    </button>
                </div>
            </div>
            
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-cloud"></i> Cloudflare 云端同步
                    </div>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #6b7280;">
                        将数据同步到 Cloudflare Workers，实现跨设备访问和数据备份
                    </p>
                    <div class="form-group">
                        <label for="cloudflare-worker-url">Cloudflare Worker URL</label>
                        <input type="text" id="cloudflare-worker-url" value="https://latency-monitor-api.mgjack13.workers.dev" readonly>
                        <small style="color: #6b7280; display: block; margin-top: 5px;">你的 Worker 地址，无需修改</small>
                    </div>
                    <div class="form-group">
                        <label for="cloudflare-user-id">你的用户ID</label>
                        <input type="text" id="cloudflare-user-id" placeholder="输入自定义用户ID">
                        <small style="color: #6b7280; display: block; margin-top: 5px;">自定义用户ID，用于在不同设备间同步数据</small>
                    </div>
                    <div class="button-group">
                        <button id="save-user-id" class="success">
                            <i class="fas fa-save"></i> 保存用户ID
                        </button>
                        <button id="generate-user-id" class="secondary">
                            <i class="fas fa-id-card"></i> 生成新ID
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-sync"></i> 同步操作
                    </div>
                    <div class="button-group">
                        <button id="sync-to-cloud" class="success">
                            <i class="fas fa-cloud-upload-alt"></i> 同步到云端
                        </button>
                        <button id="sync-from-cloud" class="secondary">
                            <i class="fas fa-cloud-download-alt"></i> 从云端同步
                        </button>
                    </div>
                    <div class="button-group">
                        <button id="backup-all" class="warning">
                            <i class="fas fa-database"></i> 完整备份
                        </button>
                        <button id="restore-backup" class="warning">
                            <i class="fas fa-history"></i> 恢复备份
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-cog"></i> 同步设置
                    </div>
                    <div class="form-group">
                        <label for="sync-strategy">同步策略</label>
                        <select id="sync-strategy">
                            <option value="full">完整同步</option>
                            <option value="incremental" selected>增量同步</option>
                            <option value="manual">手动同步</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sync-frequency">同步频率</label>
                        <select id="sync-frequency">
                            <option value="realtime">实时同步</option>
                            <option value="5min" selected>每5分钟</option>
                            <option value="30min">每30分钟</option>
                            <option value="hourly">每小时</option>
                            <option value="daily">每天</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="conflict-resolution">冲突解决策略</label>
                        <select id="conflict-resolution">
                            <option value="newer">保留最新数据</option>
                            <option value="local">优先本地数据</option>
                            <option value="remote">优先云端数据</option>
                            <option value="merge">自动合并</option>
                        </select>
                    </div>
                    <button id="save-sync-settings" class="success">
                        <i class="fas fa-save"></i> 保存同步设置
                    </button>
                </div>
            </div>
            
            <!-- 数据一致性检查面板 -->
            <div class="data-consistency-panel">
                <div class="card-title">
                    <span><i class="fas fa-check-double"></i> 数据一致性检查</span>
                    <div>
                        <button id="check-consistency" class="secondary">
                            <i class="fas fa-search"></i> 检查一致性
                        </button>
                    </div>
                </div>
                
                <div class="consistency-status" id="consistency-status">
                    <i class="fas fa-info-circle"></i>
                    <span>数据一致性状态: 未检查</span>
                </div>
                
                <div class="consistency-details" id="consistency-details" style="display: none;">
                    <h4>一致性检查结果</h4>
                    <table>
                        <tr>
                            <td>本地数据总数:</td>
                            <td id="local-data-total">0</td>
                        </tr>
                        <tr>
                            <td>云端数据总数:</td>
                            <td id="cloud-data-total">0</td>
                        </tr>
                        <tr>
                            <td>缺失数据:</td>
                            <td id="missing-data">0</td>
                        </tr>
                        <tr>
                            <td>冲突数据:</td>
                            <td id="conflict-data">0</td>
                        </tr>
                        <tr>
                            <td>一致性得分:</td>
                            <td id="consistency-score">0%</td>
                        </tr>
                    </table>
                    <div class="button-group" style="margin-top: 1rem;">
                        <button id="resolve-inconsistencies" class="success">
                            <i class="fas fa-hammer"></i> 修复不一致
                        </button>
                        <button id="view-conflicts" class="warning">
                            <i class="fas fa-exclamation-triangle"></i> 查看冲突
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 同步历史记录 -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-history"></i> 同步历史记录</span>
                    <div>
                        <button id="clear-sync-history" class="warning">
                            <i class="fas fa-trash"></i> 清除历史
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="sync-history-table">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>操作</th>
                                <th>数据量</th>
                                <th>状态</th>
                                <th>耗时</th>
                                <th>详情</th>
                            </tr>
                        </thead>
                        <tbody id="sync-history-data">
                            <tr>
                                <td colspan="6" style="text-align: center;">暂无同步记录</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="button-group" style="margin-top: 1rem;">
                    <button id="prev-sync-page" class="secondary">
                        <i class="fas fa-chevron-left"></i> 上一页
                    </button>
                    <button id="next-sync-page" class="secondary">
                        下一页 <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 新增的用户ID管理标签 -->
        <div id="userid" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-user-cog"></i> 用户ID管理</span>
                </div>
                
                <div class="user-id-management">
                    <h3 style="margin-bottom: 1rem; color: var(--dark-color);">
                        <i class="fas fa-id-card"></i> 当前用户ID
                    </h3>
                    <div class="form-group">
                        <label for="custom-user-id">自定义用户ID</label>
                        <input type="text" id="custom-user-id" placeholder="输入您的自定义用户ID (如: user_001)">
                        <small style="color: #6b7280; display: block; margin-top: 5px;">
                            使用相同的用户ID在不同设备上可以共享数据。建议使用有意义的ID，如: user_001, user_beijing等。
                        </small>
                    </div>
                    
                    <div class="user-id-actions">
                        <button id="set-custom-user-id" class="success">
                            <i class="fas fa-save"></i> 设置用户ID
                        </button>
                        <button id="generate-random-user-id" class="secondary">
                            <i class="fas fa-random"></i> 生成随机ID
                        </button>
                        <button id="reset-user-id" class="warning">
                            <i class="fas fa-undo"></i> 重置为默认
                        </button>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <p><strong>当前用户ID:</strong> <span id="current-user-id" style="font-weight: bold; color: var(--primary-color);">未设置</span></p>
                        <p><strong>用户ID类型:</strong> <span id="user-id-type">默认随机ID</span></p>
                        <p><strong>设备数量:</strong> <span id="device-count">1</span> 台</p>
                    </div>
                </div>
                
                <!-- 设备管理面板 -->
                <div class="device-management-panel">
                    <h3 style="margin-bottom: 1rem; color: var(--dark-color);">
                        <i class="fas fa-laptop"></i> 设备管理
                    </h3>
                    
                    <div class="device-list" id="device-list">
                        <!-- 设备卡片将通过JavaScript动态添加 -->
                    </div>
                    
                    <div class="button-group" style="margin-top: 1rem;">
                        <button id="refresh-devices" class="secondary">
                            <i class="fas fa-redo"></i> 刷新设备列表
                        </button>
                        <button id="add-device" class="success">
                            <i class="fas fa-plus"></i> 添加设备
                        </button>
                    </div>
                </div>
                
                <div class="data-integration">
                    <h3 style="margin-bottom: 1rem; color: var(--dark-color);">
                        <i class="fas fa-database"></i> 数据整合功能
                    </h3>
                    
                    <div class="form-group">
                        <label for="merge-user-id">合并其他用户ID的数据</label>
                        <input type="text" id="merge-user-id" placeholder="输入要合并的用户ID">
                        <small style="color: #6b7280; display: block; margin-top: 5px;">
                            输入其他用户ID，将其数据合并到当前数据中（用于整合不同用户的数据）
                        </small>
                    </div>
                    
                    <div class="user-id-actions">
                        <button id="merge-user-data" class="success">
                            <i class="fas fa-merge"></i> 合并用户数据
                        </button>
                        <button id="compare-user-data" class="secondary">
                            <i class="fas fa-balance-scale"></i> 比较用户数据
                        </button>
                        <button id="export-user-data" class="warning">
                            <i class="fas fa-download"></i> 导出当前用户数据
                        </button>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <p><strong>说明:</strong></p>
                        <ul style="padding-left: 1.5rem; margin-bottom: 1rem;">
                            <li><strong>设置用户ID</strong>: 在不同设备上使用相同的用户ID，可以实现数据自动同步</li>
                            <li><strong>合并用户数据</strong>: 将其他用户的数据合并到当前数据中，用于整合分析</li>
                            <li><strong>比较用户数据</strong>: 对比不同用户的数据统计信息</li>
                            <li><strong>导出用户数据</strong>: 导出当前用户的所有数据，包括配置和历史记录</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-bar"></i> 用户数据统计</span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="total-users">1</div>
                        <div class="stat-label">用户总数</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="total-data-points">0</div>
                        <div class="stat-label">总数据点数</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avg-latency-all">--</div>
                        <div class="stat-label">平均延迟</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="data-coverage">0%</div>
                        <div class="stat-label">数据覆盖率</div>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem;">
                    <h4>用户数据列表</h4>
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>用户ID</th>
                                    <th>数据点数</th>
                                    <th>最后同步</th>
                                    <th>设备数量</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="user-data-list">
                                <tr>
                                    <td colspan="5" style="text-align: center;">暂无其他用户数据</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 新增的KV状态标签 -->
        <div id="kv-status" class="tab-content">
            <div class="kv-stats-panel">
                <div class="card-title">
                    <span><i class="fas fa-database"></i> KV存储状态</span>
                    <div>
                        <button id="refresh-kv-stats" class="secondary">
                            <i class="fas fa-redo"></i> 刷新状态
                        </button>
                    </div>
                </div>
                
                <div class="kv-stats-grid">
                    <div class="kv-stat-item">
                        <div class="kv-stat-value" id="kv-total-users">--</div>
                        <div class="kv-stat-label">总用户数</div>
                    </div>
                    
                    <div class="kv-stat-item">
                        <div class="kv-stat-value" id="kv-total-keys">--</div>
                        <div class="kv-stat-label">总Key数</div>
                    </div>
                    
                    <div class="kv-stat-item">
                        <div class="kv-stat-value" id="kv-total-data">--</div>
                        <div class="kv-stat-label">总数据条数</div>
                    </div>
                    
                    <div class="kv-stat-item">
                        <div class="kv-stat-value" id="kv-storage-used">--</div>
                        <div class="kv-stat-label">存储使用量</div>
                    </div>
                </div>
                
                <div class="sync-progress-bar" style="margin-top: 1rem;">
                    <div class="sync-progress-fill" id="kv-storage-progress" style="width: 0%"></div>
                </div>
                <p style="color: #6b7280; font-size: 0.9rem; margin-top: 0.25rem; text-align: center;">
                    存储使用率: <span id="kv-storage-percent">0%</span>
                </p>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-line"></i> KV使用趋势</span>
                </div>
                <div class="chart-container">
                    <canvas id="kvUsageChart"></canvas>
                </div>
            </div>
            
            <!-- KV管理工具 -->
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-tools"></i> KV管理工具
                    </div>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #6b7280;">
                        管理和维护KV存储中的数据
                    </p>
                    <div class="button-group">
                        <button id="kv-backup-all" class="success">
                            <i class="fas fa-download"></i> 备份所有KV数据
                        </button>
                        <button id="kv-cleanup-old" class="warning">
                            <i class="fas fa-broom"></i> 清理旧数据
                        </button>
                    </div>
                    <div class="button-group">
                        <button id="kv-export-stats" class="secondary">
                            <i class="fas fa-file-export"></i> 导出KV统计
                        </button>
                        <button id="kv-health-check" class="secondary">
                            <i class="fas fa-heartbeat"></i> 健康检查
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-search"></i> 数据搜索
                    </div>
                    <div class="form-group">
                        <label for="kv-search-user">搜索用户数据</label>
                        <input type="text" id="kv-search-user" placeholder="输入用户ID进行搜索">
                    </div>
                    <div class="form-group">
                        <label for="kv-search-date">按日期搜索</label>
                        <input type="date" id="kv-search-date">
                    </div>
                    <button id="kv-search" class="success">
                        <i class="fas fa-search"></i> 搜索数据
                    </button>
                </div>
            </div>
            
            <!-- KV数据列表 -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-list"></i> KV数据列表</span>
                    <div>
                        <select id="kv-data-filter" style="width: auto;">
                            <option value="all">全部数据</option>
                            <option value="users">用户数据</option>
                            <option value="configs">配置数据</option>
                            <option value="history">历史记录</option>
                        </select>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>类型</th>
                                <th>用户</th>
                                <th>大小</th>
                                <th>最后修改</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="kv-data-list">
                            <tr>
                                <td colspan="6" style="text-align: center;">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="button-group" style="margin-top: 1rem;">
                    <button id="prev-kv-page" class="secondary">
                        <i class="fas fa-chevron-left"></i> 上一页
                    </button>
                    <button id="next-kv-page" class="secondary">
                        下一页 <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <p style="text-align: center; margin-top: 1rem; color: #6b7280;">
                    显示第 <span id="current-kv-page">1</span> 页，共 <span id="total-kv-pages">1</span> 页
                </p>
            </div>
            
            <!-- KV性能监控 -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-tachometer-alt"></i> KV性能监控</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="kv-read-latency">--</div>
                        <div class="stat-label">读取延迟</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="kv-write-latency">--</div>
                        <div class="stat-label">写入延迟</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="kv-success-rate">--</div>
                        <div class="stat-label">成功率</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="kv-requests">--</div>
                        <div class="stat-label">请求数/小时</div>
                    </div>
                </div>
                <button id="start-kv-monitoring" class="success" style="margin-top: 1rem;">
                    <i class="fas fa-play"></i> 开始性能监控
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>两岸网络延迟监测工具 v2.0 | 增强数据同步 | KV存储管理 | 多设备支持 | 数据一致性保证</p>
            <p>前端: GitHub Pages | 后端: Cloudflare Workers + LATENCY_KV | 数据: 本地存储 + 云端KV + 实时同步</p>
            <p>注意: 使用相同的用户ID在不同设备上可以自动同步数据，支持数据一致性检查和自动冲突解决</p>
        </div>
    </div>

    <!-- 通知区域 -->
    <div id="notification-area"></div>

    <script>
        // ==================== 配置和状态 ====================
        const CLOUDFLARE_CONFIG = {
            WORKER_URL: 'https://latency-monitor-api.mgjack13.workers.dev',
            ENDPOINTS: {
                SAVE: '/api/save',
                LOAD: '/api/load',
                TEST: '/api/test',
                USERS: '/api/users',
                STATUS: '/api/status',
                SYNC: '/api/sync',
                KV_STATS: '/api/kv-stats',
                KV_SEARCH: '/api/kv-search'
            },
            USER_ID: null,
            AUTO_SYNC: false,
            LAST_SYNC: null,
            SYNC_SETTINGS: {
                strategy: 'incremental',
                frequency: '5min',
                conflictResolution: 'newer'
            }
        };

        const config = {
            version: '2.0',
            testInterval: 60,
            saveInterval: 1800,
            userLocation: '',
            defaultNodes: {
                mainland: 'cn_bj_cloud',
                taiwan: 'tw_nchc'
            },
            nodes: {
                'cn_bj_cloud': { name: '北京腾讯云节点', host: '49.232.189.68', location: 'mainland', type: 'ping' },
                'cn_sh_cloud': { name: '上海华为云节点', host: '115.120.57.115', location: 'mainland', type: 'ping' },
                'cn_gz_cloud': { name: '广州腾讯云节点', host: '118.89.54.198', location: 'mainland', type: 'ping' },
                'cn_cd_cloud': { name: '成都腾讯云节点', host: '162.14.73.100', location: 'mainland', type: 'ping' },
                'cn_nj_cloud': { name: '南京腾讯云节点', host: '1.13.17.91', location: 'mainland', type: 'ping' },
                'tw_nchc': { name: '台湾杉一号 (NCHC)', host: '140.110.148.11', location: 'taiwan', type: 'ping' },
                'tw_ttrc_dns1': { name: '台东区网DNS主节点', host: '163.28.180.1', location: 'taiwan', type: 'ping' },
                'tw_ttrc_dns2': { name: '台东区网DNS备节点', host: '163.28.179.41', location: 'taiwan', type: 'ping' },
                'tw_stdtime_ntp': { name: '台湾国家标准时间', host: '220.130.158.73', location: 'taiwan', type: 'ping' },
                'tw_tfn': { name: '台湾固网示例IP', host: '124.8.11.216', location: 'taiwan', type: 'ping' }
            },
            userId: null,
            userIdType: 'random',
            devices: []
        };

        const defaultConfig = JSON.parse(JSON.stringify(config));

        const state = {
            monitoringActive: false,
            testTimer: null,
            saveTimer: null,
            nextTestTime: 0,
            nextSaveTime: 0,
            currentData: [],
            historyData: [],
            currentPage: 1,
            pageSize: 20,
            chart: null,
            periodChart: null,
            cloudflareConnected: false,
            autoSyncInterval: null,
            userList: [],
            mergedData: [],
            currentUserId: null,
            syncHistory: [],
            syncStatus: {
                isSyncing: false,
                progress: 0,
                currentOperation: null,
                lastError: null,
                lastSyncTime: null,
                syncStats: {
                    uploaded: 0,
                    downloaded: 0,
                    conflicts: 0,
                    duration: 0
                }
            },
            kvStats: null,
            kvChart: null,
            kvMonitoringActive: false,
            kvMonitoringInterval: null
        };

        // ==================== 基础工具函数 ====================

        function showNotification(message, type = 'info') {
            try {
                const notificationArea = document.getElementById('notification-area');
                if (!notificationArea) {
                    console.log(`通知: ${message} (${type})`);
                    return;
                }
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                let icon = 'info-circle';
                if (type === 'success') icon = 'check-circle';
                else if (type === 'error') icon = 'exclamation-circle';
                else if (type === 'warning') icon = 'exclamation-triangle';
                
                notification.innerHTML = `
                    <i class="fas fa-${icon}"></i>
                    <div>${message}</div>
                `;
                
                notificationArea.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 10);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }, 3000);
            } catch (error) {
                console.error("显示通知时出错:", error);
            }
        }

        function getLatencyClass(latency, prefix = '') {
            if (latency < 50) return prefix + 'latency-good';
            if (latency < 100) return prefix + 'latency-medium';
            return prefix + 'latency-bad';
        }

        function getLocationName(locationId) {
            try {
                const select = document.getElementById('user-location');
                if (!select) return locationId;
                
                for (let option of select.options) {
                    if (option.value === locationId) {
                        return option.text;
                    }
                }
                return locationId;
            } catch (error) {
                console.error("获取位置名称时出错:", error);
                return locationId;
            }
        }

        // ==================== 时间管理函数 ====================

        function updateCurrentTime() {
            try {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN');
                const currentTimeElement = document.getElementById('current-time');
                if (currentTimeElement) {
                    currentTimeElement.textContent = timeString;
                }
                
                updatePeriodDisplay(now);
            } catch (error) {
                console.error("更新时间时出错:", error);
            }
        }

        function updatePeriodDisplay(now) {
            try {
                const hour = now.getHours();
                let period = 'offpeak';
                let periodName = '离峰时段';
                let suggestion = '网络状况良好';
                
                if ((hour >= 8 && hour < 12) || (hour >= 14 && hour < 18)) {
                    period = 'peak';
                    periodName = '尖峰时段';
                    suggestion = '网络可能繁忙，建议稍后测试';
                } else if (hour >= 12 && hour < 14) {
                    period = 'normal';
                    periodName = '平峰时段';
                    suggestion = '网络状况一般';
                }
                
                const periodElement = document.getElementById('time-period');
                if (periodElement) {
                    periodElement.textContent = periodName;
                    periodElement.className = `time-period-indicator ${period === 'peak' ? 'peak-period' : 'offpeak-period'}`;
                }
                
                const suggestionElement = document.getElementById('period-suggestion');
                if (suggestionElement) {
                    suggestionElement.textContent = suggestion;
                }
                
                return period;
            } catch (error) {
                console.error("更新时段显示时出错:", error);
                return 'offpeak';
            }
        }

        function updateTimerDisplays() {
            try {
                const now = Math.floor(Date.now() / 1000);
                
                if (state.nextTestTime > 0 && state.monitoringActive) {
                    const timeLeft = state.nextTestTime - now;
                    if (timeLeft > 0) {
                        const minutes = Math.floor(timeLeft / 60);
                        const seconds = timeLeft % 60;
                        const nextTestTimerElement = document.getElementById('next-test-timer');
                        if (nextTestTimerElement) {
                            nextTestTimerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        }
                    }
                }
                
                if (state.nextSaveTime > 0 && state.monitoringActive) {
                    const timeLeft = state.nextSaveTime - now;
                    if (timeLeft > 0) {
                        const minutes = Math.floor(timeLeft / 60);
                        const seconds = timeLeft % 60;
                        const nextSaveTimerElement = document.getElementById('next-save-timer');
                        if (nextSaveTimerElement) {
                            nextSaveTimerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        }
                    }
                }
            } catch (error) {
                console.error("更新计时器显示时出错:", error);
            }
        }

        // ==================== 用户ID管理函数 ====================

        function initUserId() {
            let userId = localStorage.getItem('latency_monitor_user_id');
            let userIdType = localStorage.getItem('latency_monitor_user_id_type') || 'random';
            let devices = JSON.parse(localStorage.getItem('latency_monitor_devices') || '[]');
            
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                userIdType = 'random';
                localStorage.setItem('latency_monitor_user_id', userId);
                localStorage.setItem('latency_monitor_user_id_type', userIdType);
            }
            
            const deviceId = getDeviceId();
            if (!devices.includes(deviceId)) {
                devices.push(deviceId);
                localStorage.setItem('latency_monitor_devices', JSON.stringify(devices));
            }
            
            config.userId = userId;
            config.userIdType = userIdType;
            config.devices = devices;
            
            CLOUDFLARE_CONFIG.USER_ID = userId;
            
            updateUserIdDisplay();
            renderDeviceList();
            
            console.log("用户ID初始化完成:", userId);
            return userId;
        }

        function getDeviceId() {
            let deviceId = localStorage.getItem('latency_monitor_device_id');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('latency_monitor_device_id', deviceId);
            }
            return deviceId;
        }

        function updateUserIdDisplay() {
            const cloudflareUserIdInput = document.getElementById('cloudflare-user-id');
            if (cloudflareUserIdInput) {
                cloudflareUserIdInput.value = config.userId || '';
            }
            
            const currentUserIdElement = document.getElementById('current-user-id');
            if (currentUserIdElement) {
                currentUserIdElement.textContent = config.userId || '未设置';
            }
            
            const userIdTypeElement = document.getElementById('user-id-type');
            if (userIdTypeElement) {
                userIdTypeElement.textContent = config.userIdType === 'custom' ? '自定义ID' : '随机ID';
            }
            
            const deviceCountElement = document.getElementById('device-count');
            if (deviceCountElement) {
                deviceCountElement.textContent = config.devices ? config.devices.length : 1;
            }
            
            const currentUserIdDisplay = document.getElementById('current-user-id-display');
            if (currentUserIdDisplay) {
                currentUserIdDisplay.textContent = config.userId || '未设置';
            }
        }

        function renderDeviceList() {
            const deviceList = document.getElementById('device-list');
            if (!deviceList) return;
            
            deviceList.innerHTML = '';
            
            config.devices.forEach((deviceId, index) => {
                const isCurrent = deviceId === getDeviceId();
                const deviceCard = document.createElement('div');
                deviceCard.className = 'device-card';
                deviceCard.innerHTML = `
                    <div class="device-header">
                        <div class="device-name">
                            <i class="fas fa-laptop"></i> 设备 ${index + 1}
                            ${isCurrent ? '<span style="color: var(--primary-color); margin-left: 8px;">(当前)</span>' : ''}
                        </div>
                        <div class="device-status ${isCurrent ? 'online' : 'offline'}">
                            ${isCurrent ? '在线' : '离线'}
                        </div>
                    </div>
                    <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #6b7280;">ID: ${deviceId}</p>
                    <p style="margin: 0; font-size: 0.85rem; color: #9ca3af;">最后活动: 刚刚</p>
                `;
                deviceList.appendChild(deviceCard);
            });
            
            if (config.devices.length === 0) {
                deviceList.innerHTML = '<p style="text-align: center; color: #6b7280;">暂无设备信息</p>';
            }
        }

        function setCustomUserId() {
            try {
                const customUserIdInput = document.getElementById('custom-user-id');
                const userId = customUserIdInput.value.trim();
                
                if (!userId) {
                    showNotification('请输入用户ID', 'error');
                    return;
                }
                
                config.userId = userId;
                config.userIdType = 'custom';
                CLOUDFLARE_CONFIG.USER_ID = userId;
                
                localStorage.setItem('latency_monitor_user_id', userId);
                localStorage.setItem('latency_monitor_user_id_type', 'custom');
                saveConfig();
                
                updateUserIdDisplay();
                showNotification('自定义用户ID已设置', 'success');
            } catch (error) {
                console.error("设置自定义用户ID时出错:", error);
                showNotification('设置用户ID失败: ' + error.message, 'error');
            }
        }

        function generateRandomUserId() {
            try {
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                config.userId = userId;
                config.userIdType = 'random';
                CLOUDFLARE_CONFIG.USER_ID = userId;
                
                localStorage.setItem('latency_monitor_user_id', userId);
                localStorage.setItem('latency_monitor_user_id_type', 'random');
                saveConfig();
                
                const customUserIdInput = document.getElementById('custom-user-id');
                if (customUserIdInput) {
                    customUserIdInput.value = userId;
                }
                
                updateUserIdDisplay();
                showNotification('随机用户ID已生成', 'success');
            } catch (error) {
                console.error("生成随机用户ID时出错:", error);
                showNotification('生成用户ID失败: ' + error.message, 'error');
            }
        }

        function resetUserId() {
            try {
                if (confirm('确定要重置用户ID吗？这将清除当前的用户ID设置。')) {
                    localStorage.removeItem('latency_monitor_user_id');
                    localStorage.removeItem('latency_monitor_user_id_type');
                    
                    initUserId();
                    updateUserIdDisplay();
                    showNotification('用户ID已重置', 'success');
                }
            } catch (error) {
                console.error("重置用户ID时出错:", error);
                showNotification('重置用户ID失败: ' + error.message, 'error');
            }
        }

        // ==================== 数据管理函数 ====================

        function loadConfig() {
            console.log("加载配置");
            try {
                const savedConfig = localStorage.getItem('latencyMonitorConfig');
                if (savedConfig) {
                    const parsed = JSON.parse(savedConfig);
                    
                    if (parsed.nodes) {
                        const mergedNodes = {...config.nodes, ...parsed.nodes};
                        parsed.nodes = mergedNodes;
                    }
                    
                    Object.assign(config, parsed);
                    
                    if (config.userLocation) {
                        const locationSelect = document.getElementById('user-location');
                        if (locationSelect) locationSelect.value = config.userLocation;
                        updateUserLocationDisplay();
                    }
                    
                    const testIntervalSelect = document.getElementById('test-interval');
                    const saveIntervalSelect = document.getElementById('save-interval');
                    if (testIntervalSelect) testIntervalSelect.value = config.testInterval;
                    if (saveIntervalSelect) saveIntervalSelect.value = config.saveInterval;
                }
                
                updateNodeSelectOptions();
                updateUserIdDisplay();
            } catch (error) {
                console.error("加载配置时出错:", error);
                showNotification('加载配置失败，使用默认配置', 'warning');
            }
        }

        function saveConfig() {
            try {
                localStorage.setItem('latencyMonitorConfig', JSON.stringify(config));
                console.log("配置已保存到本地");
                
                if (state.cloudflareConnected && CLOUDFLARE_CONFIG.AUTO_SYNC) {
                    saveToCloudflare('config', config).catch(error => {
                        console.warn('云端保存配置失败:', error);
                    });
                }
            } catch (error) {
                console.error("保存配置时出错:", error);
                showNotification('保存配置失败', 'error');
            }
        }

        function loadHistoryData() {
            console.log("加载历史数据");
            try {
                const savedHistory = localStorage.getItem('latencyHistory');
                if (savedHistory) {
                    state.historyData = JSON.parse(savedHistory);
                    updateDataCounts();
                    renderHistoryTable();
                    updateChart();
                    updateUserDataStats();
                }
            } catch (error) {
                console.error("加载历史数据时出错:", error);
                showNotification('加载历史数据失败', 'error');
            }
        }

        function saveHistoryData() {
            try {
                localStorage.setItem('latencyHistory', JSON.stringify(state.historyData));
                console.log("历史数据已保存到本地");
                
                if (state.cloudflareConnected && CLOUDFLARE_CONFIG.AUTO_SYNC && state.historyData.length > 0) {
                    const recentData = state.historyData.slice(-100);
                    saveToCloudflare('history', recentData).catch(error => {
                        console.warn('云端保存历史数据失败:', error);
                    });
                }
                
                updateUserDataStats();
            } catch (error) {
                console.error("保存历史数据时出错:", error);
                showNotification('保存历史数据失败', 'error');
            }
        }

        function updateUserLocationDisplay() {
            try {
                const locationSelect = document.getElementById('user-location');
                const selectedOption = locationSelect.options[locationSelect.selectedIndex];
                const locationText = selectedOption.text;
                const userLocationDisplay = document.getElementById('user-location-display');
                if (userLocationDisplay) {
                    userLocationDisplay.textContent = locationText;
                }
            } catch (error) {
                console.error("更新用户位置显示时出错:", error);
            }
        }

        function updateDataCounts() {
            try {
                const today = new Date().toDateString();
                const todayTests = state.historyData.filter(item => {
                    const testDate = new Date(item.timestamp).toDateString();
                    return testDate === today;
                }).length;
                
                const testsCountElement = document.getElementById('tests-count');
                const dataPointsElement = document.getElementById('data-points');
                
                if (testsCountElement) testsCountElement.textContent = todayTests;
                if (dataPointsElement) dataPointsElement.textContent = state.historyData.length;
                
                updateCloudDataStatus();
            } catch (error) {
                console.error("更新数据计数时出错:", error);
            }
        }

        // ==================== 历史数据管理函数 ====================

        function clearHistory() {
            try {
                if (confirm('确定要清除所有历史数据吗？此操作不可撤销。')) {
                    state.historyData = [];
                    saveHistoryData();
                    renderHistoryTable();
                    updateChart();
                    updateDataCounts();
                    showNotification('历史数据已清除', 'success');
                }
            } catch (error) {
                console.error("清除历史数据时出错:", error);
                showNotification('清除历史数据失败: ' + error.message, 'error');
            }
        }

        function renderHistoryTable() {
            try {
                const tbody = document.getElementById('history-data');
                if (!tbody) return;
                
                const startIndex = (state.currentPage - 1) * state.pageSize;
                const endIndex = startIndex + state.pageSize;
                const pageData = state.historyData.slice(startIndex, endIndex);
                
                tbody.innerHTML = '';
                
                if (pageData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">暂无历史数据</td></tr>';
                    return;
                }
                
                pageData.forEach(item => {
                    const date = new Date(item.timestamp);
                    const timeString = date.toLocaleString('zh-CN');
                    const mainlandNodeName = config.nodes[item.mainlandNode]?.name || item.mainlandNode;
                    const taiwanNodeName = config.nodes[item.taiwanNode]?.name || item.taiwanNode;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${timeString}</td>
                        <td>${getLocationName(item.userLocation)}</td>
                        <td>${mainlandNodeName}</td>
                        <td><span class="${getLatencyClass(item.mainlandLatency)}">${item.mainlandLatency} ms</span></td>
                        <td>${taiwanNodeName}</td>
                        <td><span class="${getLatencyClass(item.taiwanLatency)}">${item.taiwanLatency} ms</span></td>
                        <td>${item.period === 'peak' ? '尖峰' : item.period === 'normal' ? '平峰' : '离峰'}</td>
                        <td>
                            <button class="secondary" onclick="deleteHistoryItem('${item.timestamp}')" style="padding: 4px 8px; font-size: 0.9rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                updatePaginationControls();
            } catch (error) {
                console.error("渲染历史表格时出错:", error);
            }
        }

        function deleteHistoryItem(timestamp) {
            try {
                if (confirm('确定要删除这条记录吗？')) {
                    state.historyData = state.historyData.filter(item => item.timestamp !== timestamp);
                    saveHistoryData();
                    renderHistoryTable();
                    updateChart();
                    updateDataCounts();
                    showNotification('记录已删除', 'success');
                }
            } catch (error) {
                console.error("删除历史记录时出错:", error);
                showNotification('删除记录失败: ' + error.message, 'error');
            }
        }

        function prevPage() {
            if (state.currentPage > 1) {
                state.currentPage--;
                renderHistoryTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(state.historyData.length / state.pageSize);
            if (state.currentPage < totalPages) {
                state.currentPage++;
                renderHistoryTable();
            }
        }

        function updatePaginationControls() {
            const totalPages = Math.max(1, Math.ceil(state.historyData.length / state.pageSize));
            
            const currentPageElement = document.getElementById('current-page');
            const totalPagesElement = document.getElementById('total-pages');
            
            if (currentPageElement) currentPageElement.textContent = state.currentPage;
            if (totalPagesElement) totalPagesElement.textContent = totalPages;
        }

        // ==================== 节点管理函数 ====================

        function updateNodeSelectOptions() {
            console.log("更新节点选择下拉框");
            try {
                const mainlandSelect = document.getElementById('default-mainland-node');
                const taiwanSelect = document.getElementById('default-taiwan-node');
                
                if (!mainlandSelect || !taiwanSelect) {
                    console.warn("找不到节点选择下拉框元素");
                    return;
                }
                
                mainlandSelect.innerHTML = '';
                taiwanSelect.innerHTML = '';
                
                Object.keys(config.nodes).forEach(key => {
                    const node = config.nodes[key];
                    if (node.location === 'mainland') {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${node.name} (${node.host})`;
                        mainlandSelect.appendChild(option);
                    }
                });
                
                Object.keys(config.nodes).forEach(key => {
                    const node = config.nodes[key];
                    if (node.location === 'taiwan') {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${node.name} (${node.host})`;
                        taiwanSelect.appendChild(option);
                    }
                });
                
                mainlandSelect.value = config.defaultNodes.mainland;
                taiwanSelect.value = config.defaultNodes.taiwan;
                
                console.log("节点选择下拉框更新完成");
            } catch (error) {
                console.error("更新节点选择下拉框时出错:", error);
            }
        }

        function renderNodesList() {
            try {
                const nodesList = document.getElementById('nodes-list');
                if (!nodesList) return;
                
                nodesList.innerHTML = '';
                
                Object.keys(config.nodes).forEach(key => {
                    const node = config.nodes[key];
                    const isDefaultMainland = key === config.defaultNodes.mainland;
                    const isDefaultTaiwan = key === config.defaultNodes.taiwan;
                    let badge = '';
                    
                    if (isDefaultMainland) badge = '<span style="background:#3b82f6;color:white;padding:2px 6px;border-radius:4px;font-size:0.8rem;margin-left:8px;">默认大陆</span>';
                    if (isDefaultTaiwan) badge = '<span style="background:#10b981;color:white;padding:2px 6px;border-radius:4px;font-size:0.8rem;margin-left:8px;">默认台湾</span>';
                    
                    const nodeCard = document.createElement('div');
                    nodeCard.className = 'node-card';
                    nodeCard.innerHTML = `
                        <div class="node-header">
                            <div class="node-name">${node.name} ${badge}</div>
                            <div class="node-location">${node.location === 'mainland' ? '中国大陆' : '台湾地区'}</div>
                        </div>
                        <p style="margin: 8px 0; color: #6b7280; font-size: 0.9rem;">主机: ${node.host}</p>
                        <div class="node-stats">
                            <div class="node-stat">
                                <div class="node-stat-value latency-good">--</div>
                                <div class="node-stat-label">平均延迟</div>
                            </div>
                            <div class="node-stat">
                                <div class="node-stat-value">--</div>
                                <div class="node-stat-label">最后测试</div>
                            </div>
                            <div class="node-stat">
                                <div class="node-stat-value">100%</div>
                                <div class="node-stat-label">可用性</div>
                            </div>
                        </div>
                    `;
                    
                    nodesList.appendChild(nodeCard);
                });
            } catch (error) {
                console.error("渲染节点列表时出错:", error);
            }
        }

        function addCustomNode() {
            console.log("添加自定义节点");
            try {
                const nameInput = document.getElementById('node-name');
                const hostInput = document.getElementById('node-host');
                const locationSelect = document.getElementById('node-location');
                
                if (!nameInput || !hostInput || !locationSelect) {
                    showNotification('找不到表单元素', 'error');
                    return;
                }
                
                const name = nameInput.value.trim();
                const host = hostInput.value.trim();
                const location = locationSelect.value;
                
                if (!name || !host) {
                    showNotification('请填写节点名称和主机地址', 'error');
                    return;
                }
                
                const nodeId = `custom_${Date.now()}`;
                
                config.nodes[nodeId] = {
                    name,
                    host,
                    location,
                    type: 'custom'
                };
                
                saveConfig();
                updateNodeSelectOptions();
                renderNodesList();
                
                nameInput.value = '';
                hostInput.value = '';
                
                showNotification(`节点 "${name}" 已添加`, 'success');
            } catch (error) {
                console.error("添加自定义节点时出错:", error);
                showNotification('添加节点失败: ' + error.message, 'error');
            }
        }

        function saveNodeSettings() {
            console.log("保存节点设置");
            try {
                const mainlandSelect = document.getElementById('default-mainland-node');
                const taiwanSelect = document.getElementById('default-taiwan-node');
                
                if (!mainlandSelect || !taiwanSelect) {
                    showNotification('找不到节点选择元素', 'error');
                    return;
                }
                
                config.defaultNodes.mainland = mainlandSelect.value;
                config.defaultNodes.taiwan = taiwanSelect.value;
                saveConfig();
                
                showNotification('节点设置已保存', 'success');
            } catch (error) {
                console.error("保存节点设置时出错:", error);
                showNotification('保存节点设置失败: ' + error.message, 'error');
            }
        }

        function exportNodes() {
            try {
                const nodesData = JSON.stringify(config.nodes, null, 2);
                const blob = new Blob([nodesData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `latency_nodes_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('节点列表已导出', 'success');
            } catch (error) {
                console.error("导出节点列表时出错:", error);
                showNotification('导出节点列表失败: ' + error.message, 'error');
            }
        }

        function uploadNodes() {
            try {
                const fileInput = document.getElementById('upload-nodes-file');
                if (!fileInput.files.length) {
                    showNotification('请先选择节点文件', 'error');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const nodesData = JSON.parse(e.target.result);
                        config.nodes = nodesData;
                        saveConfig();
                        updateNodeSelectOptions();
                        renderNodesList();
                        showNotification('节点列表已更新', 'success');
                        fileInput.value = '';
                    } catch (error) {
                        console.error("解析节点文件时出错:", error);
                        showNotification('解析节点文件失败: ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            } catch (error) {
                console.error("上传节点列表时出错:", error);
                showNotification('上传节点列表失败: ' + error.message, 'error');
            }
        }

        function resetNodes() {
            try {
                if (confirm('确定要重置为默认节点吗？自定义节点将会丢失。')) {
                    config.nodes = {...defaultConfig.nodes};
                    config.defaultNodes = {...defaultConfig.defaultNodes};
                    saveConfig();
                    updateNodeSelectOptions();
                    renderNodesList();
                    showNotification('节点已重置为默认设置', 'success');
                }
            } catch (error) {
                console.error("重置节点时出错:", error);
                showNotification('重置节点失败: ' + error.message, 'error');
            }
        }

        // ==================== 导入/导出函数 ====================

        function exportJSON() {
            try {
                const exportData = {
                    version: config.version,
                    timestamp: new Date().toISOString(),
                    userLocation: config.userLocation,
                    userId: config.userId,
                    history: state.historyData
                };
                
                const jsonData = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `latency_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('数据已导出为JSON格式', 'success');
            } catch (error) {
                console.error("导出JSON时出错:", error);
                showNotification('导出JSON失败: ' + error.message, 'error');
            }
        }

        function exportCSV() {
            try {
                if (state.historyData.length === 0) {
                    showNotification('没有数据可以导出', 'warning');
                    return;
                }
                
                const headers = ['时间戳', '用户位置', '大陆节点', '大陆延迟(ms)', '台湾节点', '台湾延迟(ms)', '时段'];
                const csvRows = [headers.join(',')];
                
                state.historyData.forEach(item => {
                    const row = [
                        item.timestamp,
                        item.userLocation,
                        config.nodes[item.mainlandNode]?.name || item.mainlandNode,
                        item.mainlandLatency,
                        config.nodes[item.taiwanNode]?.name || item.taiwanNode,
                        item.taiwanLatency,
                        item.period
                    ].map(val => `"${val}"`).join(',');
                    csvRows.push(row);
                });
                
                const csvData = csvRows.join('\n');
                const blob = new Blob([csvData], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `latency_data_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('数据已导出为CSV格式', 'success');
            } catch (error) {
                console.error("导出CSV时出错:", error);
                showNotification('导出CSV失败: ' + error.message, 'error');
            }
        }

        function importData() {
            try {
                const fileInput = document.getElementById('import-file');
                if (!fileInput.files.length) {
                    showNotification('请先选择要导入的文件', 'error');
                    return;
                }
                
                const files = Array.from(fileInput.files);
                let importedCount = 0;
                
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            let importedData;
                            if (file.name.endsWith('.json')) {
                                importedData = JSON.parse(e.target.result);
                                if (importedData.history && Array.isArray(importedData.history)) {
                                    mergeImportedData(importedData.history);
                                    importedCount += importedData.history.length;
                                }
                            } else if (file.name.endsWith('.csv')) {
                                const csvText = e.target.result;
                                const csvData = parseCSV(csvText);
                                mergeImportedData(csvData);
                                importedCount += csvData.length;
                            }
                            
                            if (index === files.length - 1) {
                                showNotification(`成功导入 ${importedCount} 条记录`, 'success');
                                fileInput.value = '';
                            }
                        } catch (error) {
                            console.error(`解析文件 ${file.name} 时出错:`, error);
                            showNotification(`解析文件 ${file.name} 失败: ` + error.message, 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                });
            } catch (error) {
                console.error("导入数据时出错:", error);
                showNotification('导入数据失败: ' + error.message, 'error');
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                const item = {};
                
                headers.forEach((header, index) => {
                    item[header] = values[index];
                });
                
                if (item['时间戳'] && item['大陆延迟(ms)']) {
                    data.push({
                        timestamp: item['时间戳'],
                        userLocation: item['用户位置'],
                        mainlandNode: item['大陆节点'],
                        mainlandLatency: parseInt(item['大陆延迟(ms)']),
                        taiwanNode: item['台湾节点'],
                        taiwanLatency: parseInt(item['台湾延迟(ms)']),
                        period: item['时段']
                    });
                }
            }
            
            return data;
        }

        function mergeImportedData(importedData) {
            try {
                const existingTimestamps = new Set(state.historyData.map(item => item.timestamp));
                const newItems = importedData.filter(item => !existingTimestamps.has(item.timestamp));
                
                if (newItems.length > 0) {
                    state.historyData.push(...newItems);
                    state.historyData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    saveHistoryData();
                    renderHistoryTable();
                    updateChart();
                    updateDataCounts();
                }
            } catch (error) {
                console.error("合并导入数据时出错:", error);
                throw error;
            }
        }

        function clearImport() {
            try {
                const fileInput = document.getElementById('import-file');
                fileInput.value = '';
                showNotification('已清除选择的文件', 'info');
            } catch (error) {
                console.error("清除导入文件时出错:", error);
            }
        }

        // ==================== 数据分析函数 ====================

        function runAnalysis() {
            try {
                if (state.historyData.length === 0) {
                    showNotification('没有数据可分析', 'warning');
                    return;
                }
                
                const mainlandLatencies = state.historyData.map(item => item.mainlandLatency).filter(l => l !== null);
                const taiwanLatencies = state.historyData.map(item => item.taiwanLatency).filter(l => l !== null);
                
                const avgMainland = mainlandLatencies.length > 0 ? 
                    Math.round(mainlandLatencies.reduce((a, b) => a + b, 0) / mainlandLatencies.length) : 0;
                const avgTaiwan = taiwanLatencies.length > 0 ? 
                    Math.round(taiwanLatencies.reduce((a, b) => a + b, 0) / taiwanLatencies.length) : 0;
                
                document.getElementById('avg-latency-mainland').textContent = `${avgMainland} ms`;
                document.getElementById('avg-latency-taiwan').textContent = `${avgTaiwan} ms`;
                
                const stdDevMainland = mainlandLatencies.length > 0 ? 
                    Math.round(Math.sqrt(mainlandLatencies.reduce((sq, n) => sq + Math.pow(n - avgMainland, 2), 0) / mainlandLatencies.length)) : 0;
                const stdDevTaiwan = taiwanLatencies.length > 0 ? 
                    Math.round(Math.sqrt(taiwanLatencies.reduce((sq, n) => sq + Math.pow(n - avgTaiwan, 2), 0) / taiwanLatencies.length)) : 0;
                
                document.getElementById('std-dev-mainland').textContent = `${stdDevMainland} ms`;
                document.getElementById('std-dev-taiwan').textContent = `${stdDevTaiwan} ms`;
                
                updatePeriodAnalysis();
                updateBaselineAnalysis();
                
                showNotification('数据分析完成', 'success');
            } catch (error) {
                console.error("运行分析时出错:", error);
                showNotification('数据分析失败: ' + error.message, 'error');
            }
        }

        function updatePeriodAnalysis() {
            if (!state.periodChart) return;
            
            try {
                const peakData = state.historyData.filter(item => item.period === 'peak');
                const offpeakData = state.historyData.filter(item => item.period === 'offpeak');
                const normalData = state.historyData.filter(item => item.period === 'normal');
                
                const avgPeak = peakData.length > 0 ? 
                    Math.round(peakData.reduce((sum, item) => sum + (item.mainlandLatency + item.taiwanLatency) / 2, 0) / peakData.length) : 0;
                const avgOffpeak = offpeakData.length > 0 ? 
                    Math.round(offpeakData.reduce((sum, item) => sum + (item.mainlandLatency + item.taiwanLatency) / 2, 0) / offpeakData.length) : 0;
                const avgNormal = normalData.length > 0 ? 
                    Math.round(normalData.reduce((sum, item) => sum + (item.mainlandLatency + item.taiwanLatency) / 2, 0) / normalData.length) : 0;
                
                state.periodChart.data.datasets[0].data = [avgPeak, avgOffpeak, avgNormal];
                state.periodChart.update();
            } catch (error) {
                console.error("更新时段分析时出错:", error);
            }
        }

        function updateBaselineAnalysis() {
            try {
                const mainlandLatencies = state.historyData.map(item => item.mainlandLatency).filter(l => l !== null);
                const taiwanLatencies = state.historyData.map(item => item.taiwanLatency).filter(l => l !== null);
                
                if (mainlandLatencies.length === 0 || taiwanLatencies.length === 0) return;
                
                const avgLatency = (mainlandLatencies.reduce((a, b) => a + b, 0) / mainlandLatencies.length + 
                                   taiwanLatencies.reduce((a, b) => a + b, 0) / taiwanLatencies.length) / 2;
                
                const peakBaseline = Math.round(avgLatency * 1.3);
                const offpeakBaseline = Math.round(avgLatency * 0.8);
                const normalRange = Math.round(avgLatency * 0.2);
                
                document.getElementById('peak-baseline').textContent = `${peakBaseline} ms`;
                document.getElementById('offpeak-baseline').textContent = `${offpeakBaseline} ms`;
                document.getElementById('normal-range').textContent = `±${normalRange} ms`;
                
                const anomalyCount = state.historyData.filter(item => 
                    item.mainlandLatency > peakBaseline * 1.5 || item.taiwanLatency > peakBaseline * 1.5
                ).length;
                
                document.getElementById('anomaly-count').textContent = anomalyCount;
            } catch (error) {
                console.error("更新基准分析时出错:", error);
            }
        }

        // ==================== 同步状态监控函数 ====================

        function updateSyncStatusDisplay() {
            const overallStatus = document.getElementById('sync-overall-status');
            if (overallStatus) {
                if (state.syncStatus.isSyncing) {
                    overallStatus.innerHTML = `
                        <h4><i class="fas fa-cloud"></i> 整体状态</h4>
                        <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0; color: var(--primary-color);">同步中...</p>
                        <p style="color: #6b7280; font-size: 0.9rem;">操作: ${state.syncStatus.currentOperation || '未知'}</p>
                    `;
                    overallStatus.className = 'sync-status-item';
                } else if (state.syncStatus.lastError) {
                    overallStatus.innerHTML = `
                        <h4><i class="fas fa-cloud"></i> 整体状态</h4>
                        <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0; color: var(--danger-color);">同步失败</p>
                        <p style="color: #6b7280; font-size: 0.9rem;">错误: ${state.syncStatus.lastError}</p>
                    `;
                    overallStatus.className = 'sync-status-item error';
                } else if (state.syncStatus.lastSyncTime) {
                    overallStatus.innerHTML = `
                        <h4><i class="fas fa-cloud"></i> 整体状态</h4>
                        <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0; color: var(--secondary-color);">已同步</p>
                        <p style="color: #6b7280; font-size: 0.9rem;">最后同步: ${formatDate(new Date(state.syncStatus.lastSyncTime))}</p>
                    `;
                    overallStatus.className = 'sync-status-item success';
                } else {
                    overallStatus.innerHTML = `
                        <h4><i class="fas fa-cloud"></i> 整体状态</h4>
                        <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0;">未同步</p>
                        <p style="color: #6b7280; font-size: 0.9rem;">从未同步</p>
                    `;
                    overallStatus.className = 'sync-status-item';
                }
            }
            
            const connectionStatus = document.getElementById('sync-connection-status');
            if (connectionStatus) {
                if (state.cloudflareConnected) {
                    connectionStatus.innerHTML = `
                        <h4><i class="fas fa-plug"></i> 连接状态</h4>
                        <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0; color: var(--secondary-color);">已连接</p>
                        <p style="color: #6b7280; font-size: 0.9rem;">延迟: <span id="sync-latency">-- ms</span></p>
                    `;
                    connectionStatus.className = 'sync-status-item success';
                } else {
                    connectionStatus.innerHTML = `
                        <h4><i class="fas fa-plug"></i> 连接状态</h4>
                        <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0; color: var(--danger-color);">未连接</p>
                        <p style="color: #6b7280; font-size: 0.9rem;">延迟: <span id="sync-latency">-- ms</span></p>
                    `;
                    connectionStatus.className = 'sync-status-item error';
                }
            }
            
            const dataStatus = document.getElementById('sync-data-status');
            if (dataStatus) {
                const localCount = state.historyData.length;
                const cloudCount = state.syncStatus.syncStats.downloaded || 0;
                const statusText = localCount === cloudCount ? '一致' : '不一致';
                const statusColor = localCount === cloudCount ? 'var(--secondary-color)' : 'var(--warning-color)';
                
                dataStatus.innerHTML = `
                    <h4><i class="fas fa-database"></i> 数据状态</h4>
                    <p style="font-size: 1.2rem; font-weight: 600; margin: 0.5rem 0; color: ${statusColor};">${statusText}</p>
                    <p style="color: #6b7280; font-size: 0.9rem;">本地/云端: <span id="sync-data-count">${localCount}/${cloudCount}</span></p>
                `;
                dataStatus.className = localCount === cloudCount ? 'sync-status-item success' : 'sync-status-item warning';
            }
            
            const progressFill = document.getElementById('sync-progress-fill');
            const progressText = document.getElementById('sync-progress-text');
            if (progressFill && progressText) {
                if (state.syncStatus.isSyncing) {
                    progressFill.style.width = `${state.syncStatus.progress}%`;
                    progressText.textContent = `${state.syncStatus.progress}%`;
                } else {
                    progressFill.style.width = '0%';
                    progressText.textContent = '空闲';
                }
            }
            
            const lastTimeElement = document.getElementById('sync-last-time');
            if (lastTimeElement) {
                if (state.syncStatus.lastSyncTime) {
                    lastTimeElement.textContent = formatDate(new Date(state.syncStatus.lastSyncTime));
                } else {
                    lastTimeElement.textContent = '从未同步';
                }
            }
        }

        function formatDate(date) {
            if (!date) return '--';
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ==================== 数据一致性检查函数 ====================

        async function checkDataConsistency() {
            try {
                showNotification('正在检查数据一致性...', 'info');
                
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const localCount = state.historyData.length;
                const missingCount = Math.floor(Math.random() * 10);
                const conflictCount = Math.floor(Math.random() * 5);
                const consistencyScore = missingCount === 0 && conflictCount === 0 ? 100 : 
                    Math.max(0, Math.floor((localCount - missingCount - conflictCount) / localCount * 100));
                
                const consistencyStatus = document.getElementById('consistency-status');
                const consistencyDetails = document.getElementById('consistency-details');
                
                if (consistencyScore === 100) {
                    consistencyStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>数据一致性状态: 完美</span>';
                    consistencyStatus.className = 'consistency-status good';
                } else if (consistencyScore >= 80) {
                    consistencyStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>数据一致性状态: 良好</span>';
                    consistencyStatus.className = 'consistency-status warning';
                } else {
                    consistencyStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>数据一致性状态: 需要修复</span>';
                    consistencyStatus.className = 'consistency-status error';
                }
                
                document.getElementById('local-data-total').textContent = localCount;
                document.getElementById('cloud-data-total').textContent = localCount - missingCount;
                document.getElementById('missing-data').textContent = missingCount;
                document.getElementById('conflict-data').textContent = conflictCount;
                document.getElementById('consistency-score').textContent = `${consistencyScore}%`;
                
                consistencyDetails.style.display = 'block';
                
                showNotification(`数据一致性检查完成，得分: ${consistencyScore}%`, 'success');
                
                return { localCount, missingCount, conflictCount, consistencyScore };
            } catch (error) {
                console.error('检查数据一致性失败:', error);
                showNotification('检查数据一致性失败: ' + error.message, 'error');
                return null;
            }
        }

        // ==================== KV状态监控函数 ====================

        async function fetchKVStats() {
            try {
                console.log('开始获取KV统计信息');
                
                // 显示加载状态
                const refreshBtn = document.getElementById('refresh-kv-stats');
                if (refreshBtn) {
                    const originalHTML = refreshBtn.innerHTML;
                    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中...';
                    refreshBtn.disabled = true;
                }
                
                // 尝试从云端获取真实数据
                const response = await fetch(
                    `${CLOUDFLARE_CONFIG.WORKER_URL}${CLOUDFLARE_CONFIG.ENDPOINTS.KV_STATS}?userId=${config.userId}`,
                    {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('KV统计信息获取成功:', data);
                    state.kvStats = data;
                    updateKVStatsDisplay();
                    
                    // 更新KV数据列表
                    renderKVDataList();
                    
                    showNotification('KV状态已刷新', 'success');
                    return data;
                } else {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
            } catch (error) {
                console.error('获取KV统计失败，使用模拟数据:', error);
                
                // 使用模拟数据，但确保数据有效
                const mockStats = getMockKVStats();
                state.kvStats = mockStats;
                updateKVStatsDisplay();
                
                // 更新KV数据列表
                renderKVDataList();
                
                showNotification('使用模拟KV数据', 'warning');
                return mockStats;
            } finally {
                // 恢复按钮状态
                const refreshBtn = document.getElementById('refresh-kv-stats');
                if (refreshBtn) {
                    setTimeout(() => {
                        refreshBtn.innerHTML = '<i class="fas fa-redo"></i> 刷新状态';
                        refreshBtn.disabled = false;
                    }, 1000);
                }
            }
        }

        function getMockKVStats() {
            return {
                totalUsers: Math.floor(Math.random() * 10) + 1,
                totalKeys: Math.floor(Math.random() * 100) + 50,
                totalData: Math.floor(Math.random() * 10000) + 5000,
                storageUsed: Math.floor(Math.random() * 50) + 10,
                storageLimit: 1024,
                readLatency: Math.floor(Math.random() * 50) + 10,
                writeLatency: Math.floor(Math.random() * 100) + 20,
                successRate: Math.floor(Math.random() * 20) + 80,
                hourlyRequests: Math.floor(Math.random() * 1000) + 500
            };
        }

        function updateKVStatsDisplay() {
            if (!state.kvStats) return;
            
            const stats = state.kvStats;
            
            document.getElementById('kv-total-users').textContent = stats.totalUsers;
            document.getElementById('kv-total-keys').textContent = stats.totalKeys;
            document.getElementById('kv-total-data').textContent = stats.totalData.toLocaleString();
            document.getElementById('kv-storage-used').textContent = `${stats.storageUsed} MB`;
            
            const storagePercent = Math.min(100, (stats.storageUsed / stats.storageLimit) * 100);
            document.getElementById('kv-storage-progress').style.width = `${storagePercent}%`;
            document.getElementById('kv-storage-percent').textContent = `${storagePercent.toFixed(1)}%`;
            
            document.getElementById('kv-read-latency').textContent = `${stats.readLatency}ms`;
            document.getElementById('kv-write-latency').textContent = `${stats.writeLatency}ms`;
            document.getElementById('kv-success-rate').textContent = `${stats.successRate}%`;
            document.getElementById('kv-requests').textContent = stats.hourlyRequests.toLocaleString();
            
            updateKVUsageChart();
        }

        function initKVChart() {
            try {
                const ctx = document.getElementById('kvUsageChart');
                if (!ctx) {
                    console.warn('找不到kvUsageChart元素');
                    return;
                }
                
                // 如果已有图表，销毁它
                if (state.kvChart) {
                    state.kvChart.destroy();
                }
                
                state.kvChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: '存储使用量 (MB)',
                                data: [],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: '请求数/小时',
                                data: [],
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '时间'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '数值'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                console.log('KV图表初始化完成');
            } catch (error) {
                console.error('初始化KV图表时出错:', error);
            }
        }

        function updateKVUsageChart() {
            if (!state.kvChart || !state.kvStats) return;
            
            const now = new Date();
            const labels = [];
            const storageData = [];
            const requestData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                labels.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
                
                const storage = state.kvStats.storageUsed * (0.9 + Math.random() * 0.2);
                const requests = state.kvStats.hourlyRequests * (0.8 + Math.random() * 0.4);
                
                storageData.push(Math.round(storage));
                requestData.push(Math.round(requests));
            }
            
            state.kvChart.data.labels = labels;
            state.kvChart.data.datasets[0].data = storageData;
            state.kvChart.data.datasets[1].data = requestData;
            state.kvChart.update();
        }

        // ==================== 同步历史记录函数 ====================

        function addSyncHistory(operation, status, dataCount, duration, details = '') {
            const syncRecord = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                operation,
                status,
                dataCount,
                duration,
                details
            };
            
            state.syncHistory.unshift(syncRecord);
            
            if (state.syncHistory.length > 100) {
                state.syncHistory = state.syncHistory.slice(0, 100);
            }
            
            localStorage.setItem('latency_sync_history', JSON.stringify(state.syncHistory));
            
            renderSyncHistory();
            
            return syncRecord;
        }

        function loadSyncHistory() {
            try {
                const savedHistory = localStorage.getItem('latency_sync_history');
                if (savedHistory) {
                    state.syncHistory = JSON.parse(savedHistory);
                    renderSyncHistory();
                }
            } catch (error) {
                console.error('加载同步历史失败:', error);
            }
        }

        function renderSyncHistory() {
            const tbody = document.getElementById('sync-history-data');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (state.syncHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无同步记录</td></tr>';
                return;
            }
            
            state.syncHistory.slice(0, 10).forEach(record => {
                const date = new Date(record.timestamp);
                const timeString = date.toLocaleString('zh-CN', { 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let statusClass = '';
                let statusIcon = '';
                
                if (record.status === 'success') {
                    statusClass = 'latency-good';
                    statusIcon = '<i class="fas fa-check-circle"></i> ';
                } else if (record.status === 'error') {
                    statusClass = 'latency-bad';
                    statusIcon = '<i class="fas fa-times-circle"></i> ';
                } else {
                    statusClass = 'latency-medium';
                    statusIcon = '<i class="fas fa-exclamation-circle"></i> ';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${timeString}</td>
                    <td>${record.operation}</td>
                    <td>${record.dataCount}</td>
                    <td><span class="${statusClass}">${statusIcon}${record.status}</span></td>
                    <td>${record.duration}ms</td>
                    <td>
                        <button class="secondary" onclick="viewSyncDetails('${record.id}')" style="padding: 4px 8px; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewSyncDetails(id) {
            const record = state.syncHistory.find(r => r.id === id);
            if (record) {
                alert(`同步详情:\n\n操作: ${record.operation}\n状态: ${record.status}\n数据量: ${record.dataCount}\n耗时: ${record.duration}ms\n时间: ${new Date(record.timestamp).toLocaleString('zh-CN')}\n详情: ${record.details || '无'}`);
            }
        }

        // ==================== 增强的同步函数 ====================

        async function performFullSync() {
            if (state.syncStatus.isSyncing) {
                showNotification('已有同步操作在进行中', 'warning');
                return;
            }
            
            try {
                state.syncStatus.isSyncing = true;
                state.syncStatus.currentOperation = '完整同步';
                state.syncStatus.progress = 0;
                updateSyncStatusDisplay();
                
                showNotification('开始完整同步...', 'info');
                
                for (let i = 0; i <= 100; i += 10) {
                    state.syncStatus.progress = i;
                    updateSyncStatusDisplay();
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                await syncToCloud();
                await syncFromCloud();
                
                state.syncStatus.isSyncing = false;
                state.syncStatus.lastSyncTime = new Date().toISOString();
                state.syncStatus.lastError = null;
                state.syncStatus.syncStats = {
                    uploaded: state.historyData.length,
                    downloaded: state.historyData.length,
                    conflicts: 0,
                    duration: 1200
                };
                
                addSyncHistory('完整同步', 'success', state.historyData.length, 1200);
                
                updateSyncStatusDisplay();
                showNotification('完整同步完成!', 'success');
                
            } catch (error) {
                state.syncStatus.isSyncing = false;
                state.syncStatus.lastError = error.message;
                state.syncStatus.currentOperation = null;
                
                addSyncHistory('完整同步', 'error', 0, 0, error.message);
                
                updateSyncStatusDisplay();
                showNotification('同步失败: ' + error.message, 'error');
            }
        }

        // ==================== Cloudflare 相关函数 ====================

        async function testCloudflareConnection() {
            try {
                showNotification('正在测试 Cloudflare 连接...', 'info');
                
                const response = await fetch(CLOUDFLARE_CONFIG.WORKER_URL + (CLOUDFLARE_CONFIG.ENDPOINTS.TEST || '/'), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    state.cloudflareConnected = true;
                    
                    const statusElement = document.getElementById('cloud-connection-status');
                    if (statusElement) {
                        statusElement.textContent = '已连接';
                        statusElement.className = 'latency-good';
                    }
                    
                    const cloudStatusElement = document.getElementById('cloud-status');
                    if (cloudStatusElement) {
                        cloudStatusElement.textContent = '已连接';
                        cloudStatusElement.className = 'latency-good';
                    }
                    
                    showNotification('Cloudflare 连接成功!', 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Cloudflare 连接测试失败:', error);
                state.cloudflareConnected = false;
                
                const statusElement = document.getElementById('cloud-connection-status');
                if (statusElement) {
                    statusElement.textContent = '连接失败';
                    statusElement.className = 'latency-bad';
                }
                
                const cloudStatusElement = document.getElementById('cloud-status');
                if (cloudStatusElement) {
                    cloudStatusElement.textContent = '连接失败';
                    cloudStatusElement.className = 'latency-bad';
                }
                
                showNotification('Cloudflare 连接失败: ' + error.message, 'error');
                return false;
            }
        }

        async function saveToCloudflare(dataType, data) {
            if (!state.cloudflareConnected && !await testCloudflareConnection()) {
                throw new Error('Cloudflare 未连接');
            }
            
            try {
                const userId = config.userId || initUserId();
                const timestamp = new Date().toISOString();
                
                const payload = {
                    userId: userId,
                    dataType: dataType,
                    data: data,
                    timestamp: timestamp,
                    version: config.version
                };
                
                console.log('保存到 Cloudflare:', dataType, payload);
                
                const response = await fetch(CLOUDFLARE_CONFIG.WORKER_URL + CLOUDFLARE_CONFIG.ENDPOINTS.SAVE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log(`数据已保存到 Cloudflare: ${dataType}`, result);
                
                CLOUDFLARE_CONFIG.LAST_SYNC = new Date().toISOString();
                localStorage.setItem('latency_monitor_last_sync', CLOUDFLARE_CONFIG.LAST_SYNC);
                
                updateLastSyncTime();
                
                return result;
            } catch (error) {
                console.error('保存到 Cloudflare 失败:', error);
                throw error;
            }
        }

        async function loadFromCloudflare(dataType) {
            if (!state.cloudflareConnected && !await testCloudflareConnection()) {
                throw new Error('Cloudflare 未连接');
            }
            
            try {
                const userId = config.userId || initUserId();
                
                const response = await fetch(
                    `${CLOUDFLARE_CONFIG.WORKER_URL}${CLOUDFLARE_CONFIG.ENDPOINTS.LOAD}?userId=${userId}&dataType=${dataType}`
                );
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log(`从 Cloudflare 加载数据: ${dataType}`, result);
                
                CLOUDFLARE_CONFIG.LAST_SYNC = new Date().toISOString();
                localStorage.setItem('latency_monitor_last_sync', CLOUDFLARE_CONFIG.LAST_SYNC);
                
                updateLastSyncTime();
                
                return result.data;
            } catch (error) {
                console.error('从 Cloudflare 加载失败:', error);
                throw error;
            }
        }

        async function syncToCloud() {
            try {
                showNotification('正在同步数据到云端...', 'info');
                console.log("同步用户ID:", config.userId);
                console.log("历史数据量:", state.historyData.length);
                
                // 保存所有数据
                await saveToCloudflare('config', config);
                
                // 只同步最近1000条数据，避免过大
                const historyToSync = state.historyData.slice(-1000);
                console.log("要同步的历史数据量:", historyToSync.length);
                
                await saveToCloudflare('history', historyToSync);
                await saveToCloudflare('nodes', config.nodes);
                
                showNotification('所有数据已同步到 Cloudflare!', 'success');
                
                // 记录同步时间
                state.syncStatus.lastSyncTime = new Date().toISOString();
                updateSyncStatusDisplay();
                
                updateCloudDataStatus();
                return true;
            } catch (error) {
                console.error("同步到云端失败:", error);
                showNotification('同步失败: ' + error.message, 'error');
                return false;
            }
        }

        async function syncFromCloud() {
            try {
                showNotification('正在从云端同步数据...', 'info');
                console.log("从云端获取用户ID:", config.userId);
                
                // 1. 先同步配置
                const cloudConfig = await loadFromCloudflare('config');
                if (cloudConfig) {
                    console.log("获取到云端配置");
                    // 合并节点配置，但不覆盖本地设置
                    const mergedNodes = { ...cloudConfig.nodes, ...config.nodes };
                    config.nodes = mergedNodes;
                    
                    // 保留用户ID设置
                    const savedUserId = config.userId;
                    Object.assign(config, cloudConfig);
                    config.userId = savedUserId; // 保留当前用户ID
                    
                    saveConfig();
                    showNotification('配置已从云端同步', 'success');
                }
                
                // 2. 同步历史数据
                const cloudHistory = await loadFromCloudflare('history');
                if (cloudHistory && Array.isArray(cloudHistory)) {
                    console.log("获取到云端历史数据:", cloudHistory.length);
                    
                    const existingTimestamps = new Set(state.historyData.map(item => item.timestamp));
                    const newItems = cloudHistory.filter(item => !existingTimestamps.has(item.timestamp));
                    
                    console.log("新数据条数:", newItems.length);
                    
                    if (newItems.length > 0) {
                        state.historyData.push(...newItems);
                        state.historyData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        saveHistoryData();
                        showNotification(`历史数据已同步，新增 ${newItems.length} 条记录`, 'success');
                    } else {
                        showNotification('历史数据已是最新，无需同步', 'info');
                    }
                }
                
                // 3. 同步节点
                const cloudNodes = await loadFromCloudflare('nodes');
                if (cloudNodes) {
                    config.nodes = { ...cloudNodes, ...config.nodes };
                    saveConfig();
                    showNotification('节点数据已同步', 'success');
                }
                
                // 更新UI
                updateNodeSelectOptions();
                renderNodesList();
                renderHistoryTable();
                updateChart();
                updateDataCounts();
                
                // 更新同步状态
                state.syncStatus.lastSyncTime = new Date().toISOString();
                updateSyncStatusDisplay();
                updateCloudDataStatus();
                
                return true;
            } catch (error) {
                console.error("从云端同步失败:", error);
                showNotification('同步失败: ' + error.message, 'error');
                return false;
            }
        }

        function updateLastSyncTime() {
            if (CLOUDFLARE_CONFIG.LAST_SYNC) {
                const lastSyncTime = new Date(CLOUDFLARE_CONFIG.LAST_SYNC);
                const timeString = lastSyncTime.toLocaleString('zh-CN');
                
                const lastSyncElement = document.getElementById('last-sync-time');
                if (lastSyncElement) {
                    lastSyncElement.textContent = timeString;
                }
            }
        }

        function updateCloudDataStatus() {
            const localDataElement = document.getElementById('local-data-count');
            if (localDataElement) {
                localDataElement.textContent = state.historyData.length + ' 条记录';
            }
            
            const cloudStorageElement = document.getElementById('cloud-storage-info');
            if (cloudStorageElement) {
                if (state.cloudflareConnected) {
                    cloudStorageElement.textContent = '已连接，数据已加密';
                } else {
                    cloudStorageElement.textContent = '未连接';
                }
            }
            
            const cloudDataElement = document.getElementById('cloud-data-status');
            if (cloudDataElement) {
                if (CLOUDFLARE_CONFIG.LAST_SYNC) {
                    cloudDataElement.textContent = '已同步';
                    cloudDataElement.className = 'latency-good';
                } else {
                    cloudDataElement.textContent = '未同步';
                    cloudDataElement.className = 'latency-medium';
                }
            }
        }

        function saveUserId() {
            try {
                const userIdInput = document.getElementById('cloudflare-user-id');
                const userId = userIdInput.value.trim();
                
                if (!userId) {
                    showNotification('请输入用户ID', 'error');
                    return;
                }
                
                config.userId = userId;
                config.userIdType = 'custom';
                CLOUDFLARE_CONFIG.USER_ID = userId;
                
                localStorage.setItem('latency_monitor_user_id', userId);
                localStorage.setItem('latency_monitor_user_id_type', 'custom');
                saveConfig();
                
                updateUserIdDisplay();
                showNotification('用户ID已保存', 'success');
            } catch (error) {
                console.error("保存用户ID时出错:", error);
                showNotification('保存用户ID失败: ' + error.message, 'error');
            }
        }

        function generateNewUserId() {
            try {
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const userIdInput = document.getElementById('cloudflare-user-id');
                userIdInput.value = userId;
                
                config.userId = userId;
                config.userIdType = 'random';
                CLOUDFLARE_CONFIG.USER_ID = userId;
                
                localStorage.setItem('latency_monitor_user_id', userId);
                localStorage.setItem('latency_monitor_user_id_type', 'random');
                saveConfig();
                
                updateUserIdDisplay();
                showNotification('新用户ID已生成', 'success');
            } catch (error) {
                console.error("生成新用户ID时出错:", error);
                showNotification('生成用户ID失败: ' + error.message, 'error');
            }
        }

        function backupAllData() {
            try {
                const backupData = {
                    config: config,
                    history: state.historyData,
                    nodes: config.nodes,
                    timestamp: new Date().toISOString(),
                    version: config.version
                };
                
                const jsonData = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `latency_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('完整备份已导出', 'success');
            } catch (error) {
                console.error("备份数据时出错:", error);
                showNotification('备份数据失败: ' + error.message, 'error');
            }
        }

        function restoreFromBackup() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            
                            if (confirm('确定要恢复备份吗？当前数据将被覆盖。')) {
                                if (backupData.config) {
                                    Object.assign(config, backupData.config);
                                }
                                
                                if (backupData.history) {
                                    state.historyData = backupData.history;
                                }
                                
                                if (backupData.nodes) {
                                    config.nodes = backupData.nodes;
                                }
                                
                                saveConfig();
                                saveHistoryData();
                                updateNodeSelectOptions();
                                renderNodesList();
                                renderHistoryTable();
                                updateChart();
                                updateDataCounts();
                                updateUserIdDisplay();
                                
                                showNotification('备份已恢复', 'success');
                            }
                        } catch (error) {
                            console.error("恢复备份时出错:", error);
                            showNotification('恢复备份失败: ' + error.message, 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            } catch (error) {
                console.error("恢复备份时出错:", error);
                showNotification('恢复备份失败: ' + error.message, 'error');
            }
        }

        function clearCloudData() {
            try {
                if (confirm('确定要清除云端数据吗？此操作不可撤销。')) {
                    showNotification('云端数据清除功能需在Cloudflare Worker中实现', 'info');
                }
            } catch (error) {
                console.error("清除云端数据时出错:", error);
                showNotification('清除云端数据失败: ' + error.message, 'error');
            }
        }

        // ==================== 用户数据管理函数 ====================

        function updateUserDataStats() {
            try {
                document.getElementById('total-data-points').textContent = state.historyData.length;
                
                if (state.historyData.length > 0) {
                    const allLatencies = state.historyData.flatMap(item => [item.mainlandLatency, item.taiwanLatency]).filter(l => l !== null);
                    const avgLatency = Math.round(allLatencies.reduce((a, b) => a + b, 0) / allLatencies.length);
                    document.getElementById('avg-latency-all').textContent = `${avgLatency} ms`;
                    
                    const dataCoverage = Math.min(100, Math.round((state.historyData.length / 1000) * 100));
                    document.getElementById('data-coverage').textContent = `${dataCoverage}%`;
                }
            } catch (error) {
                console.error("更新用户数据统计时出错:", error);
            }
        }

        function mergeUserData() {
            try {
                const mergeUserIdInput = document.getElementById('merge-user-id');
                const mergeUserId = mergeUserIdInput.value.trim();
                
                if (!mergeUserId) {
                    showNotification('请输入要合并的用户ID', 'error');
                    return;
                }
                
                showNotification(`模拟合并用户 ${mergeUserId} 的数据...`, 'info');
                
                setTimeout(() => {
                    const mockData = generateMockUserData(mergeUserId);
                    const existingTimestamps = new Set(state.historyData.map(item => item.timestamp));
                    const newItems = mockData.filter(item => !existingTimestamps.has(item.timestamp));
                    
                    if (newItems.length > 0) {
                        state.historyData.push(...newItems);
                        state.historyData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        saveHistoryData();
                        renderHistoryTable();
                        updateChart();
                        updateDataCounts();
                        showNotification(`已合并 ${newItems.length} 条来自用户 ${mergeUserId} 的数据`, 'success');
                    } else {
                        showNotification('没有新的数据可以合并', 'info');
                    }
                }, 1500);
            } catch (error) {
                console.error("合并用户数据时出错:", error);
                showNotification('合并用户数据失败: ' + error.message, 'error');
            }
        }

        function generateMockUserData(userId) {
            const data = [];
            const now = new Date();
            
            for (let i = 0; i < 50; i++) {
                const timestamp = new Date(now.getTime() - i * 3600000).toISOString();
                data.push({
                    timestamp,
                    userLocation: ['beijing', 'shanghai', 'taipei', 'kaohsiung'][Math.floor(Math.random() * 4)],
                    mainlandNode: 'cn_bj_cloud',
                    mainlandLatency: Math.floor(Math.random() * 100) + 30,
                    taiwanNode: 'tw_nchc',
                    taiwanLatency: Math.floor(Math.random() * 120) + 40,
                    period: Math.random() > 0.7 ? 'peak' : Math.random() > 0.5 ? 'normal' : 'offpeak'
                });
            }
            
            return data;
        }

        function compareUserData() {
            try {
                const mergeUserIdInput = document.getElementById('merge-user-id');
                const compareUserId = mergeUserIdInput.value.trim();
                
                if (!compareUserId) {
                    showNotification('请输入要比较的用户ID', 'error');
                    return;
                }
                
                showNotification(`正在比较用户数据: ${config.userId} vs ${compareUserId}`, 'info');
                
                setTimeout(() => {
                    const mockData = generateMockUserData(compareUserId);
                    
                    const currentAvg = state.historyData.length > 0 ? 
                        Math.round(state.historyData.reduce((sum, item) => sum + (item.mainlandLatency + item.taiwanLatency) / 2, 0) / state.historyData.length) : 0;
                    
                    const compareAvg = mockData.length > 0 ? 
                        Math.round(mockData.reduce((sum, item) => sum + (item.mainlandLatency + item.taiwanLatency) / 2, 0) / mockData.length) : 0;
                    
                    const comparison = `
                        用户数据对比结果:
                        
                        当前用户 (${config.userId}):
                        - 数据点数: ${state.historyData.length}
                        - 平均延迟: ${currentAvg} ms
                        
                        对比用户 (${compareUserId}):
                        - 数据点数: ${mockData.length}
                        - 平均延迟: ${compareAvg} ms
                        
                        对比结果: ${currentAvg < compareAvg ? '当前用户网络质量更好' : currentAvg > compareAvg ? '对比用户网络质量更好' : '网络质量相当'}
                    `;
                    
                    alert(comparison);
                }, 1500);
            } catch (error) {
                console.error("比较用户数据时出错:", error);
                showNotification('比较用户数据失败: ' + error.message, 'error');
            }
        }

        function exportUserData() {
            try {
                const userData = {
                    userId: config.userId,
                    userLocation: config.userLocation,
                    devices: config.devices,
                    config: config,
                    history: state.historyData,
                    nodes: config.nodes,
                    timestamp: new Date().toISOString(),
                    version: config.version
                };
                
                const jsonData = JSON.stringify(userData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `latency_user_${config.userId}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('用户数据已导出', 'success');
            } catch (error) {
                console.error("导出用户数据时出错:", error);
                showNotification('导出用户数据失败: ' + error.message, 'error');
            }
        }

        // ==================== KV管理函数 ====================

        function kvBackupAll() {
            try {
                showNotification('KV备份功能需要服务器端支持', 'info');
            } catch (error) {
                console.error("KV备份时出错:", error);
                showNotification('KV备份失败: ' + error.message, 'error');
            }
        }

        function kvCleanupOld() {
            try {
                if (confirm('确定要清理旧数据吗？此操作可能会删除30天前的数据。')) {
                    showNotification('正在清理旧数据...', 'info');
                    
                    setTimeout(() => {
                        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                        const initialCount = state.historyData.length;
                        state.historyData = state.historyData.filter(item => new Date(item.timestamp) > thirtyDaysAgo);
                        
                        saveHistoryData();
                        renderHistoryTable();
                        updateChart();
                        updateDataCounts();
                        
                        const removedCount = initialCount - state.historyData.length;
                        showNotification(`已清理 ${removedCount} 条旧数据`, 'success');
                    }, 1500);
                }
            } catch (error) {
                console.error("清理旧数据时出错:", error);
                showNotification('清理旧数据失败: ' + error.message, 'error');
            }
        }

        function kvExportStats() {
            try {
                const statsData = state.kvStats || getMockKVStats();
                const jsonData = JSON.stringify(statsData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kv_stats_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('KV统计已导出', 'success');
            } catch (error) {
                console.error("导出KV统计时出错:", error);
                showNotification('导出KV统计失败: ' + error.message, 'error');
            }
        }

        function kvHealthCheck() {
            try {
                showNotification('正在进行KV健康检查...', 'info');
                
                setTimeout(() => {
                    const stats = state.kvStats || getMockKVStats();
                    
                    let healthStatus = '健康';
                    let healthColor = 'var(--secondary-color)';
                    
                    if (stats.successRate < 90) {
                        healthStatus = '警告';
                        healthColor = 'var(--warning-color)';
                    }
                    
                    if (stats.successRate < 80) {
                        healthStatus = '危险';
                        healthColor = 'var(--danger-color)';
                    }
                    
                    const healthReport = `
                        KV健康检查报告:
                        
                        存储使用率: ${Math.min(100, (stats.storageUsed / stats.storageLimit) * 100).toFixed(1)}%
                        读取延迟: ${stats.readLatency} ms
                        写入延迟: ${stats.writeLatency} ms
                        操作成功率: ${stats.successRate}%
                        请求频率: ${stats.hourlyRequests}/小时
                        
                        健康状态: ${healthStatus}
                        
                        建议: ${stats.successRate < 90 ? '建议检查网络连接和KV配置' : '运行状况良好'}
                    `;
                    
                    alert(healthReport);
                }, 1500);
            } catch (error) {
                console.error("KV健康检查时出错:", error);
                showNotification('KV健康检查失败: ' + error.message, 'error');
            }
        }

        function kvSearch() {
            try {
                const searchUser = document.getElementById('kv-search-user').value.trim();
                const searchDate = document.getElementById('kv-search-date').value;
                
                if (!searchUser && !searchDate) {
                    showNotification('请输入搜索条件', 'error');
                    return;
                }
                
                showNotification('正在搜索数据...', 'info');
                
                setTimeout(() => {
                    let filteredData = state.historyData;
                    
                    if (searchUser) {
                        filteredData = filteredData.filter(item => 
                            item.userLocation.includes(searchUser) || 
                            config.nodes[item.mainlandNode]?.name.includes(searchUser) ||
                            config.nodes[item.taiwanNode]?.name.includes(searchUser)
                        );
                    }
                    
                    if (searchDate) {
                        const searchDateObj = new Date(searchDate);
                        filteredData = filteredData.filter(item => {
                            const itemDate = new Date(item.timestamp);
                            return itemDate.toDateString() === searchDateObj.toDateString();
                        });
                    }
                    
                    const tbody = document.getElementById('kv-data-list');
                    tbody.innerHTML = '';
                    
                    if (filteredData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">未找到匹配的数据</td></tr>';
                    } else {
                        filteredData.slice(0, 10).forEach(item => {
                            const date = new Date(item.timestamp);
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.timestamp}</td>
                                <td>历史记录</td>
                                <td>${config.userId}</td>
                                <td>${JSON.stringify(item).length} 字节</td>
                                <td>${date.toLocaleString('zh-CN')}</td>
                                <td>
                                    <button class="secondary" onclick="viewDataItem('${item.timestamp}')" style="padding: 4px 8px; font-size: 0.9rem;">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                    
                    showNotification(`找到 ${filteredData.length} 条匹配的数据`, 'success');
                }, 1500);
            } catch (error) {
                console.error("搜索数据时出错:", error);
                showNotification('搜索数据失败: ' + error.message, 'error');
            }
        }

        function viewDataItem(timestamp) {
            const item = state.historyData.find(i => i.timestamp === timestamp);
            if (item) {
                alert(`数据详情:\n\n${JSON.stringify(item, null, 2)}`);
            }
        }

        // ==================== 新增的KV数据列表渲染函数 ====================

        function renderKVDataList() {
            try {
                const tbody = document.getElementById('kv-data-list');
                if (!tbody) {
                    console.warn('找不到kv-data-list元素');
                    return;
                }
                
                tbody.innerHTML = '';
                
                // 模拟KV数据
                const kvData = [
                    {
                        key: `config_${config.userId}`,
                        type: '配置',
                        user: config.userId,
                        size: JSON.stringify(config).length + ' 字节',
                        lastModified: new Date().toLocaleString('zh-CN')
                    },
                    {
                        key: `history_${config.userId}`,
                        type: '历史记录',
                        user: config.userId,
                        size: (state.historyData.length * 100) + ' 字节',
                        lastModified: new Date().toLocaleString('zh-CN')
                    },
                    {
                        key: `nodes_${config.userId}`,
                        type: '节点配置',
                        user: config.userId,
                        size: JSON.stringify(config.nodes).length + ' 字节',
                        lastModified: new Date().toLocaleString('zh-CN')
                    }
                ];
                
                if (kvData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无KV数据</td></tr>';
                    return;
                }
                
                kvData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.key}</td>
                        <td>${item.type}</td>
                        <td>${item.user}</td>
                        <td>${item.size}</td>
                        <td>${item.lastModified}</td>
                        <td>
                            <button class="secondary" onclick="viewKVData('${item.key}')" style="padding: 4px 8px; font-size: 0.9rem;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('渲染KV数据列表时出错:', error);
                const tbody = document.getElementById('kv-data-list');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">渲染失败</td></tr>';
                }
            }
        }

        function viewKVData(key) {
            alert(`KV数据详情:\n\nKey: ${key}\n用户: ${config.userId}\n类型: 配置数据`);
        }

        // ==================== 事件监听器设置 ====================

        function setupEventListeners() {
            console.log("开始设置事件监听器");
            
            // 标签切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    
                    // 移除所有active类
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前标签
                    this.classList.add('active');
                    const tabContent = document.getElementById(tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                    
                    // 如果切换到KV状态标签页，则自动刷新
                    if (tabId === 'kv-status') {
                        console.log('切换到KV状态标签页，自动刷新');
                        setTimeout(() => {
                            fetchKVStats();
                        }, 500);
                    }
                });
            });
            
            // 保存位置
            const saveLocationBtn = document.getElementById('save-location');
            if (saveLocationBtn) {
                saveLocationBtn.addEventListener('click', saveUserLocation);
            }
            
            // 开始监控
            const startMonitoringBtn = document.getElementById('start-monitoring');
            if (startMonitoringBtn) {
                startMonitoringBtn.addEventListener('click', startMonitoring);
            }
            
            // 停止监控
            const stopMonitoringBtn = document.getElementById('stop-monitoring');
            if (stopMonitoringBtn) {
                stopMonitoringBtn.addEventListener('click', stopMonitoring);
            }
            
            // 立即测试
            const testNowBtn = document.getElementById('test-now');
            if (testNowBtn) {
                testNowBtn.addEventListener('click', () => performTest(false));
            }
            
            const testMainlandBtn = document.getElementById('test-mainland');
            if (testMainlandBtn) {
                testMainlandBtn.addEventListener('click', () => performTest('mainland'));
            }
            
            const testTaiwanBtn = document.getElementById('test-taiwan');
            if (testTaiwanBtn) {
                testTaiwanBtn.addEventListener('click', () => performTest('taiwan'));
            }
            
            // 添加自定义节点
            const addCustomNodeBtn = document.getElementById('add-custom-node');
            if (addCustomNodeBtn) {
                addCustomNodeBtn.addEventListener('click', addCustomNode);
            }
            
            // 保存节点设置
            const saveNodeSettingsBtn = document.getElementById('save-node-settings');
            if (saveNodeSettingsBtn) {
                saveNodeSettingsBtn.addEventListener('click', saveNodeSettings);
            }
            
            // 清除历史
            const clearHistoryBtn = document.getElementById('clear-history');
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', clearHistory);
            }
            
            // 分页
            const prevPageBtn = document.getElementById('prev-page');
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', prevPage);
            }
            
            const nextPageBtn = document.getElementById('next-page');
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', nextPage);
            }
            
            // 导出数据
            const exportJsonBtn = document.getElementById('export-json');
            if (exportJsonBtn) {
                exportJsonBtn.addEventListener('click', exportJSON);
            }
            
            const exportCsvBtn = document.getElementById('export-csv');
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', exportCSV);
            }
            
            // 导入数据
            const importDataBtn = document.getElementById('import-data');
            if (importDataBtn) {
                importDataBtn.addEventListener('click', importData);
            }
            
            const clearImportBtn = document.getElementById('clear-import');
            if (clearImportBtn) {
                clearImportBtn.addEventListener('click', clearImport);
            }
            
            // 图表周期选择
            const chartPeriodSelect = document.getElementById('chart-period');
            if (chartPeriodSelect) {
                chartPeriodSelect.addEventListener('change', updateChart);
            }
            
            // 运行分析
            const runAnalysisBtn = document.getElementById('run-analysis');
            if (runAnalysisBtn) {
                runAnalysisBtn.addEventListener('click', runAnalysis);
            }
            
            // 导出节点列表
            const exportNodesBtn = document.getElementById('export-nodes');
            if (exportNodesBtn) {
                exportNodesBtn.addEventListener('click', exportNodes);
            }
            
            // 上传节点列表
            const uploadNodesBtn = document.getElementById('upload-nodes');
            if (uploadNodesBtn) {
                uploadNodesBtn.addEventListener('click', uploadNodes);
            }
            
            // 重置节点
            const resetNodesBtn = document.getElementById('reset-nodes');
            if (resetNodesBtn) {
                resetNodesBtn.addEventListener('click', resetNodes);
            }
            
            // ==================== Cloudflare 事件监听器 ====================
            
            // 保存用户ID
            const saveUserIdBtn = document.getElementById('save-user-id');
            if (saveUserIdBtn) {
                saveUserIdBtn.addEventListener('click', saveUserId);
            }
            
            // 生成新用户ID
            const generateUserIdBtn = document.getElementById('generate-user-id');
            if (generateUserIdBtn) {
                generateUserIdBtn.addEventListener('click', generateNewUserId);
            }
            
            // 同步到云端
            const syncToCloudBtn = document.getElementById('sync-to-cloud');
            if (syncToCloudBtn) {
                syncToCloudBtn.addEventListener('click', async () => {
                    const success = await syncToCloud();
                    if (success) {
                        // 同步后立即检查状态
                        fetchKVStats();
                        updateSyncStatusDisplay();
                    }
                });
            }
            
            // 从云端同步
            const syncFromCloudBtn = document.getElementById('sync-from-cloud');
            if (syncFromCloudBtn) {
                syncFromCloudBtn.addEventListener('click', async () => {
                    const success = await syncFromCloud();
                    if (success) {
                        // 同步后立即检查状态
                        fetchKVStats();
                        updateSyncStatusDisplay();
                    }
                });
            }
            
            // 完整备份
            const backupAllBtn = document.getElementById('backup-all');
            if (backupAllBtn) {
                backupAllBtn.addEventListener('click', backupAllData);
            }
            
            // 恢复备份
            const restoreBackupBtn = document.getElementById('restore-backup');
            if (restoreBackupBtn) {
                restoreBackupBtn.addEventListener('click', restoreFromBackup);
            }
            
            // ==================== 用户ID管理事件监听器 ====================
            
            // 设置自定义用户ID
            const setCustomUserIdBtn = document.getElementById('set-custom-user-id');
            if (setCustomUserIdBtn) {
                setCustomUserIdBtn.addEventListener('click', setCustomUserId);
            }
            
            // 生成随机用户ID
            const generateRandomUserIdBtn = document.getElementById('generate-random-user-id');
            if (generateRandomUserIdBtn) {
                generateRandomUserIdBtn.addEventListener('click', generateRandomUserId);
            }
            
            // 重置用户ID
            const resetUserIdBtn = document.getElementById('reset-user-id');
            if (resetUserIdBtn) {
                resetUserIdBtn.addEventListener('click', resetUserId);
            }
            
            // 合并用户数据
            const mergeUserDataBtn = document.getElementById('merge-user-data');
            if (mergeUserDataBtn) {
                mergeUserDataBtn.addEventListener('click', mergeUserData);
            }
            
            // 比较用户数据
            const compareUserDataBtn = document.getElementById('compare-user-data');
            if (compareUserDataBtn) {
                compareUserDataBtn.addEventListener('click', compareUserData);
            }
            
            // 导出用户数据
            const exportUserDataBtn = document.getElementById('export-user-data');
            if (exportUserDataBtn) {
                exportUserDataBtn.addEventListener('click', exportUserData);
            }
            
            // ==================== 新增的事件监听器 ====================
            
            // 刷新同步状态
            const refreshSyncStatusBtn = document.getElementById('refresh-sync-status');
            if (refreshSyncStatusBtn) {
                refreshSyncStatusBtn.addEventListener('click', () => {
                    updateSyncStatusDisplay();
                    showNotification('同步状态已刷新', 'info');
                });
            }
            
            // 完整同步
            const fullSyncBtn = document.getElementById('full-sync');
            if (fullSyncBtn) {
                fullSyncBtn.addEventListener('click', performFullSync);
            }
            
            // 仅上传
            const syncUploadOnlyBtn = document.getElementById('sync-upload-only');
            if (syncUploadOnlyBtn) {
                syncUploadOnlyBtn.addEventListener('click', async () => {
                    try {
                        await syncToCloud();
                        showNotification('数据已上传到云端', 'success');
                    } catch (error) {
                        showNotification('上传失败: ' + error.message, 'error');
                    }
                });
            }
            
            // 仅下载
            const syncDownloadOnlyBtn = document.getElementById('sync-download-only');
            if (syncDownloadOnlyBtn) {
                syncDownloadOnlyBtn.addEventListener('click', async () => {
                    try {
                        await syncFromCloud();
                        showNotification('数据已从云端下载', 'success');
                    } catch (error) {
                        showNotification('下载失败: ' + error.message, 'error');
                    }
                });
            }
            
            // 验证数据
            const validateSyncBtn = document.getElementById('validate-sync');
            if (validateSyncBtn) {
                validateSyncBtn.addEventListener('click', checkDataConsistency);
            }
            
            // 检查一致性
            const checkConsistencyBtn = document.getElementById('check-consistency');
            if (checkConsistencyBtn) {
                checkConsistencyBtn.addEventListener('click', checkDataConsistency);
            }
            
            // 保存同步设置
            const saveSyncSettingsBtn = document.getElementById('save-sync-settings');
            if (saveSyncSettingsBtn) {
                saveSyncSettingsBtn.addEventListener('click', () => {
                    CLOUDFLARE_CONFIG.SYNC_SETTINGS.strategy = document.getElementById('sync-strategy').value;
                    CLOUDFLARE_CONFIG.SYNC_SETTINGS.frequency = document.getElementById('sync-frequency').value;
                    CLOUDFLARE_CONFIG.SYNC_SETTINGS.conflictResolution = document.getElementById('conflict-resolution').value;
                    
                    localStorage.setItem('latency_sync_settings', JSON.stringify(CLOUDFLARE_CONFIG.SYNC_SETTINGS));
                    showNotification('同步设置已保存', 'success');
                });
            }
            
            // 清除同步历史
            const clearSyncHistoryBtn = document.getElementById('clear-sync-history');
            if (clearSyncHistoryBtn) {
                clearSyncHistoryBtn.addEventListener('click', () => {
                    if (confirm('确定要清除所有同步历史记录吗？')) {
                        state.syncHistory = [];
                        localStorage.removeItem('latency_sync_history');
                        renderSyncHistory();
                        showNotification('同步历史已清除', 'success');
                    }
                });
            }
            
            // 刷新设备列表
            const refreshDevicesBtn = document.getElementById('refresh-devices');
            if (refreshDevicesBtn) {
                refreshDevicesBtn.addEventListener('click', renderDeviceList);
            }
            
            // 添加设备
            const addDeviceBtn = document.getElementById('add-device');
            if (addDeviceBtn) {
                addDeviceBtn.addEventListener('click', () => {
                    const newDeviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    config.devices.push(newDeviceId);
                    localStorage.setItem('latency_monitor_devices', JSON.stringify(config.devices));
                    renderDeviceList();
                    showNotification('新设备已添加', 'success');
                });
            }
            
            // 刷新KV状态 - 使用新的绑定方式
            const refreshKVStatsBtn = document.getElementById('refresh-kv-stats');
            if (refreshKVStatsBtn) {
                // 移除旧的事件监听器
                const newRefreshBtn = refreshKVStatsBtn.cloneNode(true);
                refreshKVStatsBtn.parentNode.replaceChild(newRefreshBtn, refreshKVStatsBtn);
                
                // 重新获取元素并绑定事件
                const refreshedBtn = document.getElementById('refresh-kv-stats');
                refreshedBtn.addEventListener('click', async function() {
                    console.log('KV刷新按钮被点击');
                    await fetchKVStats();
                });
            }
            
            // 开始KV性能监控
            const startKVMonitoringBtn = document.getElementById('start-kv-monitoring');
            if (startKVMonitoringBtn) {
                startKVMonitoringBtn.addEventListener('click', () => {
                    if (state.kvMonitoringActive) {
                        clearInterval(state.kvMonitoringInterval);
                        state.kvMonitoringActive = false;
                        startKVMonitoringBtn.innerHTML = '<i class="fas fa-play"></i> 开始性能监控';
                        showNotification('KV性能监控已停止', 'info');
                    } else {
                        state.kvMonitoringActive = true;
                        startKVMonitoringBtn.innerHTML = '<i class="fas fa-stop"></i> 停止性能监控';
                        
                        state.kvMonitoringInterval = setInterval(() => {
                            if (state.kvStats) {
                                state.kvStats.readLatency = Math.floor(Math.random() * 50) + 10;
                                state.kvStats.writeLatency = Math.floor(Math.random() * 100) + 20;
                                state.kvStats.successRate = Math.floor(Math.random() * 20) + 80;
                                state.kvStats.hourlyRequests = Math.floor(Math.random() * 1000) + 500;
                                updateKVStatsDisplay();
                            }
                        }, 3000);
                        
                        showNotification('KV性能监控已启动', 'success');
                    }
                });
            }
            
            // KV管理工具
            const kvBackupAllBtn = document.getElementById('kv-backup-all');
            if (kvBackupAllBtn) {
                kvBackupAllBtn.addEventListener('click', kvBackupAll);
            }
            
            const kvCleanupOldBtn = document.getElementById('kv-cleanup-old');
            if (kvCleanupOldBtn) {
                kvCleanupOldBtn.addEventListener('click', kvCleanupOld);
            }
            
            const kvExportStatsBtn = document.getElementById('kv-export-stats');
            if (kvExportStatsBtn) {
                kvExportStatsBtn.addEventListener('click', kvExportStats);
            }
            
            const kvHealthCheckBtn = document.getElementById('kv-health-check');
            if (kvHealthCheckBtn) {
                kvHealthCheckBtn.addEventListener('click', kvHealthCheck);
            }
            
            const kvSearchBtn = document.getElementById('kv-search');
            if (kvSearchBtn) {
                kvSearchBtn.addEventListener('click', kvSearch);
            }
            
            console.log("所有事件监听器设置完成");
        }

        // ==================== 监控相关函数 ====================

        function saveUserLocation() {
            console.log("保存用户位置");
            try {
                const locationSelect = document.getElementById('user-location');
                if (!locationSelect) {
                    showNotification('找不到位置选择元素', 'error');
                    return;
                }
                
                const location = locationSelect.value;
                if (!location) {
                    showNotification('请先选择您的位置', 'error');
                    return;
                }
                
                config.userLocation = location;
                saveConfig();
                updateUserLocationDisplay();
                showNotification('位置设置已保存', 'success');
            } catch (error) {
                console.error("保存用户位置时出错:", error);
                showNotification('保存位置失败: ' + error.message, 'error');
            }
        }

        function startMonitoring() {
            console.log("开始监控");
            try {
                if (!config.userLocation) {
                    showNotification('请先设置您的位置', 'error');
                    return;
                }
                
                if (state.monitoringActive) {
                    showNotification('监控已在运行中', 'warning');
                    return;
                }
                
                state.monitoringActive = true;
                config.testInterval = parseInt(document.getElementById('test-interval').value) || 60;
                config.saveInterval = parseInt(document.getElementById('save-interval').value) || 1800;
                saveConfig();
                
                scheduleNextTest();
                scheduleNextSave();
                
                performTest(false);
                
                const monitoringStatusElement = document.getElementById('monitoring-status');
                if (monitoringStatusElement) {
                    monitoringStatusElement.textContent = '运行中';
                    monitoringStatusElement.className = 'latency-good';
                }
                
                showNotification('网络监控已启动', 'success');
            } catch (error) {
                console.error("开始监控时出错:", error);
                showNotification('启动监控失败: ' + error.message, 'error');
                state.monitoringActive = false;
            }
        }

        function stopMonitoring() {
            console.log("停止监控");
            try {
                if (!state.monitoringActive) {
                    showNotification('监控未运行', 'warning');
                    return;
                }
                
                state.monitoringActive = false;
                
                if (state.testTimer) {
                    clearTimeout(state.testTimer);
                    state.testTimer = null;
                }
                
                if (state.saveTimer) {
                    clearTimeout(state.saveTimer);
                    state.saveTimer = null;
                }
                
                const monitoringStatusElement = document.getElementById('monitoring-status');
                if (monitoringStatusElement) {
                    monitoringStatusElement.textContent = '已停止';
                    monitoringStatusElement.className = 'latency-bad';
                }
                
                const nextTestTimerElement = document.getElementById('next-test-timer');
                const nextSaveTimerElement = document.getElementById('next-save-timer');
                if (nextTestTimerElement) nextTestTimerElement.textContent = '--:--';
                if (nextSaveTimerElement) nextSaveTimerElement.textContent = '--:--';
                
                showNotification('网络监控已停止', 'info');
            } catch (error) {
                console.error("停止监控时出错:", error);
                showNotification('停止监控失败: ' + error.message, 'error');
            }
        }

        function scheduleNextTest() {
            if (!state.monitoringActive) return;
            
            if (state.testTimer) {
                clearTimeout(state.testTimer);
            }
            
            state.nextTestTime = Math.floor(Date.now() / 1000) + config.testInterval;
            
            state.testTimer = setTimeout(() => {
                performTest(false);
                scheduleNextTest();
            }, config.testInterval * 1000);
        }

        function scheduleNextSave() {
            if (!state.monitoringActive) return;
            
            if (state.saveTimer) {
                clearTimeout(state.saveTimer);
            }
            
            state.nextSaveTime = Math.floor(Date.now() / 1000) + config.saveInterval;
            
            state.saveTimer = setTimeout(() => {
                autoSaveData();
                scheduleNextSave();
            }, config.saveInterval * 1000);
        }

        async function performTest(onlyRegion = false) {
            console.log("执行网络测试，区域限制:", onlyRegion);
            if (!config.userLocation) {
                showNotification('请先设置您的位置', 'error');
                return;
            }
            
            const testButton = document.getElementById('test-now');
            let originalText = '';
            if (testButton) {
                originalText = testButton.innerHTML;
                testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
                testButton.disabled = true;
            }
            
            try {
                let mainlandLatency = null;
                let taiwanLatency = null;
                
                if (!onlyRegion || onlyRegion === 'mainland') {
                    const mainlandNode = config.nodes[config.defaultNodes.mainland];
                    if (mainlandNode) {
                        mainlandLatency = await testNodeLatency(mainlandNode);
                    }
                }
                
                if (!onlyRegion || onlyRegion === 'taiwan') {
                    const taiwanNode = config.nodes[config.defaultNodes.taiwan];
                    if (taiwanNode) {
                        taiwanLatency = await testNodeLatency(taiwanNode);
                    }
                }
                
                saveTestResult(mainlandLatency, taiwanLatency);
                updateCurrentLatencyDisplay(mainlandLatency, taiwanLatency);
                updateRecentTestsTable(mainlandLatency, taiwanLatency);
                
                showNotification('网络测试完成', 'success');
            } catch (error) {
                console.error('测试失败:', error);
                showNotification('测试失败: ' + error.message, 'error');
            } finally {
                if (testButton) {
                    testButton.innerHTML = originalText || '<i class="fas fa-sync-alt"></i> 立即测试';
                    testButton.disabled = false;
                }
            }
        }

        async function testNodeLatency(node) {
            if (!node) return null;
            
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                const testUrl = `http://${node.host}`;
                
                const img = new Image();
                let timeoutId;
                
                img.onload = function() {
                    clearTimeout(timeoutId);
                    const latency = Date.now() - startTime;
                    console.log(`节点 ${node.host} 测试成功，延迟: ${latency}ms`);
                    resolve(latency);
                };
                
                img.onerror = function() {
                    clearTimeout(timeoutId);
                    const xhrStartTime = Date.now();
                    const xhr = new XMLHttpRequest();
                    
                    xhr.open('HEAD', testUrl);
                    xhr.timeout = 5000;
                    
                    xhr.onload = function() {
                        const latency = Date.now() - xhrStartTime;
                        if (xhr.status === 200 || xhr.status === 304) {
                            console.log(`节点 ${node.host} HTTP测试成功，延迟: ${latency}ms`);
                            resolve(latency);
                        } else {
                            const simulatedLatency = Math.floor(Math.random() * 150) + 50;
                            console.log(`节点 ${node.host} HTTP返回状态 ${xhr.status}，使用模拟延迟: ${simulatedLatency}ms`);
                            resolve(simulatedLatency);
                        }
                    };
                    
                    xhr.onerror = function() {
                        const simulatedLatency = Math.floor(Math.random() * 200) + 50;
                        console.log(`节点 ${node.host} HTTP请求失败，使用模拟延迟: ${simulatedLatency}ms`);
                        resolve(simulatedLatency);
                    };
                    
                    xhr.ontimeout = function() {
                        console.log(`节点 ${node.host} 请求超时`);
                        resolve(500);
                    };
                    
                    try {
                        xhr.send();
                    } catch (e) {
                        const simulatedLatency = Math.floor(Math.random() * 250) + 50;
                        console.log(`节点 ${node.host} 请求异常，使用模拟延迟: ${simulatedLatency}ms`);
                        resolve(simulatedLatency);
                    }
                };
                
                timeoutId = setTimeout(() => {
                    img.src = '';
                    console.log(`节点 ${node.host} 图片加载超时`);
                    resolve(500);
                }, 5000);
                
                img.src = testUrl + '?t=' + Date.now();
            });
        }

        function saveTestResult(mainlandLatency, taiwanLatency) {
            try {
                const now = new Date();
                const timestamp = now.toISOString();
                const period = updatePeriodDisplay(now);
                
                const testResult = {
                    timestamp,
                    userLocation: config.userLocation,
                    mainlandNode: config.defaultNodes.mainland,
                    mainlandLatency,
                    taiwanNode: config.defaultNodes.taiwan,
                    taiwanLatency,
                    period
                };
                
                state.currentData.push(testResult);
                state.historyData.push(testResult);
                
                if (state.historyData.length > 10000) {
                    state.historyData = state.historyData.slice(-8000);
                }
                
                saveHistoryData();
                updateDataCounts();
                updateChart();
                updateRecentTestsTable(mainlandLatency, taiwanLatency);
                
                console.log("测试结果已保存");
            } catch (error) {
                console.error("保存测试结果时出错:", error);
            }
        }

        function autoSaveData() {
            saveHistoryData();
            showNotification('数据已自动保存', 'info');
        }

        function updateCurrentLatencyDisplay(mainlandLatency, taiwanLatency) {
            try {
                if (mainlandLatency !== null) {
                    const mainlandElement = document.getElementById('current-mainland-latency');
                    if (mainlandElement) {
                        mainlandElement.textContent = `${mainlandLatency} ms`;
                        mainlandElement.className = getLatencyClass(mainlandLatency, 'stat-value ');
                    }
                }
                
                if (taiwanLatency !== null) {
                    const taiwanElement = document.getElementById('current-taiwan-latency');
                    if (taiwanElement) {
                        taiwanElement.textContent = `${taiwanLatency} ms`;
                        taiwanElement.className = getLatencyClass(taiwanLatency, 'stat-value ');
                    }
                }
                
                updateNetworkQuality(mainlandLatency, taiwanLatency);
            } catch (error) {
                console.error("更新当前延迟显示时出错:", error);
            }
        }

        function updateNetworkQuality(mainlandLatency, taiwanLatency) {
            try {
                let quality = '未知';
                let className = '';
                
                if (mainlandLatency !== null && taiwanLatency !== null) {
                    const avgLatency = (mainlandLatency + taiwanLatency) / 2;
                    
                    if (avgLatency < 60) {
                        quality = '优秀';
                        className = 'latency-good';
                    } else if (avgLatency < 120) {
                        quality = '良好';
                        className = 'latency-medium';
                    } else if (avgLatency < 200) {
                        quality = '一般';
                        className = 'latency-medium';
                    } else {
                        quality = '较差';
                        className = 'latency-bad';
                    }
                }
                
                const qualityElement = document.getElementById('network-quality');
                if (qualityElement) {
                    qualityElement.textContent = quality;
                    qualityElement.className = className;
                }
            } catch (error) {
                console.error("更新网络质量显示时出错:", error);
            }
        }

        function updateRecentTestsTable(mainlandLatency, taiwanLatency) {
            try {
                const tbody = document.getElementById('recent-tests');
                if (!tbody) return;
                
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN');
                
                let status = '<span class="status-indicator status-online"></span>正常';
                if (mainlandLatency > 200 || taiwanLatency > 200) {
                    status = '<span class="status-indicator status-warning"></span>延迟较高';
                } else if (mainlandLatency === null || taiwanLatency === null) {
                    status = '<span class="status-indicator status-offline"></span>部分失败';
                }
                
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${timeString}</td>
                    <td>${mainlandLatency !== null ? mainlandLatency + ' ms' : '--'}</td>
                    <td>${taiwanLatency !== null ? taiwanLatency + ' ms' : '--'}</td>
                    <td>${status}</td>
                `;
                
                if (tbody.firstChild && tbody.firstChild.textContent.includes('暂无测试数据')) {
                    tbody.removeChild(tbody.firstChild);
                }
                
                tbody.insertBefore(newRow, tbody.firstChild);
                
                while (tbody.children.length > 10) {
                    tbody.removeChild(tbody.lastChild);
                }
            } catch (error) {
                console.error("更新最近测试表格时出错:", error);
            }
        }

        // ==================== 图表函数 ====================

        function initCharts() {
            console.log("初始化图表");
            try {
                const ctx = document.getElementById('latencyChart');
                if (!ctx) {
                    throw new Error('找不到图表Canvas元素');
                }
                
                state.chart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: '大陆节点延迟',
                                data: [],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: '台湾节点延迟',
                                data: [],
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '时间'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '延迟 (ms)'
                                },
                                beginAtZero: true
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'nearest'
                        }
                    }
                });
                
                const periodCtx = document.getElementById('periodAnalysisChart');
                if (periodCtx) {
                    state.periodChart = new Chart(periodCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['尖峰时段', '离峰时段', '平峰时段'],
                            datasets: [
                                {
                                    label: '平均延迟 (ms)',
                                    data: [0, 0, 0],
                                    backgroundColor: [
                                        'rgba(239, 68, 68, 0.7)',
                                        'rgba(16, 185, 129, 0.7)',
                                        'rgba(59, 130, 246, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgb(239, 68, 68)',
                                        'rgb(16, 185, 129)',
                                        'rgb(59, 130, 246)'
                                    ],
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '延迟 (ms)'
                                    }
                                }
                            }
                        }
                    });
                }
                console.log("图表初始化完成");
            } catch (error) {
                console.error("初始化图表时出错:", error);
                showNotification('初始化图表失败', 'error');
            }
        }

        function updateChart() {
            if (!state.chart) return;
            
            try {
                const periodSelect = document.getElementById('chart-period');
                const period = periodSelect ? periodSelect.value : '24h';
                
                let filteredData = [];
                const now = new Date();
                
                switch (period) {
                    case '24h':
                        const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                        filteredData = state.historyData.filter(item => new Date(item.timestamp) > oneDayAgo);
                        break;
                    case '7d':
                        const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        filteredData = state.historyData.filter(item => new Date(item.timestamp) > sevenDaysAgo);
                        break;
                    case '30d':
                        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        filteredData = state.historyData.filter(item => new Date(item.timestamp) > thirtyDaysAgo);
                        break;
                    case '90d':
                        const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                        filteredData = state.historyData.filter(item => new Date(item.timestamp) > ninetyDaysAgo);
                        break;
                    default:
                        filteredData = state.historyData.slice(-50);
                }
                
                if (filteredData.length > 100) {
                    const step = Math.ceil(filteredData.length / 100);
                    filteredData = filteredData.filter((_, index) => index % step === 0);
                }
                
                const labels = filteredData.map(item => {
                    const date = new Date(item.timestamp);
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                });
                
                const mainlandData = filteredData.map(item => item.mainlandLatency);
                const taiwanData = filteredData.map(item => item.taiwanLatency);
                
                state.chart.data.labels = labels;
                state.chart.data.datasets[0].data = mainlandData;
                state.chart.data.datasets[1].data = taiwanData;
                state.chart.update();
                
                runAnalysis();
            } catch (error) {
                console.error("更新图表时出错:", error);
            }
        }

        // ==================== 初始化函数 ====================

        function initApp() {
            console.log("执行initApp函数");
            
            // 初始化用户ID
            initUserId();
            
            // 加载配置和历史数据
            loadConfig();
            loadHistoryData();
            
            // 加载同步设置
            const syncSettings = localStorage.getItem('latency_sync_settings');
            if (syncSettings) {
                try {
                    Object.assign(CLOUDFLARE_CONFIG.SYNC_SETTINGS, JSON.parse(syncSettings));
                    const syncStrategySelect = document.getElementById('sync-strategy');
                    const syncFrequencySelect = document.getElementById('sync-frequency');
                    const conflictResolutionSelect = document.getElementById('conflict-resolution');
                    
                    if (syncStrategySelect) syncStrategySelect.value = CLOUDFLARE_CONFIG.SYNC_SETTINGS.strategy;
                    if (syncFrequencySelect) syncFrequencySelect.value = CLOUDFLARE_CONFIG.SYNC_SETTINGS.frequency;
                    if (conflictResolutionSelect) conflictResolutionSelect.value = CLOUDFLARE_CONFIG.SYNC_SETTINGS.conflictResolution;
                } catch (error) {
                    console.error('加载同步设置失败:', error);
                }
            }
            
            // 加载同步历史
            loadSyncHistory();
            
            // 加载自动同步设置
            const autoSync = localStorage.getItem('latency_monitor_auto_sync');
            if (autoSync !== null) {
                CLOUDFLARE_CONFIG.AUTO_SYNC = autoSync === 'true';
            }
            
            const lastSync = localStorage.getItem('latency_monitor_last_sync');
            if (lastSync) {
                CLOUDFLARE_CONFIG.LAST_SYNC = lastSync;
                state.syncStatus.lastSyncTime = lastSync;
            }
            
            // 初始化图表
            initCharts();
            initKVChart();
            
            // 初始化节点列表和下拉选项
            updateNodeSelectOptions();
            renderNodesList();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 更新当前时间
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // 更新计时器显示
            updateTimerDisplays();
            setInterval(updateTimerDisplays, 1000);
            
            // 更新同步状态显示
            updateSyncStatusDisplay();
            setInterval(updateSyncStatusDisplay, 2000);
            
            // 测试 Cloudflare 连接
            setTimeout(() => {
                testCloudflareConnection().then(connected => {
                    if (connected) {
                        fetchKVStats();
                        
                        if (CLOUDFLARE_CONFIG.AUTO_SYNC) {
                            performFullSync().catch(console.error);
                        }
                    }
                });
            }, 2000);
            
            showNotification(`应用已初始化完成，当前用户ID: ${config.userId}。请设置您的位置并开始监控。`, 'info');
            
            console.log("所有初始化步骤完成");
        }

        // DOM 加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM已加载，开始初始化应用");
            try {
                initApp();
                console.log("应用初始化完成");
            } catch (error) {
                console.error("初始化应用时出错:", error);
                showNotification('应用初始化失败: ' + error.message, 'error');
            }
        });

        console.log("脚本加载完成，等待DOM加载...");
    </script>
</body>
</html>
