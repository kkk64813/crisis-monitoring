<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>两岸网络延迟监测工具</title>
    <!-- 使用本地可访问的CDN链接 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        /* [样式代码保持不变，与之前完全一样] */
        :root {
            --primary-color: #2563eb;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border-radius: 0 0 12px 12px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .current-time {
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tabs {
            display: flex;
            background-color: white;
            border-radius: 10px;
            padding: 6px;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab:hover {
            background-color: #f3f4f6;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        
        .card-title i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .stat-box {
            background-color: #f8fafc;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .latency-good {
            color: var(--secondary-color);
        }
        
        .latency-medium {
            color: var(--warning-color);
        }
        
        .latency-bad {
            color: var(--danger-color);
        }
        
        .time-period-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .peak-period {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .offpeak-period {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .control-group {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .control-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        select, input, button {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: #1d4ed8;
        }
        
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        button.secondary {
            background-color: #6b7280;
        }
        
        button.secondary:hover {
            background-color: #4b5563;
        }
        
        button.success {
            background-color: var(--secondary-color);
        }
        
        button.success:hover {
            background-color: #0da271;
        }
        
        button.warning {
            background-color: var(--warning-color);
        }
        
        button.warning:hover {
            background-color: #d97706;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .button-group button {
            flex: 1;
        }
        
        .chart-container {
            height: 400px;
            margin-bottom: 1.5rem;
        }
        
        .nodes-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .node-card {
            background-color: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s;
        }
        
        .node-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .node-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .node-location {
            font-size: 0.9rem;
            color: #6b7280;
            background-color: #f3f4f6;
            padding: 3px 8px;
            border-radius: 4px;
        }
        
        .node-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .node-stat {
            text-align: center;
        }
        
        .node-stat-value {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .node-stat-label {
            color: #6b7280;
            font-size: 0.8rem;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .history-table th, .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .history-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        
        .history-table tr:hover {
            background-color: #f9fafb;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: var(--secondary-color);
        }
        
        .status-offline {
            background-color: var(--danger-color);
        }
        
        .status-warning {
            background-color: var(--warning-color);
        }
        
        .import-export-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin-top: 1rem;
            background-color: #f9fafb;
        }
        
        .import-export-area:hover {
            border-color: var(--primary-color);
        }
        
        .file-input {
            margin-bottom: 1rem;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            transform: translateX(150%);
            transition: transform 0.5s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--secondary-color);
        }
        
        .notification.error {
            background-color: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger-color);
        }
        
        .notification.info {
            background-color: #dbeafe;
            color: #1e40af;
            border-left: 4px solid var(--primary-color);
        }
        
        .notification.warning {
            background-color: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--warning-color);
        }
        
        .footer {
            text-align: center;
            margin-top: 2rem;
            color: #6b7280;
            font-size: 0.9rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .nodes-upload-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: #f8fafc;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .nodes-template {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.85rem;
            overflow-x: auto;
        }
        
        .cloudflare-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: #f0f9ff;
            border-radius: 10px;
            border: 1px solid #bae6fd;
        }
        
        /* 新增的用户ID管理样式 */
        .user-id-management {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }
        
        .user-id-actions {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .user-id-actions button {
            flex: 1;
            min-width: 150px;
        }
        
        .data-integration {
            background-color: #f0f9ff;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #bae6fd;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .user-id-actions button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-satellite-dish"></i>
                    <span>两岸网络延迟监测工具</span>
                </div>
                <div class="current-time">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">--:--:--</span>
                    <span id="time-period" class="time-period-indicator offpeak-period">离峰时段</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> 仪表板
            </div>
            <div class="tab" data-tab="monitoring">
                <i class="fas fa-desktop"></i> 实时监控
            </div>
            <div class="tab" data-tab="analysis">
                <i class="fas fa-chart-line"></i> 数据分析
            </div>
            <div class="tab" data-tab="nodes">
                <i class="fas fa-server"></i> 节点管理
            </div>
            <div class="tab" data-tab="history">
                <i class="fas fa-history"></i> 历史数据
            </div>
            <div class="tab" data-tab="import-export">
                <i class="fas fa-file-import"></i> 导入/导出
            </div>
            <div class="tab" data-tab="cloudflare">
                <i class="fas fa-cloud"></i> 云端同步
            </div>
            <!-- 新增的用户ID管理标签 -->
            <div class="tab" data-tab="userid">
                <i class="fas fa-users"></i> 用户管理
            </div>
        </div>

        <!-- 仪表板标签 -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard">
                <div class="card">
                    <div class="card-title">
                        <span><i class="fas fa-globe-asia"></i> 当前网络状态</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value latency-good" id="current-mainland-latency">--</div>
                            <div class="stat-label">大陆节点延迟</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value latency-good" id="current-taiwan-latency">--</div>
                            <div class="stat-label">台湾节点延迟</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="network-quality">--</div>
                            <div class="stat-label">网络质量</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="packet-loss">0%</div>
                            <div class="stat-label">丢包率</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span><i class="fas fa-clock"></i> 定时器状态</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="next-test-timer">--:--</div>
                            <div class="stat-label">下次测试</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="next-save-timer">--:--</div>
                            <div class="stat-label">下次自动保存</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="tests-count">0</div>
                            <div class="stat-label">今日测试次数</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="data-points">0</div>
                            <div class="stat-label">数据点数</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-area"></i> 延迟趋势 (24小时)</span>
                    <div>
                        <select id="chart-period">
                            <option value="24h">24小时</option>
                            <option value="7d">7天</option>
                            <option value="30d">30天</option>
                            <option value="90d">90天</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-info-circle"></i> 状态信息</span>
                </div>
                <div id="status-message">
                    <p><i class="fas fa-user-circle"></i> 用户位置: <span id="user-location-display">未设置</span></p>
                    <p><i class="fas fa-wifi"></i> 监测状态: <span id="monitoring-status" class="latency-good">未启动</span></p>
                    <p><i class="fas fa-bell"></i> 时段建议: <span id="period-suggestion">--</span></p>
                    <p><i class="fas fa-cloud"></i> 云端状态: <span id="cloud-status">未连接</span></p>
                    <p><i class="fas fa-id-card"></i> 用户ID: <span id="current-user-id-display">未设置</span></p>
                </div>
            </div>
        </div>

        <!-- 实时监控标签 -->
        <div id="monitoring" class="tab-content">
            <!-- [内容保持不变] -->
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-map-marker-alt"></i> 用户位置设置
                    </div>
                    <div class="form-group">
                        <label for="user-location">选择您的位置</label>
                        <select id="user-location">
                            <option value="">请选择位置</option>
                            <optgroup label="中国大陆">
                                <option value="beijing">北京</option>
                                <option value="shanghai">上海</option>
                                <option value="shenzhen">深圳</option>
                                <option value="guangzhou">广州</option>
                                <option value="hangzhou">杭州</option>
                                <option value="chengdu">成都</option>
                                <option value="wuhan">武汉</option>
                                <option value="nanjing">南京</option>
                            </optgroup>
                            <optgroup label="台湾地区">
                                <option value="taipei">台北市</option>
                                <option value="taoyuan">桃园市</option>
                                <option value="taichung">台中市</option>
                                <option value="tainan">台南市</option>
                                <option value="kaohsiung">高雄市</option>
                                <option value="hsinchu">新竹市</option>
                            </optgroup>
                        </select>
                    </div>
                    <button id="save-location" class="success">
                        <i class="fas fa-save"></i> 保存位置设置
                    </button>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-sliders-h"></i> 定时设置
                    </div>
                    <div class="form-group">
                        <label for="test-interval">测试频率</label>
                        <select id="test-interval">
                            <option value="30">每30秒</option>
                            <option value="60" selected>每1分钟</option>
                            <option value="300">每5分钟</option>
                            <option value="600">每10分钟</option>
                            <option value="1800">每30分钟</option>
                            <option value="3600">每1小时</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="save-interval">自动保存频率</label>
                        <select id="save-interval">
                            <option value="300">每5分钟</option>
                            <option value="600">每10分钟</option>
                            <option value="1800" selected>每30分钟</option>
                            <option value="3600">每1小时</option>
                            <option value="7200">每2小时</option>
                            <option value="14400">每4小时</option>
                            <option value="28800">每8小时</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button id="start-monitoring" class="success">
                            <i class="fas fa-play"></i> 开始监控
                        </button>
                        <button id="stop-monitoring" class="warning">
                            <i class="fas fa-stop"></i> 停止监控
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-bolt"></i> 立即测试
                    </div>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #6b7280;">
                        点击下方按钮立即执行一次网络延迟测试
                    </p>
                    <button id="test-now">
                        <i class="fas fa-sync-alt"></i> 立即测试
                    </button>
                    <div class="button-group">
                        <button id="test-mainland" class="secondary">
                            <i class="fas fa-map"></i> 仅测试大陆节点
                        </button>
                        <button id="test-taiwan" class="secondary">
                            <i class="fas fa-map"></i> 仅测试台湾节点
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-list"></i> 最近测试结果</span>
                </div>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>大陆节点延迟</th>
                            <th>台湾节点延迟</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="recent-tests">
                        <tr>
                            <td colspan="4" style="text-align: center;">暂无测试数据</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 数据分析标签 -->
        <div id="analysis" class="tab-content">
            <!-- [内容保持不变] -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-bar"></i> 延迟统计分析</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="avg-latency-mainland">--</div>
                        <div class="stat-label">大陆平均延迟</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avg-latency-taiwan">--</div>
                        <div class="stat-label">台湾平均延迟</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="std-dev-mainland">--</div>
                        <div class="stat-label">大陆延迟标准差</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="std-dev-taiwan">--</div>
                        <div class="stat-label">台湾延迟标准差</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-pie"></i> 时段分析</span>
                </div>
                <div class="chart-container">
                    <canvas id="periodAnalysisChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-percentage"></i> 延迟基准分析</span>
                </div>
                <div id="baseline-analysis">
                    <p><i class="fas fa-arrow-up"></i> 尖峰时段基准延迟: <span id="peak-baseline">--</span> ms</p>
                    <p><i class="fas fa-arrow-down"></i> 离峰时段基准延迟: <span id="offpeak-baseline">--</span> ms</p>
                    <p><i class="fas fa-arrows-alt-h"></i> 正常波动范围: <span id="normal-range">--</span> ms</p>
                    <p><i class="fas fa-exclamation-triangle"></i> 异常检测: <span id="anomaly-count">0</span> 个异常点</p>
                </div>
                <button id="run-analysis" class="success" style="margin-top: 1rem;">
                    <i class="fas fa-calculator"></i> 重新分析数据
                </button>
            </div>
        </div>

        <!-- 节点管理标签 -->
        <div id="nodes" class="tab-content">
            <!-- [内容保持不变] -->
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-plus-circle"></i> 添加自定义节点
                    </div>
                    <div class="form-group">
                        <label for="node-name">节点名称</label>
                        <input type="text" id="node-name" placeholder="例如: 台北主节点">
                    </div>
                    <div class="form-group">
                        <label for="node-host">主机地址/IP</label>
                        <input type="text" id="node-host" placeholder="例如: ping.tpe.example.com 或 8.8.8.8">
                    </div>
                    <div class="form-group">
                        <label for="node-location">节点位置</label>
                        <select id="node-location">
                            <option value="mainland">中国大陆</option>
                            <option value="taiwan">台湾地区</option>
                        </select>
                    </div>
                    <button id="add-custom-node" class="success">
                        <i class="fas fa-plus"></i> 添加节点
                    </button>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-cog"></i> 节点设置
                    </div>
                    <div class="form-group">
                        <label for="default-mainland-node">默认大陆测试节点</label>
                        <select id="default-mainland-node">
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-taiwan-node">默认台湾测试节点</label>
                        <select id="default-taiwan-node">
                            <!-- 选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    <button id="save-node-settings">
                        <i class="fas fa-save"></i> 保存节点设置
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-server"></i> 节点列表</span>
                    <div>
                        <button id="export-nodes" class="secondary">
                            <i class="fas fa-download"></i> 导出节点列表
                        </button>
                    </div>
                </div>
                <div class="nodes-list" id="nodes-list">
                    <!-- 节点将通过JavaScript动态添加 -->
                </div>
                
                <!-- 节点上传功能区域 -->
                <div class="nodes-upload-section">
                    <div class="control-title">
                        <i class="fas fa-file-upload"></i> 上传节点列表
                    </div>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #6b7280;">
                        上传JSON格式的节点列表文件，将更新当前节点配置
                    </p>
                    <div class="import-export-area">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #9ca3af; margin-bottom: 1rem;"></i>
                        <p style="margin-bottom: 1rem; font-weight: 600;">拖放节点文件到此处或点击选择</p>
                        <input type="file" id="upload-nodes-file" class="file-input" accept=".json">
                        <p style="font-size: 0.85rem; color: #6b7280;">支持JSON格式节点列表，上传后将替换现有节点</p>
                    </div>
                    <div class="button-group" style="margin-top: 1rem;">
                        <button id="upload-nodes" class="secondary">
                            <i class="fas fa-upload"></i> 上传并更新节点
                        </button>
                        <button id="reset-nodes" class="warning">
                            <i class="fas fa-undo"></i> 重置为默认节点
                        </button>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <p><strong>节点文件格式说明:</strong></p>
                        <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">JSON文件应包含节点对象，键为节点ID，值为节点信息：</p>
                        <div class="nodes-template">
<pre>{
  "cn_bj_cloud": {
    "name": "北京腾讯云节点",
    "host": "49.232.189.68",
    "location": "mainland",
    "type": "ping"
  },
  "tw_nchc": {
    "name": "台湾杉一号 (NCHC)",
    "host": "140.110.148.11",
    "location": "taiwan", 
    "type": "ping"
  }
  // ... 更多节点
}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 历史数据标签 -->
        <div id="history" class="tab-content">
            <!-- [内容保持不变] -->
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-database"></i> 历史数据</span>
                    <div>
                        <button id="clear-history" class="warning">
                            <i class="fas fa-trash"></i> 清除历史
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>时间戳</th>
                                <th>用户位置</th>
                                <th>大陆节点</th>
                                <th>大陆延迟</th>
                                <th>台湾节点</th>
                                <th>台湾延迟</th>
                                <th>时段</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="history-data">
                            <tr>
                                <td colspan="8" style="text-align: center;">暂无历史数据</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="button-group" style="margin-top: 1rem;">
                    <button id="prev-page" class="secondary">
                        <i class="fas fa-chevron-left"></i> 上一页
                    </button>
                    <button id="next-page" class="secondary">
                        下一页 <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <p style="text-align: center; margin-top: 1rem; color: #6b7280;">
                    显示第 <span id="current-page">1</span> 页，共 <span id="total-pages">1</span> 页
                </p>
            </div>
        </div>

        <!-- 导入/导出标签 -->
        <div id="import-export" class="tab-content">
            <!-- [内容保持不变] -->
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-file-export"></i> 导出数据
                    </div>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #6b7280;">
                        将历史数据导出为JSON或CSV格式
                    </p>
                    <div class="button-group">
                        <button id="export-json" class="success">
                            <i class="fas fa-file-code"></i> 导出为JSON
                        </button>
                        <button id="export-csv" class="success">
                            <i class="fas fa-file-csv"></i> 导出为CSV
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-file-import"></i> 导入数据
                    </div>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #6b7280;">
                        导入JSON或CSV格式的历史数据，系统会自动去重
                    </p>
                    <div class="import-export-area">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #9ca3af; margin-bottom: 1rem;"></i>
                        <p style="margin-bottom: 1rem; font-weight: 600;">拖放文件到此处或点击选择</p>
                        <input type="file" id="import-file" class="file-input" accept=".json,.csv" multiple>
                        <p style="font-size: 0.85rem; color: #6b7280;">支持多个文件同时导入，系统会自动合并和去重</p>
                    </div>
                    <div class="button-group" style="margin-top: 1rem;">
                        <button id="import-data" class="secondary">
                            <i class="fas fa-upload"></i> 导入数据
                        </button>
                        <button id="clear-import" class="warning">
                            <i class="fas fa-times"></i> 清除选择
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-info-circle"></i> 导入/导出说明</span>
                </div>
                <div>
                    <p><strong>导出功能:</strong></p>
                    <ul style="padding-left: 1.5rem; margin-bottom: 1rem;">
                        <li>JSON格式: 包含完整数据，适合备份和迁移</li>
                        <li>CSV格式: 适合在电子表格中打开和分析</li>
                    </ul>
                    
                    <p><strong>导入功能:</strong></p>
                    <ul style="padding-left: 1.5rem; margin-bottom: 1rem;">
                        <li>支持多个文件同时导入</li>
                        <li>系统会自动去重（基于时间戳和节点）</li>
                        <li>导入数据会与现有数据合并</li>
                        <li>导入后请运行数据分析以更新统计信息</li>
                    </ul>
                    
                    <p><strong>数据格式:</strong></p>
                    <pre style="background-color: #f3f4f6; padding: 1rem; border-radius: 8px; font-size: 0.85rem; overflow-x: auto;">
{
  "timestamp": "2024-01-01T12:00:00Z",
  "userLocation": "shenzhen",
  "mainlandNode": "cn_bj_cloud",
  "mainlandLatency": 45,
  "taiwanNode": "tw_nchc",
  "taiwanLatency": 68,
  "period": "peak"
}</pre>
                </div>
            </div>
        </div>

        <!-- Cloudflare 云端同步标签 -->
        <div id="cloudflare" class="tab-content">
            <!-- [内容保持不变，只修改用户ID部分] -->
            <div class="control-panel">
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-cloud"></i> Cloudflare 云端同步
                    </div>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #6b7280;">
                        将数据同步到 Cloudflare Workers，实现跨设备访问和数据备份
                    </p>
                    <div class="form-group">
                        <label for="cloudflare-worker-url">Cloudflare Worker URL</label>
                        <input type="text" id="cloudflare-worker-url" value="https://latency-monitor-api.mgjack13.workers.dev" readonly>
                        <small style="color: #6b7280; display: block; margin-top: 5px;">你的 Worker 地址，无需修改</small>
                    </div>
                    <div class="form-group">
                        <label for="cloudflare-user-id">你的用户ID</label>
                        <input type="text" id="cloudflare-user-id" placeholder="输入自定义用户ID">
                        <small style="color: #6b7280; display: block; margin-top: 5px;">自定义用户ID，用于在不同设备间同步数据</small>
                    </div>
                    <div class="button-group">
                        <button id="save-user-id" class="success">
                            <i class="fas fa-save"></i> 保存用户ID
                        </button>
                        <button id="generate-user-id" class="secondary">
                            <i class="fas fa-id-card"></i> 生成新ID
                        </button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">
                        <i class="fas fa-sync"></i> 同步操作
                    </div>
                    <div class="button-group">
                        <button id="sync-to-cloud" class="success">
                            <i class="fas fa-cloud-upload-alt"></i> 同步到云端
                        </button>
                        <button id="sync-from-cloud" class="secondary">
                            <i class="fas fa-cloud-download-alt"></i> 从云端同步
                        </button>
                    </div>
                    <div class="button-group">
                        <button id="backup-all" class="warning">
                            <i class="fas fa-database"></i> 完整备份
                        </button>
                        <button id="restore-backup" class="warning">
                            <i class="fas fa-history"></i> 恢复备份
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-line"></i> 同步状态</span>
                </div>
                <div id="cloud-status-details">
                    <p><i class="fas fa-plug"></i> 连接状态: <span id="cloud-connection-status" class="latency-medium">未测试</span></p>
                    <p><i class="fas fa-database"></i> 云端数据: <span id="cloud-data-status">未知</span></p>
                    <p><i class="fas fa-clock"></i> 最后同步: <span id="last-sync-time">从未同步</span></p>
                    <p><i class="fas fa-sd-card"></i> 本地数据: <span id="local-data-count">0 条记录</span></p>
                    <p><i class="fas fa-hdd"></i> 云端存储: <span id="cloud-storage-info">未连接</span></p>
                </div>
                
                <div class="button-group" style="margin-top: 1rem;">
                    <button id="auto-sync-toggle" class="secondary">
                        <i class="fas fa-robot"></i> 自动同步: <span id="auto-sync-status">关闭</span>
                    </button>
                    <button id="clear-cloud-data" class="danger" style="background-color: #ef4444;">
                        <i class="fas fa-trash"></i> 清除云端数据
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-info-circle"></i> Cloudflare 使用说明</span>
                </div>
                <div>
                    <p><strong>什么是 Cloudflare Workers？</strong></p>
                    <ul style="padding-left: 1.5rem; margin-bottom: 1rem;">
                        <li>Cloudflare Workers 是 Cloudflare 提供的无服务器计算平台</li>
                        <li>免费套餐提供每天 100,000 次请求</li>
                        <li>数据存储在 Cloudflare 的全球边缘网络中</li>
                        <li>支持跨设备访问同一份数据</li>
                    </ul>
                    
                    <p><strong>同步功能说明:</strong></p>
                    <ul style="padding-left: 1.5rem; margin-bottom: 1rem;">
                        <li><strong>同步到云端</strong>: 将本地配置和历史数据上传到 Cloudflare</li>
                        <li><strong>从云端同步</strong>: 从 Cloudflare 下载数据到本地</li>
                        <li><strong>完整备份</strong>: 创建包含所有数据的备份文件</li>
                        <li><strong>恢复备份</strong>: 从备份文件恢复数据</li>
                    </ul>
                    
                    <p><strong>注意事项:</strong></p>
                    <ul style="padding-left: 1.5rem; margin-bottom: 1rem;">
                        <li>数据在 Cloudflare 中是加密存储的</li>
                        <li>每个用户ID对应一个独立的数据空间</li>
                        <li>免费套餐有每日请求限制，正常使用完全足够</li>
                        <li>建议定期导出本地备份以防万一</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 新增的用户ID管理标签 -->
        <div id="userid" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-user-cog"></i> 用户ID管理</span>
                </div>
                
                <div class="user-id-management">
                    <h3 style="margin-bottom: 1rem; color: var(--dark-color);">
                        <i class="fas fa-id-card"></i> 当前用户ID
                    </h3>
                    <div class="form-group">
                        <label for="custom-user-id">自定义用户ID</label>
                        <input type="text" id="custom-user-id" placeholder="输入您的自定义用户ID (如: user_001)">
                        <small style="color: #6b7280; display: block; margin-top: 5px;">
                            使用相同的用户ID在不同设备上可以共享数据。建议使用有意义的ID，如: user_001, user_beijing等。
                        </small>
                    </div>
                    
                    <div class="user-id-actions">
                        <button id="set-custom-user-id" class="success">
                            <i class="fas fa-save"></i> 设置用户ID
                        </button>
                        <button id="generate-random-user-id" class="secondary">
                            <i class="fas fa-random"></i> 生成随机ID
                        </button>
                        <button id="reset-user-id" class="warning">
                            <i class="fas fa-undo"></i> 重置为默认
                        </button>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <p><strong>当前用户ID:</strong> <span id="current-user-id" style="font-weight: bold; color: var(--primary-color);">未设置</span></p>
                        <p><strong>用户ID类型:</strong> <span id="user-id-type">默认随机ID</span></p>
                        <p><strong>设备数量:</strong> <span id="device-count">1</span> 台</p>
                    </div>
                </div>
                
                <div class="data-integration">
                    <h3 style="margin-bottom: 1rem; color: var(--dark-color);">
                        <i class="fas fa-database"></i> 数据整合功能
                    </h3>
                    
                    <div class="form-group">
                        <label for="merge-user-id">合并其他用户ID的数据</label>
                        <input type="text" id="merge-user-id" placeholder="输入要合并的用户ID">
                        <small style="color: #6b7280; display: block; margin-top: 5px;">
                            输入其他用户ID，将其数据合并到当前数据中（用于整合不同用户的数据）
                        </small>
                    </div>
                    
                    <div class="user-id-actions">
                        <button id="merge-user-data" class="success">
                            <i class="fas fa-merge"></i> 合并用户数据
                        </button>
                        <button id="compare-user-data" class="secondary">
                            <i class="fas fa-balance-scale"></i> 比较用户数据
                        </button>
                        <button id="export-user-data" class="warning">
                            <i class="fas fa-download"></i> 导出当前用户数据
                        </button>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <p><strong>说明:</strong></p>
                        <ul style="padding-left: 1.5rem; margin-bottom: 1rem;">
                            <li><strong>设置用户ID</strong>: 在不同设备上使用相同的用户ID，可以实现数据自动同步</li>
                            <li><strong>合并用户数据</strong>: 将其他用户的数据合并到当前数据中，用于整合分析</li>
                            <li><strong>比较用户数据</strong>: 对比不同用户的数据统计信息</li>
                            <li><strong>导出用户数据</strong>: 导出当前用户的所有数据，包括配置和历史记录</li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; background-color: #f8fafc; padding: 1rem; border-radius: 8px;">
                    <h4><i class="fas fa-lightbulb"></i> 使用建议</h4>
                    <ul style="padding-left: 1.5rem; margin-top: 0.5rem;">
                        <li>在家庭、办公室等多台设备上使用相同的用户ID，实现数据自动同步</li>
                        <li>使用有意义的用户ID，如: user_home, user_office, user_beijing等</li>
                        <li>定期导出数据备份，以防数据丢失</li>
                        <li>合并多个用户数据时，系统会自动去重</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <span><i class="fas fa-chart-bar"></i> 用户数据统计</span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="total-users">1</div>
                        <div class="stat-label">用户总数</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="total-data-points">0</div>
                        <div class="stat-label">总数据点数</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avg-latency-all">--</div>
                        <div class="stat-label">平均延迟</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="data-coverage">0%</div>
                        <div class="stat-label">数据覆盖率</div>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem;">
                    <h4>用户数据列表</h4>
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>用户ID</th>
                                    <th>数据点数</th>
                                    <th>最后同步</th>
                                    <th>设备数量</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="user-data-list">
                                <tr>
                                    <td colspan="5" style="text-align: center;">暂无其他用户数据</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>两岸网络延迟监测工具 v1.3 | 支持自定义用户ID | 多设备数据同步 | 数据整合功能</p>
            <p>前端: GitHub Pages | 后端: Cloudflare Workers | 数据: 本地存储 + 云端备份 + 用户ID隔离</p>
            <p>注意: 使用相同的用户ID在不同设备上可以自动同步数据，支持合并不同用户的数据进行整合分析</p>
        </div>
    </div>

    <!-- 通知区域 -->
    <div id="notification-area"></div>

    <script>
        // 首先检查控制台是否可用，用于调试
        if (typeof console === 'undefined') {
            console = { log: function() {}, error: function() {} };
        }
        
        console.log("脚本开始加载...");

        // ==================== Cloudflare 配置 ====================
        const CLOUDFLARE_CONFIG = {
            // 你的 Cloudflare Worker URL - 已配置为你的地址
            WORKER_URL: 'https://latency-monitor-api.mgjack13.workers.dev',
            // API 端点
            ENDPOINTS: {
                SAVE: '/api/save',
                LOAD: '/api/load',
                TEST: '/api/test',
                USERS: '/api/users'  // 新增：获取用户列表
            },
            // 用户标识
            USER_ID: null,
            // 自动同步
            AUTO_SYNC: false,
            // 最后同步时间
            LAST_SYNC: null,
            // 用户配置
            USER_CONFIG: {}
        };

        // ==================== 全局变量和配置 ====================
        const config = {
            version: '1.3',
            testInterval: 60, // 默认60秒
            saveInterval: 1800, // 默认30分钟
            userLocation: '',
            defaultNodes: {
                mainland: 'cn_bj_cloud', // 默认大陆节点改为北京腾讯云
                taiwan: 'tw_nchc'        // 默认台湾节点改为台湾衫一号
            },
            // 预设节点 (使用真实IP地址)
            nodes: {
                // ========== 中国大陆节点 ==========
                'cn_bj_cloud': { name: '北京腾讯云节点', host: '49.232.189.68', location: 'mainland', type: 'ping' },
                'cn_sh_cloud': { name: '上海华为云节点', host: '115.120.57.115', location: 'mainland', type: 'ping' },
                'cn_gz_cloud': { name: '广州腾讯云节点', host: '118.89.54.198', location: 'mainland', type: 'ping' },
                'cn_cd_cloud': { name: '成都腾讯云节点', host: '162.14.73.100', location: 'mainland', type: 'ping' },
                'cn_nj_cloud': { name: '南京腾讯云节点', host: '1.13.17.91', location: 'mainland', type: 'ping' },
                // ========== 台湾地区节点 ==========
                'tw_nchc': { name: '台湾杉一号 (NCHC)', host: '140.110.148.11', location: 'taiwan', type: 'ping' },
                'tw_ttrc_dns1': { name: '台东区网DNS主节点', host: '163.28.180.1', location: 'taiwan', type: 'ping' },
                'tw_ttrc_dns2': { name: '台东区网DNS备节点', host: '163.28.179.41', location: 'taiwan', type: 'ping' },
                'tw_stdtime_ntp': { name: '台湾国家标准时间', host: '220.130.158.73', location: 'taiwan', type: 'ping' },
                'tw_tfn': { name: '台湾固网示例IP', host: '124.8.11.216', location: 'taiwan', type: 'ping' }
            },
            // 新增：用户ID配置
            userId: null,
            userIdType: 'random', // random, custom
            devices: []
        };

        // 默认节点配置 (用于重置功能)
        const defaultConfig = JSON.parse(JSON.stringify(config));

        // 应用状态
        const state = {
            monitoringActive: false,
            testTimer: null,
            saveTimer: null,
            nextTestTime: 0,
            nextSaveTime: 0,
            currentData: [],
            historyData: [],
            currentPage: 1,
            pageSize: 20,
            chart: null,
            periodChart: null,
            cloudflareConnected: false,
            autoSyncInterval: null,
            // 新增：用户管理相关状态
            userList: [],
            mergedData: [],
            currentUserId: null
        };

        // ==================== 基础工具函数 ====================

        // 显示通知
        function showNotification(message, type = 'info') {
            try {
                const notificationArea = document.getElementById('notification-area');
                if (!notificationArea) {
                    console.log(`通知: ${message} (${type})`);
                    return;
                }
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                let icon = 'info-circle';
                if (type === 'success') icon = 'check-circle';
                else if (type === 'error') icon = 'exclamation-circle';
                else if (type === 'warning') icon = 'exclamation-triangle';
                
                notification.innerHTML = `
                    <i class="fas fa-${icon}"></i>
                    <div>${message}</div>
                `;
                
                notificationArea.appendChild(notification);
                
                // 显示通知
                setTimeout(() => notification.classList.add('show'), 10);
                
                // 3秒后移除通知
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }, 3000);
            } catch (error) {
                console.error("显示通知时出错:", error);
                console.log(`通知(回退): ${message} (${type})`);
            }
        }

        // 获取延迟CSS类
        function getLatencyClass(latency, prefix = '') {
            if (latency < 50) return prefix + 'latency-good';
            if (latency < 100) return prefix + 'latency-medium';
            return prefix + 'latency-bad';
        }

        // 获取位置名称
        function getLocationName(locationId) {
            try {
                const select = document.getElementById('user-location');
                if (!select) return locationId;
                
                for (let option of select.options) {
                    if (option.value === locationId) {
                        return option.text;
                    }
                }
                return locationId;
            } catch (error) {
                console.error("获取位置名称时出错:", error);
                return locationId;
            }
        }

        // ==================== 用户ID管理函数 ====================

        // 初始化用户ID
        function initUserId() {
            let userId = localStorage.getItem('latency_monitor_user_id');
            let userIdType = localStorage.getItem('latency_monitor_user_id_type') || 'random';
            let devices = JSON.parse(localStorage.getItem('latency_monitor_devices') || '[]');
            
            if (!userId) {
                // 生成一个唯一的用户ID
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                userIdType = 'random';
                localStorage.setItem('latency_monitor_user_id', userId);
                localStorage.setItem('latency_monitor_user_id_type', userIdType);
            }
            
            // 记录当前设备
            const deviceId = getDeviceId();
            if (!devices.includes(deviceId)) {
                devices.push(deviceId);
                localStorage.setItem('latency_monitor_devices', JSON.stringify(devices));
            }
            
            config.userId = userId;
            config.userIdType = userIdType;
            config.devices = devices;
            
            CLOUDFLARE_CONFIG.USER_ID = userId;
            
            // 更新UI显示
            updateUserIdDisplay();
            
            return userId;
        }

        // 获取设备ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('latency_monitor_device_id');
            if (!deviceId) {
                // 生成设备ID
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('latency_monitor_device_id', deviceId);
            }
            return deviceId;
        }

        // 设置自定义用户ID
        function setCustomUserId() {
            const customUserIdInput = document.getElementById('custom-user-id');
            if (!customUserIdInput) return;
            
            const newUserId = customUserIdInput.value.trim();
            if (!newUserId) {
                showNotification('请输入自定义用户ID', 'error');
                return;
            }
            
            // 验证用户ID格式
            if (!/^[a-zA-Z0-9_-]{3,50}$/.test(newUserId)) {
                showNotification('用户ID格式错误: 只能包含字母、数字、下划线和连字符，长度3-50位', 'error');
                return;
            }
            
            if (newUserId === config.userId) {
                showNotification('用户ID未改变', 'info');
                return;
            }
            
            if (confirm(`确定要设置用户ID为 "${newUserId}" 吗？\n\n注意：更改用户ID将切换到新的数据空间，旧数据将无法直接访问。`)) {
                // 保存新的用户ID
                config.userId = newUserId;
                config.userIdType = 'custom';
                config.devices = [getDeviceId()];
                
                localStorage.setItem('latency_monitor_user_id', newUserId);
                localStorage.setItem('latency_monitor_user_id_type', 'custom');
                localStorage.setItem('latency_monitor_devices', JSON.stringify(config.devices));
                
                CLOUDFLARE_CONFIG.USER_ID = newUserId;
                
                // 更新UI
                updateUserIdDisplay();
                
                // 重置云端连接状态
                state.cloudflareConnected = false;
                
                showNotification(`用户ID已设置为: ${newUserId}`, 'success');
                
                // 清空输入框
                customUserIdInput.value = '';
            }
        }

        // 生成随机用户ID
        function generateRandomUserId() {
            const newUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const customUserIdInput = document.getElementById('custom-user-id');
            if (customUserIdInput) {
                customUserIdInput.value = newUserId;
                showNotification('已生成随机用户ID，点击"设置用户ID"按钮应用', 'info');
            }
        }

        // 重置用户ID为默认
        function resetUserId() {
            if (confirm('确定要重置用户ID吗？这将生成新的随机用户ID并切换到新的数据空间。')) {
                const newUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                config.userId = newUserId;
                config.userIdType = 'random';
                config.devices = [getDeviceId()];
                
                localStorage.setItem('latency_monitor_user_id', newUserId);
                localStorage.setItem('latency_monitor_user_id_type', 'random');
                localStorage.setItem('latency_monitor_devices', JSON.stringify(config.devices));
                
                CLOUDFLARE_CONFIG.USER_ID = newUserId;
                
                // 更新UI
                updateUserIdDisplay();
                
                // 重置云端连接状态
                state.cloudflareConnected = false;
                
                showNotification(`用户ID已重置为随机ID: ${newUserId}`, 'success');
                
                // 清空输入框
                const customUserIdInput = document.getElementById('custom-user-id');
                if (customUserIdInput) {
                    customUserIdInput.value = '';
                }
            }
        }

        // 更新用户ID显示
        function updateUserIdDisplay() {
            // 更新Cloudflare标签页的输入框
            const cloudflareUserIdInput = document.getElementById('cloudflare-user-id');
            if (cloudflareUserIdInput) {
                cloudflareUserIdInput.value = config.userId || '';
            }
            
            // 更新用户ID管理页面的显示
            const currentUserIdElement = document.getElementById('current-user-id');
            if (currentUserIdElement) {
                currentUserIdElement.textContent = config.userId || '未设置';
            }
            
            const userIdTypeElement = document.getElementById('user-id-type');
            if (userIdTypeElement) {
                userIdTypeElement.textContent = config.userIdType === 'custom' ? '自定义ID' : '随机ID';
            }
            
            const deviceCountElement = document.getElementById('device-count');
            if (deviceCountElement) {
                deviceCountElement.textContent = config.devices ? config.devices.length : 1;
            }
            
            const currentUserIdDisplay = document.getElementById('current-user-id-display');
            if (currentUserIdDisplay) {
                currentUserIdDisplay.textContent = config.userId || '未设置';
            }
        }

        // 保存用户ID (Cloudflare标签页)
        function saveUserId() {
            const userIdInput = document.getElementById('cloudflare-user-id');
            if (!userIdInput) return;
            
            const newUserId = userIdInput.value.trim();
            if (!newUserId) {
                showNotification('请输入用户ID', 'error');
                return;
            }
            
            if (newUserId === config.userId) {
                showNotification('用户ID未改变', 'info');
                return;
            }
            
            if (confirm(`确定要更改用户ID为 "${newUserId}" 吗？\n\n注意：更改用户ID将切换到新的数据空间。`)) {
                config.userId = newUserId;
                config.userIdType = 'custom';
                config.devices = [getDeviceId()];
                
                localStorage.setItem('latency_monitor_user_id', newUserId);
                localStorage.setItem('latency_monitor_user_id_type', 'custom');
                localStorage.setItem('latency_monitor_devices', JSON.stringify(config.devices));
                
                CLOUDFLARE_CONFIG.USER_ID = newUserId;
                
                // 更新UI
                updateUserIdDisplay();
                
                // 重置云端连接状态
                state.cloudflareConnected = false;
                
                showNotification(`用户ID已设置为: ${newUserId}`, 'success');
            }
        }

        // 生成新用户ID (Cloudflare标签页)
        function generateNewUserId() {
            const newUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const userIdInput = document.getElementById('cloudflare-user-id');
            if (userIdInput) {
                userIdInput.value = newUserId;
                showNotification('已生成新用户ID，请点击保存以应用', 'info');
            }
        }

        // ==================== 节点管理函数 ====================

        // 更新节点选择下拉框
        function updateNodeSelectOptions() {
            console.log("更新节点选择下拉框");
            try {
                const mainlandSelect = document.getElementById('default-mainland-node');
                const taiwanSelect = document.getElementById('default-taiwan-node');
                
                if (!mainlandSelect || !taiwanSelect) {
                    console.warn("找不到节点选择下拉框元素");
                    return;
                }
                
                // 清空现有选项
                mainlandSelect.innerHTML = '';
                taiwanSelect.innerHTML = '';
                
                // 添加大陆节点选项
                Object.keys(config.nodes).forEach(key => {
                    const node = config.nodes[key];
                    if (node.location === 'mainland') {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${node.name} (${node.host})`;
                        mainlandSelect.appendChild(option);
                    }
                });
                
                // 添加台湾节点选项
                Object.keys(config.nodes).forEach(key => {
                    const node = config.nodes[key];
                    if (node.location === 'taiwan') {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${node.name} (${node.host})`;
                        taiwanSelect.appendChild(option);
                    }
                });
                
                // 设置当前选择的节点
                mainlandSelect.value = config.defaultNodes.mainland;
                taiwanSelect.value = config.defaultNodes.taiwan;
                
                console.log("节点选择下拉框更新完成");
            } catch (error) {
                console.error("更新节点选择下拉框时出错:", error);
            }
        }

        // 渲染节点列表
        function renderNodesList() {
            try {
                const nodesList = document.getElementById('nodes-list');
                if (!nodesList) return;
                
                nodesList.innerHTML = '';
                
                Object.keys(config.nodes).forEach(key => {
                    const node = config.nodes[key];
                    const isDefaultMainland = key === config.defaultNodes.mainland;
                    const isDefaultTaiwan = key === config.defaultNodes.taiwan;
                    let badge = '';
                    
                    if (isDefaultMainland) badge = '<span style="background:#3b82f6;color:white;padding:2px 6px;border-radius:4px;font-size:0.8rem;margin-left:8px;">默认大陆</span>';
                    if (isDefaultTaiwan) badge = '<span style="background:#10b981;color:white;padding:2px 6px;border-radius:4px;font-size:0.8rem;margin-left:8px;">默认台湾</span>';
                    
                    const nodeCard = document.createElement('div');
                    nodeCard.className = 'node-card';
                    nodeCard.innerHTML = `
                        <div class="node-header">
                            <div class="node-name">${node.name} ${badge}</div>
                            <div class="node-location">${node.location === 'mainland' ? '中国大陆' : '台湾地区'}</div>
                        </div>
                        <p style="margin: 8px 0; color: #6b7280; font-size: 0.9rem;">主机: ${node.host}</p>
                        <div class="node-stats">
                            <div class="node-stat">
                                <div class="node-stat-value latency-good">--</div>
                                <div class="node-stat-label">平均延迟</div>
                            </div>
                            <div class="node-stat">
                                <div class="node-stat-value">--</div>
                                <div class="node-stat-label">最后测试</div>
                            </div>
                            <div class="node-stat">
                                <div class="node-stat-value">100%</div>
                                <div class="node-stat-label">可用性</div>
                            </div>
                        </div>
                    `;
                    
                    nodesList.appendChild(nodeCard);
                });
            } catch (error) {
                console.error("渲染节点列表时出错:", error);
            }
        }

        // 添加自定义节点
        function addCustomNode() {
            console.log("添加自定义节点");
            try {
                const nameInput = document.getElementById('node-name');
                const hostInput = document.getElementById('node-host');
                const locationSelect = document.getElementById('node-location');
                
                if (!nameInput || !hostInput || !locationSelect) {
                    showNotification('找不到表单元素', 'error');
                    return;
                }
                
                const name = nameInput.value.trim();
                const host = hostInput.value.trim();
                const location = locationSelect.value;
                
                if (!name || !host) {
                    showNotification('请填写节点名称和主机地址', 'error');
                    return;
                }
                
                // 生成唯一ID
                const nodeId = `custom_${Date.now()}`;
                
                // 添加到配置
                config.nodes[nodeId] = {
                    name,
                    host,
                    location,
                    type: 'custom'
                };
                
                // 保存配置
                saveConfig();
                
                // 重新渲染节点列表和下拉选项
                updateNodeSelectOptions();
                renderNodesList();
                
                // 清空表单
                nameInput.value = '';
                hostInput.value = '';
                
                showNotification(`节点 "${name}" 已添加`, 'success');
            } catch (error) {
                console.error("添加自定义节点时出错:", error);
                showNotification('添加节点失败: ' + error.message, 'error');
            }
        }

        // 保存节点设置
        function saveNodeSettings() {
            console.log("保存节点设置");
            try {
                const mainlandSelect = document.getElementById('default-mainland-node');
                const taiwanSelect = document.getElementById('default-taiwan-node');
                
                if (!mainlandSelect || !taiwanSelect) {
                    showNotification('找不到节点选择元素', 'error');
                    return;
                }
                
                config.defaultNodes.mainland = mainlandSelect.value;
                config.defaultNodes.taiwan = taiwanSelect.value;
                saveConfig();
                
                showNotification('节点设置已保存', 'success');
            } catch (error) {
                console.error("保存节点设置时出错:", error);
                showNotification('保存节点设置失败: ' + error.message, 'error');
            }
        }

        // ==================== 数据管理函数 ====================

        // 加载配置
        function loadConfig() {
            console.log("加载配置");
            try {
                const savedConfig = localStorage.getItem('latencyMonitorConfig');
                if (savedConfig) {
                    const parsed = JSON.parse(savedConfig);
                    
                    // 合并配置，确保新版本添加的节点不会被覆盖
                    if (parsed.nodes) {
                        // 保留现有的自定义节点，合并默认节点
                        const mergedNodes = {...config.nodes, ...parsed.nodes};
                        parsed.nodes = mergedNodes;
                    }
                    
                    Object.assign(config, parsed);
                    
                    // 更新UI
                    if (config.userLocation) {
                        document.getElementById('user-location').value = config.userLocation;
                        updateUserLocationDisplay();
                    }
                    document.getElementById('test-interval').value = config.testInterval;
                    document.getElementById('save-interval').value = config.saveInterval;
                }
                
                // 更新节点选择下拉框
                updateNodeSelectOptions();
                
                // 更新用户ID显示
                updateUserIdDisplay();
            } catch (error) {
                console.error("加载配置时出错:", error);
                showNotification('加载配置失败，使用默认配置', 'warning');
            }
        }

        // 保存配置
        function saveConfig() {
            try {
                localStorage.setItem('latencyMonitorConfig', JSON.stringify(config));
                console.log("配置已保存到本地");
                
                // 如果 Cloudflare 已连接且自动同步开启，保存到云端
                if (state.cloudflareConnected && CLOUDFLARE_CONFIG.AUTO_SYNC) {
                    saveToCloudflare('config', config).catch(error => {
                        console.warn('云端保存配置失败:', error);
                    });
                }
            } catch (error) {
                console.error("保存配置时出错:", error);
                showNotification('保存配置失败', 'error');
            }
        }

        // 加载历史数据
        function loadHistoryData() {
            console.log("加载历史数据");
            try {
                const savedHistory = localStorage.getItem('latencyHistory');
                if (savedHistory) {
                    state.historyData = JSON.parse(savedHistory);
                    updateDataCounts();
                    renderHistoryTable();
                    updateChart();
                    updateUserDataStats();
                }
            } catch (error) {
                console.error("加载历史数据时出错:", error);
                showNotification('加载历史数据失败', 'error');
            }
        }

        // 保存历史数据
        function saveHistoryData() {
            try {
                localStorage.setItem('latencyHistory', JSON.stringify(state.historyData));
                console.log("历史数据已保存到本地");
                
                // 如果 Cloudflare 已连接且自动同步开启，保存最近100条到云端
                if (state.cloudflareConnected && CLOUDFLARE_CONFIG.AUTO_SYNC && state.historyData.length > 0) {
                    const recentData = state.historyData.slice(-100);
                    saveToCloudflare('history', recentData).catch(error => {
                        console.warn('云端保存历史数据失败:', error);
                    });
                }
                
                // 更新用户数据统计
                updateUserDataStats();
            } catch (error) {
                console.error("保存历史数据时出错:", error);
                showNotification('保存历史数据失败', 'error');
            }
        }

        // 更新用户位置显示
        function updateUserLocationDisplay() {
            try {
                const locationSelect = document.getElementById('user-location');
                const selectedOption = locationSelect.options[locationSelect.selectedIndex];
                const locationText = selectedOption.text;
                const userLocationDisplay = document.getElementById('user-location-display');
                if (userLocationDisplay) {
                    userLocationDisplay.textContent = locationText;
                }
            } catch (error) {
                console.error("更新用户位置显示时出错:", error);
            }
        }

        // 更新数据计数
        function updateDataCounts() {
            try {
                // 今日测试次数
                const today = new Date().toDateString();
                const todayTests = state.historyData.filter(item => {
                    const testDate = new Date(item.timestamp).toDateString();
                    return testDate === today;
                }).length;
                
                const testsCountElement = document.getElementById('tests-count');
                const dataPointsElement = document.getElementById('data-points');
                
                if (testsCountElement) testsCountElement.textContent = todayTests;
                if (dataPointsElement) dataPointsElement.textContent = state.historyData.length;
                
                // 更新云端数据状态
                updateCloudDataStatus();
            } catch (error) {
                console.error("更新数据计数时出错:", error);
            }
        }

        // ==================== 数据导出/导入函数 ====================

        // 导出JSON数据
        function exportJSON() {
            try {
                const exportData = {
                    version: config.version,
                    exportTime: new Date().toISOString(),
                    data: state.historyData,
                    nodes: config.nodes,
                    config: config
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileName = `latency-data-${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                showNotification('数据已导出为JSON文件', 'success');
            } catch (error) {
                console.error("导出JSON时出错:", error);
                showNotification('导出JSON失败: ' + error.message, 'error');
            }
        }

        // 导出CSV数据
        function exportCSV() {
            try {
                if (state.historyData.length === 0) {
                    showNotification('没有数据可导出', 'warning');
                    return;
                }
                
                // CSV标题
                let csv = '时间戳,用户位置,大陆节点,大陆延迟(ms),台湾节点,台湾延迟(ms),时段\n';
                
                // 添加数据行
                state.historyData.forEach(item => {
                    const row = [
                        item.timestamp,
                        item.userLocation,
                        item.mainlandNode,
                        item.mainlandLatency,
                        item.taiwanNode,
                        item.taiwanLatency,
                        item.period
                    ];
                    
                    // 转义CSV中的特殊字符
                    const escapedRow = row.map(cell => {
                        if (cell === null || cell === undefined) return '';
                        const cellStr = String(cell);
                        // 如果单元格包含逗号、引号或换行，需要用引号包围并转义引号
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return '"' + cellStr.replace(/"/g, '""') + '"';
                        }
                        return cellStr;
                    });
                    
                    csv += escapedRow.join(',') + '\n';
                });
                
                const dataUri = 'data:text/csv;charset=utf-8,'+ encodeURIComponent(csv);
                const exportFileName = `latency-data-${new Date().toISOString().slice(0,10)}.csv`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                showNotification('数据已导出为CSV文件', 'success');
            } catch (error) {
                console.error("导出CSV时出错:", error);
                showNotification('导出CSV失败: ' + error.message, 'error');
            }
        }

        // 导出节点列表
        function exportNodes() {
            try {
                const exportData = {
                    version: config.version,
                    exportTime: new Date().toISOString(),
                    nodes: config.nodes
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileName = `latency-nodes-${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                showNotification('节点列表已导出', 'success');
            } catch (error) {
                console.error("导出节点列表时出错:", error);
                showNotification('导出节点列表失败: ' + error.message, 'error');
            }
        }

        // 上传节点列表
        function uploadNodes() {
            const fileInput = document.getElementById('upload-nodes-file');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showNotification('请先选择要上传的文件', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const data = JSON.parse(content);
                    
                    if (!data.nodes || typeof data.nodes !== 'object') {
                        showNotification('文件格式错误：缺少节点数据', 'error');
                        return;
                    }
                    
                    if (confirm(`确定要更新节点列表吗？这将替换现有的 ${Object.keys(config.nodes).length} 个节点。`)) {
                        // 更新节点配置
                        config.nodes = data.nodes;
                        saveConfig();
                        
                        // 更新UI
                        updateNodeSelectOptions();
                        renderNodesList();
                        
                        // 清空文件输入
                        fileInput.value = '';
                        
                        showNotification(`节点列表已更新，共 ${Object.keys(config.nodes).length} 个节点`, 'success');
                    }
                } catch (error) {
                    console.error("解析节点文件时出错:", error);
                    showNotification('文件解析失败: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('读取文件失败', 'error');
            };
            
            reader.readAsText(file);
        }

        // 重置节点
        function resetNodes() {
            if (confirm('确定要重置节点列表吗？这将恢复为默认节点，自定义节点将丢失。')) {
                // 恢复默认配置中的节点
                config.nodes = JSON.parse(JSON.stringify(defaultConfig.nodes));
                saveConfig();
                
                // 更新UI
                updateNodeSelectOptions();
                renderNodesList();
                
                showNotification('节点列表已重置为默认节点', 'success');
            }
        }

        // 导入数据
        function importData() {
            const fileInput = document.getElementById('import-file');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showNotification('请先选择要导入的文件', 'error');
                return;
            }
            
            const files = Array.from(fileInput.files);
            let importedCount = 0;
            let errorCount = 0;
            
            // 处理每个文件
            files.forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        let data;
                        
                        // 根据文件类型解析
                        if (file.name.endsWith('.json')) {
                            data = JSON.parse(content);
                        } else if (file.name.endsWith('.csv')) {
                            data = parseCSV(content);
                        } else {
                            errorCount++;
                            showNotification(`文件 ${file.name} 格式不支持`, 'error');
                            return;
                        }
                        
                        // 处理导入的数据
                        const importResult = processImportedData(data);
                        importedCount += importResult.count;
                        
                        if (index === files.length - 1) {
                            // 最后一个文件处理完成
                            if (importedCount > 0) {
                                // 保存数据并更新UI
                                saveHistoryData();
                                renderHistoryTable();
                                updateChart();
                                updateDataCounts();
                                
                                showNotification(`导入完成！成功导入 ${importedCount} 条记录，${errorCount} 个文件失败`, 'success');
                            } else {
                                showNotification('没有导入新数据，可能是重复数据', 'info');
                            }
                            
                            // 清空文件输入
                            fileInput.value = '';
                        }
                    } catch (error) {
                        console.error(`导入文件 ${file.name} 时出错:`, error);
                        errorCount++;
                        showNotification(`导入文件 ${file.name} 失败: ${error.message}`, 'error');
                    }
                };
                
                reader.onerror = function() {
                    errorCount++;
                    showNotification(`读取文件 ${file.name} 失败`, 'error');
                };
                
                reader.readAsText(file);
            });
        }

        // 解析CSV内容
        function parseCSV(content) {
            const lines = content.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = [];
                let inQuotes = false;
                let currentValue = '';
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentValue);
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                
                values.push(currentValue); // 最后一个值
                
                if (values.length !== headers.length) {
                    console.warn(`CSV行 ${i} 列数不匹配，跳过`);
                    continue;
                }
                
                const row = {};
                for (let j = 0; j < headers.length; j++) {
                    let value = values[j];
                    // 去除可能的引号
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1).replace(/""/g, '"');
                    }
                    
                    // 尝试转换为数字
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue) && value.trim() !== '') {
                        row[headers[j]] = numValue;
                    } else {
                        row[headers[j]] = value;
                    }
                }
                
                data.push(row);
            }
            
            return data;
        }

        // 处理导入的数据
        function processImportedData(data) {
            let importedCount = 0;
            
            // 检查数据格式
            if (Array.isArray(data)) {
                // 如果是数组，直接处理
                data.forEach(item => {
                    if (isValidDataItem(item)) {
                        // 检查是否已存在（基于时间戳）
                        const exists = state.historyData.some(existing => 
                            existing.timestamp === item.timestamp && 
                            existing.userLocation === item.userLocation
                        );
                        
                        if (!exists) {
                            state.historyData.push(item);
                            importedCount++;
                        }
                    }
                });
            } else if (data.data && Array.isArray(data.data)) {
                // 如果是导出格式，处理data字段
                data.data.forEach(item => {
                    if (isValidDataItem(item)) {
                        const exists = state.historyData.some(existing => 
                            existing.timestamp === item.timestamp && 
                            existing.userLocation === item.userLocation
                        );
                        
                        if (!exists) {
                            state.historyData.push(item);
                            importedCount++;
                        }
                    }
                });
            } else {
                throw new Error('不支持的导入格式');
            }
            
            // 按时间戳排序
            if (importedCount > 0) {
                state.historyData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            }
            
            return { count: importedCount };
        }

        // 验证数据项是否有效
        function isValidDataItem(item) {
            return (
                item &&
                typeof item === 'object' &&
                item.timestamp &&
                item.userLocation &&
                (item.mainlandLatency !== undefined || item.taiwanLatency !== undefined)
            );
        }

        // 清除导入
        function clearImport() {
            const fileInput = document.getElementById('import-file');
            if (fileInput) {
                fileInput.value = '';
                showNotification('已清除选择的文件', 'info');
            }
        }

        // ==================== 图表函数 ====================

        // 初始化图表
        function initCharts() {
            console.log("初始化图表");
            try {
                const ctx = document.getElementById('latencyChart');
                if (!ctx) {
                    throw new Error('找不到图表Canvas元素');
                }
                
                state.chart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: '大陆节点延迟',
                                data: [],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: '台湾节点延迟',
                                data: [],
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '时间'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '延迟 (ms)'
                                },
                                beginAtZero: true
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'nearest'
                        }
                    }
                });
                
                // 初始化时段分析图表
                const periodCtx = document.getElementById('periodAnalysisChart');
                if (periodCtx) {
                    state.periodChart = new Chart(periodCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['尖峰时段', '离峰时段', '平峰时段'],
                            datasets: [
                                {
                                    label: '平均延迟 (ms)',
                                    data: [0, 0, 0],
                                    backgroundColor: [
                                        'rgba(239, 68, 68, 0.7)',
                                        'rgba(16, 185, 129, 0.7)',
                                        'rgba(59, 130, 246, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgb(239, 68, 68)',
                                        'rgb(16, 185, 129)',
                                        'rgb(59, 130, 246)'
                                    ],
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: '延迟 (ms)'
                                    }
                                }
                            }
                        }
                    });
                }
                console.log("图表初始化完成");
            } catch (error) {
                console.error("初始化图表时出错:", error);
                showNotification('初始化图表失败', 'error');
            }
        }

        // 更新图表
        function updateChart() {
            if (!state.chart) return;
            
            try {
                const periodSelect = document.getElementById('chart-period');
                const period = periodSelect ? periodSelect.value : '24h';
                
                let filteredData = [];
                const now = new Date();
                
                // 根据选择的时间范围过滤数据
                switch (period) {
                    case '24h':
                        const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                        filteredData = state.historyData.filter(item => new Date(item.timestamp) > oneDayAgo);
                        break;
                    case '7d':
                        const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        filteredData = state.historyData.filter(item => new Date(item.timestamp) > sevenDaysAgo);
                        break;
                    case '30d':
                        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        filteredData = state.historyData.filter(item => new Date(item.timestamp) > thirtyDaysAgo);
                        break;
                    case '90d':
                        const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                        filteredData = state.historyData.filter(item => new Date(item.timestamp) > ninetyDaysAgo);
                        break;
                    default:
                        filteredData = state.historyData.slice(-50); // 默认显示最近50条
                }
                
                // 限制数据点数量，避免图表过于密集
                if (filteredData.length > 100) {
                    const step = Math.ceil(filteredData.length / 100);
                    filteredData = filteredData.filter((_, index) => index % step === 0);
                }
                
                // 更新图表数据
                const labels = filteredData.map(item => {
                    const date = new Date(item.timestamp);
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                });
                
                const mainlandData = filteredData.map(item => item.mainlandLatency);
                const taiwanData = filteredData.map(item => item.taiwanLatency);
                
                state.chart.data.labels = labels;
                state.chart.data.datasets[0].data = mainlandData;
                state.chart.data.datasets[1].data = taiwanData;
                state.chart.update();
                
                // 更新统计分析
                runAnalysis();
            } catch (error) {
                console.error("更新图表时出错:", error);
            }
        }

        // ==================== 历史数据管理函数 ====================

        // 渲染历史数据表格
        function renderHistoryTable() {
            try {
                const tbody = document.getElementById('history-data');
                if (!tbody) return;
                
                const startIndex = (state.currentPage - 1) * state.pageSize;
                const endIndex = startIndex + state.pageSize;
                const pageData = state.historyData.slice(startIndex, endIndex);
                
                tbody.innerHTML = '';
                
                if (pageData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="8" style="text-align: center;">暂无历史数据</td>';
                    tbody.appendChild(row);
                } else {
                    pageData.forEach(item => {
                        const date = new Date(item.timestamp);
                        const timeString = date.toLocaleString('zh-CN');
                        const mainlandNode = config.nodes[item.mainlandNode]?.name || item.mainlandNode;
                        const taiwanNode = config.nodes[item.taiwanNode]?.name || item.taiwanNode;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${timeString}</td>
                            <td>${getLocationName(item.userLocation)}</td>
                            <td>${mainlandNode}</td>
                            <td><span class="${getLatencyClass(item.mainlandLatency)}">${item.mainlandLatency} ms</span></td>
                            <td>${taiwanNode}</td>
                            <td><span class="${getLatencyClass(item.taiwanLatency)}">${item.taiwanLatency} ms</span></td>
                            <td>${item.period}</td>
                            <td>
                                <button class="secondary" onclick="window.deleteHistoryItem('${item.timestamp}')" style="padding: 4px 8px; font-size: 0.9rem;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                
                // 更新分页信息
                const currentPageElement = document.getElementById('current-page');
                const totalPagesElement = document.getElementById('total-pages');
                const prevPageBtn = document.getElementById('prev-page');
                const nextPageBtn = document.getElementById('next-page');
                
                if (currentPageElement) currentPageElement.textContent = state.currentPage;
                if (totalPagesElement) totalPagesElement.textContent = Math.ceil(state.historyData.length / state.pageSize);
                
                // 更新分页按钮状态
                if (prevPageBtn) prevPageBtn.disabled = state.currentPage <= 1;
                if (nextPageBtn) nextPageBtn.disabled = state.currentPage >= Math.ceil(state.historyData.length / state.pageSize);
            } catch (error) {
                console.error("渲染历史数据表格时出错:", error);
            }
        }

        // 删除历史项目
        window.deleteHistoryItem = function(timestamp) {
            if (confirm('确定要删除这条记录吗？')) {
                try {
                    state.historyData = state.historyData.filter(item => item.timestamp !== timestamp);
                    saveHistoryData();
                    renderHistoryTable();
                    updateDataCounts();
                    updateChart();
                    showNotification('记录已删除', 'success');
                } catch (error) {
                    console.error("删除历史项目时出错:", error);
                    showNotification('删除记录失败: ' + error.message, 'error');
                }
            }
        };

        // 上一页
        function prevPage() {
            if (state.currentPage > 1) {
                state.currentPage--;
                renderHistoryTable();
            }
        }

        // 下一页
        function nextPage() {
            const totalPages = Math.ceil(state.historyData.length / state.pageSize);
            if (state.currentPage < totalPages) {
                state.currentPage++;
                renderHistoryTable();
            }
        }

        // 清除历史
        function clearHistory() {
            if (confirm('确定要清除所有历史数据吗？此操作不可恢复。')) {
                try {
                    state.historyData = [];
                    saveHistoryData();
                    renderHistoryTable();
                    updateDataCounts();
                    updateChart();
                    showNotification('历史数据已清除', 'success');
                } catch (error) {
                    console.error("清除历史时出错:", error);
                    showNotification('清除历史数据失败: ' + error.message, 'error');
                }
            }
        }

        // ==================== 监控函数 ====================

        // 更新当前时间
        function updateCurrentTime() {
            try {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN');
                const currentTimeElement = document.getElementById('current-time');
                if (currentTimeElement) {
                    currentTimeElement.textContent = timeString;
                }
                
                // 更新时段显示
                updatePeriodDisplay(now);
            } catch (error) {
                console.error("更新当前时间时出错:", error);
            }
        }

        // 更新时段显示
        function updatePeriodDisplay(date) {
            try {
                const hour = date.getHours();
                let period, className, suggestion;
                
                if ((hour >= 19 && hour < 23) || (hour >= 12 && hour < 14) || (hour >= 7 && hour < 9)) {
                    period = '尖峰时段';
                    className = 'peak-period';
                    suggestion = '网络繁忙，延迟可能较高';
                } else if (hour >= 1 && hour < 6) {
                    period = '离峰时段';
                    className = 'offpeak-period';
                    suggestion = '网络空闲，适合大文件传输';
                } else {
                    period = '平峰时段';
                    className = 'offpeak-period';
                    suggestion = '网络状况正常';
                }
                
                const periodElement = document.getElementById('time-period');
                if (periodElement) {
                    periodElement.textContent = period;
                    periodElement.className = `time-period-indicator ${className}`;
                }
                
                const suggestionElement = document.getElementById('period-suggestion');
                if (suggestionElement) {
                    suggestionElement.textContent = suggestion;
                }
                
                return period;
            } catch (error) {
                console.error("更新时段显示时出错:", error);
                return '未知时段';
            }
        }

        // 更新计时器显示
        function updateTimerDisplays() {
            try {
                if (state.monitoringActive) {
                    const now = Math.floor(Date.now() / 1000);
                    
                    // 下次测试倒计时
                    if (state.nextTestTime > now) {
                        const diff = state.nextTestTime - now;
                        const minutes = Math.floor(diff / 60);
                        const seconds = diff % 60;
                        const nextTestTimerElement = document.getElementById('next-test-timer');
                        if (nextTestTimerElement) {
                            nextTestTimerElement.textContent = 
                                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        }
                    }
                    
                    // 下次保存倒计时
                    if (state.nextSaveTime > now) {
                        const diff = state.nextSaveTime - now;
                        const minutes = Math.floor(diff / 60);
                        const seconds = diff % 60;
                        const nextSaveTimerElement = document.getElementById('next-save-timer');
                        if (nextSaveTimerElement) {
                            nextSaveTimerElement.textContent = 
                                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        }
                    }
                } else {
                    const nextTestTimerElement = document.getElementById('next-test-timer');
                    const nextSaveTimerElement = document.getElementById('next-save-timer');
                    if (nextTestTimerElement) nextTestTimerElement.textContent = '--:--';
                    if (nextSaveTimerElement) nextSaveTimerElement.textContent = '--:--';
                }
            } catch (error) {
                console.error("更新计时器显示时出错:", error);
            }
        }

        // 保存用户位置
        function saveUserLocation() {
            console.log("保存用户位置");
            try {
                const locationSelect = document.getElementById('user-location');
                if (!locationSelect) {
                    showNotification('找不到位置选择元素', 'error');
                    return;
                }
                
                const location = locationSelect.value;
                if (!location) {
                    showNotification('请先选择您的位置', 'error');
                    return;
                }
                
                config.userLocation = location;
                saveConfig();
                updateUserLocationDisplay();
                showNotification('位置设置已保存', 'success');
            } catch (error) {
                console.error("保存用户位置时出错:", error);
                showNotification('保存位置失败: ' + error.message, 'error');
            }
        }

        // 开始监控
        function startMonitoring() {
            console.log("开始监控");
            try {
                if (!config.userLocation) {
                    showNotification('请先设置您的位置', 'error');
                    return;
                }
                
                if (state.monitoringActive) {
                    showNotification('监控已在运行中', 'warning');
                    return;
                }
                
                state.monitoringActive = true;
                config.testInterval = parseInt(document.getElementById('test-interval').value) || 60;
                config.saveInterval = parseInt(document.getElementById('save-interval').value) || 1800;
                saveConfig();
                
                // 设置定时器
                scheduleNextTest();
                scheduleNextSave();
                
                // 立即执行一次测试
                performTest(false);
                
                const monitoringStatusElement = document.getElementById('monitoring-status');
                if (monitoringStatusElement) {
                    monitoringStatusElement.textContent = '运行中';
                    monitoringStatusElement.className = 'latency-good';
                }
                
                showNotification('网络监控已启动', 'success');
            } catch (error) {
                console.error("开始监控时出错:", error);
                showNotification('启动监控失败: ' + error.message, 'error');
                state.monitoringActive = false;
            }
        }

        // 停止监控
        function stopMonitoring() {
            console.log("停止监控");
            try {
                if (!state.monitoringActive) {
                    showNotification('监控未运行', 'warning');
                    return;
                }
                
                state.monitoringActive = false;
                
                if (state.testTimer) {
                    clearTimeout(state.testTimer);
                    state.testTimer = null;
                }
                
                if (state.saveTimer) {
                    clearTimeout(state.saveTimer);
                    state.saveTimer = null;
                }
                
                const monitoringStatusElement = document.getElementById('monitoring-status');
                if (monitoringStatusElement) {
                    monitoringStatusElement.textContent = '已停止';
                    monitoringStatusElement.className = 'latency-bad';
                }
                
                const nextTestTimerElement = document.getElementById('next-test-timer');
                const nextSaveTimerElement = document.getElementById('next-save-timer');
                if (nextTestTimerElement) nextTestTimerElement.textContent = '--:--';
                if (nextSaveTimerElement) nextSaveTimerElement.textContent = '--:--';
                
                showNotification('网络监控已停止', 'info');
            } catch (error) {
                console.error("停止监控时出错:", error);
                showNotification('停止监控失败: ' + error.message, 'error');
            }
        }

        // 安排下次测试
        function scheduleNextTest() {
            if (!state.monitoringActive) return;
            
            if (state.testTimer) {
                clearTimeout(state.testTimer);
            }
            
            state.nextTestTime = Math.floor(Date.now() / 1000) + config.testInterval;
            
            state.testTimer = setTimeout(() => {
                performTest(false);
                scheduleNextTest();
            }, config.testInterval * 1000);
        }

        // 安排下次保存
        function scheduleNextSave() {
            if (!state.monitoringActive) return;
            
            if (state.saveTimer) {
                clearTimeout(state.saveTimer);
            }
            
            state.nextSaveTime = Math.floor(Date.now() / 1000) + config.saveInterval;
            
            state.saveTimer = setTimeout(() => {
                autoSaveData();
                scheduleNextSave();
            }, config.saveInterval * 1000);
        }

        // 执行网络测试
        async function performTest(onlyRegion = false) {
            console.log("执行网络测试，区域限制:", onlyRegion);
            if (!config.userLocation) {
                showNotification('请先设置您的位置', 'error');
                return;
            }
            
            // 显示测试中状态
            const testButton = document.getElementById('test-now');
            let originalText = '';
            if (testButton) {
                originalText = testButton.innerHTML;
                testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
                testButton.disabled = true;
            }
            
            try {
                let mainlandLatency = null;
                let taiwanLatency = null;
                
                // 测试大陆节点
                if (!onlyRegion || onlyRegion === 'mainland') {
                    const mainlandNode = config.nodes[config.defaultNodes.mainland];
                    if (mainlandNode) {
                        mainlandLatency = await testNodeLatency(mainlandNode);
                    }
                }
                
                // 测试台湾节点
                if (!onlyRegion || onlyRegion === 'taiwan') {
                    const taiwanNode = config.nodes[config.defaultNodes.taiwan];
                    if (taiwanNode) {
                        taiwanLatency = await testNodeLatency(taiwanNode);
                    }
                }
                
                // 保存测试结果
                saveTestResult(mainlandLatency, taiwanLatency);
                
                // 更新UI
                updateCurrentLatencyDisplay(mainlandLatency, taiwanLatency);
                updateRecentTestsTable(mainlandLatency, taiwanLatency);
                
                showNotification('网络测试完成', 'success');
            } catch (error) {
                console.error('测试失败:', error);
                showNotification('测试失败: ' + error.message, 'error');
            } finally {
                // 恢复按钮状态
                if (testButton) {
                    testButton.innerHTML = originalText || '<i class="fas fa-sync-alt"></i> 立即测试';
                    testButton.disabled = false;
                }
            }
        }

        // 测试节点延迟 (使用真实HTTP请求测试)
        async function testNodeLatency(node) {
            if (!node) return null;
            
            // 由于浏览器安全限制，无法直接ping，所以使用HTTP请求模拟
            // 注意：部分IP可能不支持HTTP访问或返回错误
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                const testUrl = `http://${node.host}`;
                
                // 创建一个Image对象来测试连接
                const img = new Image();
                let timeoutId;
                
                img.onload = function() {
                    clearTimeout(timeoutId);
                    const latency = Date.now() - startTime;
                    console.log(`节点 ${node.host} 测试成功，延迟: ${latency}ms`);
                    resolve(latency);
                };
                
                img.onerror = function() {
                    clearTimeout(timeoutId);
                    // 如果图片加载失败，尝试其他方法
                    // 这里我们使用一个备用方案：XMLHttpRequest
                    const xhrStartTime = Date.now();
                    const xhr = new XMLHttpRequest();
                    
                    xhr.open('HEAD', testUrl);
                    xhr.timeout = 5000;
                    
                    xhr.onload = function() {
                        const latency = Date.now() - xhrStartTime;
                        if (xhr.status === 200 || xhr.status === 304) {
                            console.log(`节点 ${node.host} HTTP测试成功，延迟: ${latency}ms`);
                            resolve(latency);
                        } else {
                            // 返回模拟延迟（避免完全失败）
                            const simulatedLatency = Math.floor(Math.random() * 150) + 50;
                            console.log(`节点 ${node.host} HTTP返回状态 ${xhr.status}，使用模拟延迟: ${simulatedLatency}ms`);
                            resolve(simulatedLatency);
                        }
                    };
                    
                    xhr.onerror = function() {
                        // 最终备用：返回模拟数据
                        const simulatedLatency = Math.floor(Math.random() * 200) + 50;
                        console.log(`节点 ${node.host} HTTP请求失败，使用模拟延迟: ${simulatedLatency}ms`);
                        resolve(simulatedLatency);
                    };
                    
                    xhr.ontimeout = function() {
                        console.log(`节点 ${node.host} 请求超时`);
                        resolve(500); // 超时返回较高延迟
                    };
                    
                    try {
                        xhr.send();
                    } catch (e) {
                        // 如果所有方法都失败，返回模拟延迟
                        const simulatedLatency = Math.floor(Math.random() * 250) + 50;
                        console.log(`节点 ${node.host} 请求异常，使用模拟延迟: ${simulatedLatency}ms`);
                        resolve(simulatedLatency);
                    }
                };
                
                // 设置超时
                timeoutId = setTimeout(() => {
                    img.src = ''; // 取消加载
                    console.log(`节点 ${node.host} 图片加载超时`);
                    resolve(500); // 超时返回较高延迟
                }, 5000);
                
                // 开始测试
                img.src = testUrl + '?t=' + Date.now();
            });
        }

        // 保存测试结果
        function saveTestResult(mainlandLatency, taiwanLatency) {
            try {
                const now = new Date();
                const timestamp = now.toISOString();
                const period = updatePeriodDisplay(now);
                
                const testResult = {
                    timestamp,
                    userLocation: config.userLocation,
                    mainlandNode: config.defaultNodes.mainland,
                    mainlandLatency,
                    taiwanNode: config.defaultNodes.taiwan,
                    taiwanLatency,
                    period
                };
                
                // 添加到当前数据
                state.currentData.push(testResult);
                
                // 添加到历史数据
                state.historyData.push(testResult);
                
                // 限制历史数据大小
                if (state.historyData.length > 10000) {
                    state.historyData = state.historyData.slice(-8000);
                }
                
                // 保存到本地存储
                saveHistoryData();
                
                // 更新UI
                updateDataCounts();
                updateChart();
                
                // 更新最近测试表格
                updateRecentTestsTable(mainlandLatency, taiwanLatency);
                
                console.log("测试结果已保存");
            } catch (error) {
                console.error("保存测试结果时出错:", error);
            }
        }

        // 自动保存数据
        function autoSaveData() {
            // 这里我们已经实时保存了，所以只需要显示通知
            saveHistoryData();
            showNotification('数据已自动保存', 'info');
        }

        // 更新当前延迟显示
        function updateCurrentLatencyDisplay(mainlandLatency, taiwanLatency) {
            try {
                if (mainlandLatency !== null) {
                    const mainlandElement = document.getElementById('current-mainland-latency');
                    if (mainlandElement) {
                        mainlandElement.textContent = `${mainlandLatency} ms`;
                        mainlandElement.className = getLatencyClass(mainlandLatency, 'stat-value ');
                    }
                }
                
                if (taiwanLatency !== null) {
                    const taiwanElement = document.getElementById('current-taiwan-latency');
                    if (taiwanElement) {
                        taiwanElement.textContent = `${taiwanLatency} ms`;
                        taiwanElement.className = getLatencyClass(taiwanLatency, 'stat-value ');
                    }
                }
                
                // 更新网络质量
                updateNetworkQuality(mainlandLatency, taiwanLatency);
            } catch (error) {
                console.error("更新当前延迟显示时出错:", error);
            }
        }

        // 更新网络质量显示
        function updateNetworkQuality(mainlandLatency, taiwanLatency) {
            try {
                let quality = '未知';
                let className = '';
                
                if (mainlandLatency !== null && taiwanLatency !== null) {
                    const avgLatency = (mainlandLatency + taiwanLatency) / 2;
                    
                    if (avgLatency < 60) {
                        quality = '优秀';
                        className = 'latency-good';
                    } else if (avgLatency < 120) {
                        quality = '良好';
                        className = 'latency-medium';
                    } else if (avgLatency < 200) {
                        quality = '一般';
                        className = 'latency-medium';
                    } else {
                        quality = '较差';
                        className = 'latency-bad';
                    }
                }
                
                const qualityElement = document.getElementById('network-quality');
                if (qualityElement) {
                    qualityElement.textContent = quality;
                    qualityElement.className = className;
                }
            } catch (error) {
                console.error("更新网络质量显示时出错:", error);
            }
        }

        // 更新最近测试表格
        function updateRecentTestsTable(mainlandLatency, taiwanLatency) {
            try {
                const tbody = document.getElementById('recent-tests');
                if (!tbody) return;
                
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN');
                
                // 状态指示器
                let status = '<span class="status-indicator status-online"></span>正常';
                if (mainlandLatency > 200 || taiwanLatency > 200) {
                    status = '<span class="status-indicator status-warning"></span>延迟较高';
                } else if (mainlandLatency === null || taiwanLatency === null) {
                    status = '<span class="status-indicator status-offline"></span>部分失败';
                }
                
                // 创建新行
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${timeString}</td>
                    <td>${mainlandLatency !== null ? mainlandLatency + ' ms' : '--'}</td>
                    <td>${taiwanLatency !== null ? taiwanLatency + ' ms' : '--'}</td>
                    <td>${status}</td>
                `;
                
                // 插入到表格顶部
                if (tbody.firstChild && tbody.firstChild.textContent.includes('暂无测试数据')) {
                    tbody.removeChild(tbody.firstChild);
                }
                
                tbody.insertBefore(newRow, tbody.firstChild);
                
                // 限制只显示最近10条
                while (tbody.children.length > 10) {
                    tbody.removeChild(tbody.lastChild);
                }
            } catch (error) {
                console.error("更新最近测试表格时出错:", error);
            }
        }

        // ==================== 数据分析函数 ====================

        // 运行数据分析
        function runAnalysis() {
            console.log("运行数据分析");
            try {
                if (state.historyData.length === 0) {
                    showNotification('没有数据可分析', 'warning');
                    return;
                }
                
                // 分离不同时段的数据
                const peakData = state.historyData.filter(item => item.period === '尖峰时段');
                const offPeakData = state.historyData.filter(item => item.period === '离峰时段');
                const normalData = state.historyData.filter(item => item.period !== '尖峰时段' && item.period !== '离峰时段');
                
                // 计算平均延迟
                const avgMainlandAll = calculateAverage(state.historyData.map(item => item.mainlandLatency));
                const avgTaiwanAll = calculateAverage(state.historyData.map(item => item.taiwanLatency));
                
                const avgMainlandPeak = calculateAverage(peakData.map(item => item.mainlandLatency));
                const avgTaiwanPeak = calculateAverage(peakData.map(item => item.taiwanLatency));
                
                const avgMainlandOffPeak = calculateAverage(offPeakData.map(item => item.mainlandLatency));
                const avgTaiwanOffPeak = calculateAverage(offPeakData.map(item => item.taiwanLatency));
                
                // 计算标准差
                const stdDevMainland = calculateStandardDeviation(state.historyData.map(item => item.mainlandLatency));
                const stdDevTaiwan = calculateStandardDeviation(state.historyData.map(item => item.taiwanLatency));
                
                // 更新UI
                const avgMainlandElement = document.getElementById('avg-latency-mainland');
                const avgTaiwanElement = document.getElementById('avg-latency-taiwan');
                const stdDevMainlandElement = document.getElementById('std-dev-mainland');
                const stdDevTaiwanElement = document.getElementById('std-dev-taiwan');
                
                if (avgMainlandElement) avgMainlandElement.textContent = `${avgMainlandAll.toFixed(1)} ms`;
                if (avgTaiwanElement) avgTaiwanElement.textContent = `${avgTaiwanAll.toFixed(1)} ms`;
                if (stdDevMainlandElement) stdDevMainlandElement.textContent = `${stdDevMainland.toFixed(1)} ms`;
                if (stdDevTaiwanElement) stdDevTaiwanElement.textContent = `${stdDevTaiwan.toFixed(1)} ms`;
                
                // 更新基准分析
                const peakBaselineElement = document.getElementById('peak-baseline');
                const offpeakBaselineElement = document.getElementById('offpeak-baseline');
                const normalRangeElement = document.getElementById('normal-range');
                const anomalyCountElement = document.getElementById('anomaly-count');
                
                if (peakBaselineElement) peakBaselineElement.textContent = `${avgMainlandPeak.toFixed(1)} ms / ${avgTaiwanPeak.toFixed(1)} ms`;
                if (offpeakBaselineElement) offpeakBaselineElement.textContent = `${avgMainlandOffPeak.toFixed(1)} ms / ${avgTaiwanOffPeak.toFixed(1)} ms`;
                
                const normalRangeMainland = `±${stdDevMainland.toFixed(1)} ms`;
                const normalRangeTaiwan = `±${stdDevTaiwan.toFixed(1)} ms`;
                if (normalRangeElement) normalRangeElement.textContent = `${normalRangeMainland} / ${normalRangeTaiwan}`;
                
                // 检测异常点
                const anomalyCount = detectAnomalies(state.historyData);
                if (anomalyCountElement) anomalyCountElement.textContent = anomalyCount;
                
                // 更新时段分析图表
                updatePeriodAnalysisChart(avgMainlandPeak, avgMainlandOffPeak, avgMainlandAll, avgTaiwanPeak, avgTaiwanOffPeak, avgTaiwanAll);
                
                showNotification('数据分析完成', 'success');
            } catch (error) {
                console.error("运行数据分析时出错:", error);
                showNotification('数据分析失败: ' + error.message, 'error');
            }
        }

        // 计算平均值
        function calculateAverage(values) {
            try {
                const validValues = values.filter(v => v !== null && !isNaN(v));
                if (validValues.length === 0) return 0;
                
                const sum = validValues.reduce((a, b) => a + b, 0);
                return sum / validValues.length;
            } catch (error) {
                console.error("计算平均值时出错:", error);
                return 0;
            }
        }

        // 计算标准差
        function calculateStandardDeviation(values) {
            try {
                const validValues = values.filter(v => v !== null && !isNaN(v));
                if (validValues.length === 0) return 0;
                
                const avg = calculateAverage(validValues);
                const squareDiffs = validValues.map(value => Math.pow(value - avg, 2));
                const avgSquareDiff = calculateAverage(squareDiffs);
                return Math.sqrt(avgSquareDiff);
            } catch (error) {
                console.error("计算标准差时出错:", error);
                return 0;
            }
        }

        // 检测异常点
        function detectAnomalies(data) {
            try {
                if (data.length < 10) return 0;
                
                const mainlandValues = data.map(item => item.mainlandLatency).filter(v => v !== null);
                const taiwanValues = data.map(item => item.taiwanLatency).filter(v => v !== null);
                
                const mainlandStdDev = calculateStandardDeviation(mainlandValues);
                const taiwanStdDev = calculateStandardDeviation(taiwanValues);
                
                const mainlandAvg = calculateAverage(mainlandValues);
                const taiwanAvg = calculateAverage(taiwanValues);
                
                // 检测超过3倍标准差的点
                let anomalies = 0;
                
                data.forEach(item => {
                    if (item.mainlandLatency !== null && Math.abs(item.mainlandLatency - mainlandAvg) > 3 * mainlandStdDev) {
                        anomalies++;
                    } else if (item.taiwanLatency !== null && Math.abs(item.taiwanLatency - taiwanAvg) > 3 * taiwanStdDev) {
                        anomalies++;
                    }
                });
                
                return anomalies;
            } catch (error) {
                console.error("检测异常点时出错:", error);
                return 0;
            }
        }

        // 更新时段分析图表
        function updatePeriodAnalysisChart(mainlandPeak, mainlandOffPeak, mainlandNormal, taiwanPeak, taiwanOffPeak, taiwanNormal) {
            try {
                if (!state.periodChart) return;
                
                // 这里我们显示大陆节点的数据，或者可以添加切换显示大陆/台湾的选项
                state.periodChart.data.datasets[0].data = [mainlandPeak, mainlandOffPeak, mainlandNormal];
                state.periodChart.update();
            } catch (error) {
                console.error("更新时段分析图表时出错:", error);
            }
        }

        // ==================== Cloudflare 相关函数 ====================

        // 测试 Cloudflare 连接
        async function testCloudflareConnection() {
            try {
                showNotification('正在测试 Cloudflare 连接...', 'info');
                
                const response = await fetch(CLOUDFLARE_CONFIG.WORKER_URL + CLOUDFLARE_CONFIG.ENDPOINTS.TEST || CLOUDFLARE_CONFIG.WORKER_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    state.cloudflareConnected = true;
                    
                    // 更新UI
                    const statusElement = document.getElementById('cloud-connection-status');
                    if (statusElement) {
                        statusElement.textContent = '已连接';
                        statusElement.className = 'latency-good';
                    }
                    
                    const cloudStatusElement = document.getElementById('cloud-status');
                    if (cloudStatusElement) {
                        cloudStatusElement.textContent = '已连接';
                        cloudStatusElement.className = 'latency-good';
                    }
                    
                    showNotification('Cloudflare 连接成功!', 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Cloudflare 连接测试失败:', error);
                state.cloudflareConnected = false;
                
                // 更新UI
                const statusElement = document.getElementById('cloud-connection-status');
                if (statusElement) {
                    statusElement.textContent = '连接失败';
                    statusElement.className = 'latency-bad';
                }
                
                const cloudStatusElement = document.getElementById('cloud-status');
                if (cloudStatusElement) {
                    cloudStatusElement.textContent = '连接失败';
                    cloudStatusElement.className = 'latency-bad';
                }
                
                showNotification('Cloudflare 连接失败: ' + error.message, 'error');
                return false;
            }
        }

        // 保存数据到 Cloudflare
        async function saveToCloudflare(dataType, data) {
            if (!state.cloudflareConnected && !await testCloudflareConnection()) {
                throw new Error('Cloudflare 未连接');
            }
            
            try {
                const userId = config.userId || initUserId();
                const timestamp = new Date().toISOString();
                
                const payload = {
                    userId: userId,
                    dataType: dataType, // 'config', 'history', 'nodes', 'backup'
                    data: data,
                    timestamp: timestamp,
                    version: config.version
                };
                
                console.log('保存到 Cloudflare:', dataType, payload);
                
                const response = await fetch(CLOUDFLARE_CONFIG.WORKER_URL + CLOUDFLARE_CONFIG.ENDPOINTS.SAVE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log(`数据已保存到 Cloudflare: ${dataType}`, result);
                
                // 更新最后同步时间
                CLOUDFLARE_CONFIG.LAST_SYNC = new Date().toISOString();
                localStorage.setItem('latency_monitor_last_sync', CLOUDFLARE_CONFIG.LAST_SYNC);
                
                // 更新UI
                updateLastSyncTime();
                
                return result;
            } catch (error) {
                console.error('保存到 Cloudflare 失败:', error);
                throw error;
            }
        }

        // 从 Cloudflare 加载数据
        async function loadFromCloudflare(dataType) {
            if (!state.cloudflareConnected && !await testCloudflareConnection()) {
                throw new Error('Cloudflare 未连接');
            }
            
            try {
                const userId = config.userId || initUserId();
                
                const response = await fetch(
                    `${CLOUDFLARE_CONFIG.WORKER_URL}${CLOUDFLARE_CONFIG.ENDPOINTS.LOAD}?userId=${userId}&dataType=${dataType}`
                );
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log(`从 Cloudflare 加载数据: ${dataType}`, result);
                
                // 更新最后同步时间
                CLOUDFLARE_CONFIG.LAST_SYNC = new Date().toISOString();
                localStorage.setItem('latency_monitor_last_sync', CLOUDFLARE_CONFIG.LAST_SYNC);
                
                // 更新UI
                updateLastSyncTime();
                
                return result.data;
            } catch (error) {
                console.error('从 Cloudflare 加载失败:', error);
                throw error;
            }
        }

        // 同步所有数据到云端
        async function syncToCloud() {
            try {
                showNotification('正在同步数据到云端...', 'info');
                
                // 同步配置
                await saveToCloudflare('config', config);
                
                // 同步历史数据（限制最多1000条）
                const historyToSync = state.historyData.slice(-1000);
                await saveToCloudflare('history', historyToSync);
                
                // 同步节点数据
                await saveToCloudflare('nodes', config.nodes);
                
                showNotification('所有数据已同步到 Cloudflare!', 'success');
                
                // 更新云端数据状态
                updateCloudDataStatus();
                
                return true;
            } catch (error) {
                showNotification('同步失败: ' + error.message, 'error');
                return false;
            }
        }

        // 从云端同步数据
        async function syncFromCloud() {
            try {
                showNotification('正在从云端同步数据...', 'info');
                
                // 加载配置
                const cloudConfig = await loadFromCloudflare('config');
                if (cloudConfig) {
                    // 合并配置，保留本地自定义节点
                    const mergedNodes = {...cloudConfig.nodes, ...config.nodes};
                    cloudConfig.nodes = mergedNodes;
                    
                    Object.assign(config, cloudConfig);
                    saveConfig();
                    showNotification('配置已从云端同步', 'success');
                }
                
                // 加载历史数据
                const cloudHistory = await loadFromCloudflare('history');
                if (cloudHistory && Array.isArray(cloudHistory)) {
                    // 合并历史数据，去重
                    const existingTimestamps = new Set(state.historyData.map(item => item.timestamp));
                    const newItems = cloudHistory.filter(item => !existingTimestamps.has(item.timestamp));
                    
                    if (newItems.length > 0) {
                        state.historyData.push(...newItems);
                        state.historyData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        saveHistoryData();
                        showNotification(`历史数据已同步，新增 ${newItems.length} 条记录`, 'success');
                    } else {
                        showNotification('历史数据已是最新，无需同步', 'info');
                    }
                }
                
                // 加载节点数据
                const cloudNodes = await loadFromCloudflare('nodes');
                if (cloudNodes) {
                    // 合并节点数据
                    config.nodes = {...cloudNodes, ...config.nodes};
                    saveConfig();
                    showNotification('节点数据已同步', 'success');
                }
                
                // 更新UI
                updateNodeSelectOptions();
                renderNodesList();
                renderHistoryTable();
                updateChart();
                updateDataCounts();
                
                // 更新云端数据状态
                updateCloudDataStatus();
                
                return true;
            } catch (error) {
                showNotification('同步失败: ' + error.message, 'error');
                return false;
            }
        }

        // 创建完整备份
        async function backupAllData() {
            try {
                const backup = {
                    config: config,
                    history: state.historyData,
                    nodes: config.nodes,
                    timestamp: new Date().toISOString(),
                    version: config.version,
                    backupType: 'full'
                };
                
                // 保存到 Cloudflare
                await saveToCloudflare('backup', backup);
                
                // 同时下载到本地
                const backupData = JSON.stringify(backup, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(backupData);
                const exportFileName = `latency-backup-${new Date().toISOString().slice(0, 10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                showNotification('完整备份已创建并保存到云端!', 'success');
                return true;
            } catch (error) {
                showNotification('备份失败: ' + error.message, 'error');
                return false;
            }
        }

        // 从备份恢复
        async function restoreFromBackup() {
            try {
                showNotification('正在从云端恢复备份...', 'info');
                
                const backup = await loadFromCloudflare('backup');
                if (!backup) {
                    showNotification('找不到云端备份', 'error');
                    return false;
                }
                
                if (confirm('确定要从云端备份恢复数据吗？这将覆盖当前所有数据。')) {
                    // 恢复配置
                    if (backup.config) {
                        Object.assign(config, backup.config);
                        saveConfig();
                    }
                    
                    // 恢复历史数据
                    if (backup.history) {
                        state.historyData = backup.history;
                        saveHistoryData();
                    }
                    
                    // 恢复节点数据
                    if (backup.nodes) {
                        config.nodes = backup.nodes;
                        saveConfig();
                    }
                    
                    // 更新UI
                    updateNodeSelectOptions();
                    renderNodesList();
                    renderHistoryTable();
                    updateChart();
                    updateDataCounts();
                    
                    showNotification('已从云端备份恢复数据!', 'success');
                    return true;
                }
            } catch (error) {
                showNotification('恢复失败: ' + error.message, 'error');
                return false;
            }
        }

        // 清除云端数据
        async function clearCloudData() {
            if (confirm('警告：这将清除 Cloudflare 上的所有数据！此操作不可撤销。确定继续吗？')) {
                try {
                    // 发送空数据覆盖
                    await saveToCloudflare('config', {});
                    await saveToCloudflare('history', []);
                    await saveToCloudflare('nodes', {});
                    await saveToCloudflare('backup', {});
                    
                    showNotification('云端数据已清除!', 'success');
                    updateCloudDataStatus();
                } catch (error) {
                    showNotification('清除失败: ' + error.message, 'error');
                }
            }
        }

        // 更新最后同步时间显示
        function updateLastSyncTime() {
            if (CLOUDFLARE_CONFIG.LAST_SYNC) {
                const lastSyncTime = new Date(CLOUDFLARE_CONFIG.LAST_SYNC);
                const timeString = lastSyncTime.toLocaleString('zh-CN');
                
                const lastSyncElement = document.getElementById('last-sync-time');
                if (lastSyncElement) {
                    lastSyncElement.textContent = timeString;
                }
            }
        }

        // 更新云端数据状态显示
        function updateCloudDataStatus() {
            // 更新本地数据计数
            const localDataElement = document.getElementById('local-data-count');
            if (localDataElement) {
                localDataElement.textContent = state.historyData.length + ' 条记录';
            }
            
            // 更新云端存储信息
            const cloudStorageElement = document.getElementById('cloud-storage-info');
            if (cloudStorageElement) {
                if (state.cloudflareConnected) {
                    cloudStorageElement.textContent = '已连接，数据已加密';
                } else {
                    cloudStorageElement.textContent = '未连接';
                }
            }
            
            // 更新云端数据状态
            const cloudDataElement = document.getElementById('cloud-data-status');
            if (cloudDataElement) {
                if (CLOUDFLARE_CONFIG.LAST_SYNC) {
                    cloudDataElement.textContent = '已同步';
                    cloudDataElement.className = 'latency-good';
                } else {
                    cloudDataElement.textContent = '未同步';
                    cloudDataElement.className = 'latency-medium';
                }
            }
        }

        // 切换自动同步
        function toggleAutoSync() {
            CLOUDFLARE_CONFIG.AUTO_SYNC = !CLOUDFLARE_CONFIG.AUTO_SYNC;
            localStorage.setItem('latency_monitor_auto_sync', CLOUDFLARE_CONFIG.AUTO_SYNC.toString());
            
            const autoSyncStatusElement = document.getElementById('auto-sync-status');
            if (autoSyncStatusElement) {
                autoSyncStatusElement.textContent = CLOUDFLARE_CONFIG.AUTO_SYNC ? '开启' : '关闭';
            }
            
            if (CLOUDFLARE_CONFIG.AUTO_SYNC) {
                // 开始自动同步
                if (state.autoSyncInterval) {
                    clearInterval(state.autoSyncInterval);
                }
                state.autoSyncInterval = setInterval(() => {
                    if (state.cloudflareConnected) {
                        syncToCloud().catch(console.error);
                    }
                }, 300000); // 每5分钟同步一次
                
                showNotification('自动同步已开启，每5分钟同步一次', 'success');
            } else {
                // 停止自动同步
                if (state.autoSyncInterval) {
                    clearInterval(state.autoSyncInterval);
                    state.autoSyncInterval = null;
                }
                showNotification('自动同步已关闭', 'info');
            }
        }

        // ==================== 数据整合函数 ====================

        // 合并用户数据
        async function mergeUserData() {
            const mergeUserIdInput = document.getElementById('merge-user-id');
            if (!mergeUserIdInput) return;
            
            const mergeUserId = mergeUserIdInput.value.trim();
            if (!mergeUserId) {
                showNotification('请输入要合并的用户ID', 'error');
                return;
            }
            
            if (mergeUserId === config.userId) {
                showNotification('不能合并自己的用户数据', 'warning');
                return;
            }
            
            try {
                showNotification(`正在获取用户 ${mergeUserId} 的数据...`, 'info');
                
                // 临时切换用户ID以获取数据
                const originalUserId = CLOUDFLARE_CONFIG.USER_ID;
                CLOUDFLARE_CONFIG.USER_ID = mergeUserId;
                
                // 获取用户数据
                let userData = null;
                try {
                    userData = await loadFromCloudflare('history');
                } catch (error) {
                    console.warn(`无法获取用户 ${mergeUserId} 的数据:`, error);
                }
                
                // 恢复原始用户ID
                CLOUDFLARE_CONFIG.USER_ID = originalUserId;
                
                if (!userData || !Array.isArray(userData) || userData.length === 0) {
                    showNotification(`用户 ${mergeUserId} 没有数据或数据获取失败`, 'warning');
                    return;
                }
                
                // 合并数据
                const existingTimestamps = new Set(state.historyData.map(item => item.timestamp));
                const newItems = userData.filter(item => !existingTimestamps.has(item.timestamp));
                
                if (newItems.length === 0) {
                    showNotification(`用户 ${mergeUserId} 的数据与当前数据完全重复`, 'info');
                    return;
                }
                
                if (confirm(`确定要合并用户 ${mergeUserId} 的数据吗？\n将添加 ${newItems.length} 条新记录。`)) {
                    // 标记数据来源
                    newItems.forEach(item => {
                        item.sourceUserId = mergeUserId;
                    });
                    
                    // 添加到历史数据
                    state.historyData.push(...newItems);
                    
                    // 按时间戳排序
                    state.historyData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    // 保存数据
                    saveHistoryData();
                    
                    // 更新UI
                    updateDataCounts();
                    renderHistoryTable();
                    updateChart();
                    updateUserDataStats();
                    
                    showNotification(`已成功合并 ${newItems.length} 条记录来自用户 ${mergeUserId}`, 'success');
                    
                    // 清空输入框
                    mergeUserIdInput.value = '';
                }
            } catch (error) {
                console.error('合并用户数据失败:', error);
                showNotification(`合并用户数据失败: ${error.message}`, 'error');
            }
        }

        // 比较用户数据
        async function compareUserData() {
            const mergeUserIdInput = document.getElementById('merge-user-id');
            if (!mergeUserIdInput) return;
            
            const mergeUserId = mergeUserIdInput.value.trim();
            if (!mergeUserId) {
                showNotification('请输入要比较的用户ID', 'error');
                return;
            }
            
            if (mergeUserId === config.userId) {
                showNotification('不能比较自己的用户数据', 'warning');
                return;
            }
            
            try {
                showNotification(`正在获取用户 ${mergeUserId} 的数据进行比较...`, 'info');
                
                // 临时切换用户ID以获取数据
                const originalUserId = CLOUDFLARE_CONFIG.USER_ID;
                CLOUDFLARE_CONFIG.USER_ID = mergeUserId;
                
                // 获取用户数据
                let userData = null;
                try {
                    userData = await loadFromCloudflare('history');
                } catch (error) {
                    console.warn(`无法获取用户 ${mergeUserId} 的数据:`, error);
                }
                
                // 恢复原始用户ID
                CLOUDFLARE_CONFIG.USER_ID = originalUserId;
                
                if (!userData || !Array.isArray(userData) || userData.length === 0) {
                    showNotification(`用户 ${mergeUserId} 没有数据或数据获取失败`, 'warning');
                    return;
                }
                
                // 计算统计数据
                const currentStats = calculateUserStats(state.historyData);
                const otherStats = calculateUserStats(userData);
                
                // 显示比较结果
                const comparison = `
                    <h4>用户数据比较</h4>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px;">指标</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">当前用户 (${config.userId})</th>
                                <th style="border: 1px solid #ddd; padding: 8px;">对比用户 (${mergeUserId})</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">数据点数</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${currentStats.count}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${otherStats.count}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">大陆平均延迟</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${currentStats.avgMainland.toFixed(1)} ms</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${otherStats.avgMainland.toFixed(1)} ms</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">台湾平均延迟</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${currentStats.avgTaiwan.toFixed(1)} ms</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${otherStats.avgTaiwan.toFixed(1)} ms</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">测试时间段</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${currentStats.dateRange}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${otherStats.dateRange}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                
                // 创建一个模态框显示比较结果
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.justifyContent = 'center';
                modal.style.alignItems = 'center';
                modal.style.zIndex = '2000';
                
                const modalContent = document.createElement('div');
                modalContent.style.backgroundColor = 'white';
                modalContent.style.padding = '2rem';
                modalContent.style.borderRadius = '12px';
                modalContent.style.maxWidth = '600px';
                modalContent.style.maxHeight = '80vh';
                modalContent.style.overflow = 'auto';
                modalContent.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
                
                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">用户数据比较</h3>
                        <button id="close-comparison" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">×</button>
                    </div>
                    ${comparison}
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button id="merge-after-comparison" style="padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-merge"></i> 合并此用户数据
                        </button>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // 关闭按钮事件
                document.getElementById('close-comparison').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // 点击外部关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                // 合并按钮事件
                document.getElementById('merge-after-comparison').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    mergeUserIdInput.value = mergeUserId;
                    mergeUserData();
                });
                
            } catch (error) {
                console.error('比较用户数据失败:', error);
                showNotification(`比较用户数据失败: ${error.message}`, 'error');
            }
        }

        // 计算用户统计数据
        function calculateUserStats(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return {
                    count: 0,
                    avgMainland: 0,
                    avgTaiwan: 0,
                    dateRange: '无数据'
                };
            }
            
            // 计算平均延迟
            const validMainland = data.filter(item => item.mainlandLatency && item.mainlandLatency > 0);
            const validTaiwan = data.filter(item => item.taiwanLatency && item.taiwanLatency > 0);
            
            const avgMainland = validMainland.length > 0 ? 
                validMainland.reduce((sum, item) => sum + item.mainlandLatency, 0) / validMainland.length : 0;
            
            const avgTaiwan = validTaiwan.length > 0 ? 
                validTaiwan.reduce((sum, item) => sum + item.taiwanLatency, 0) / validTaiwan.length : 0;
            
            // 计算日期范围
            let dateRange = '无数据';
            if (data.length > 0) {
                const dates = data.map(item => new Date(item.timestamp)).filter(d => !isNaN(d.getTime()));
                if (dates.length > 0) {
                    const minDate = new Date(Math.min(...dates.map(d => d.getTime())));
                    const maxDate = new Date(Math.max(...dates.map(d => d.getTime())));
                    
                    const formatDate = (date) => {
                        return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                    };
                    
                    dateRange = `${formatDate(minDate)} - ${formatDate(maxDate)}`;
                }
            }
            
            return {
                count: data.length,
                avgMainland,
                avgTaiwan,
                dateRange
            };
        }

        // 导出当前用户数据
        function exportUserData() {
            try {
                const userData = {
                    userId: config.userId,
                    userIdType: config.userIdType,
                    config: config,
                    history: state.historyData,
                    nodes: config.nodes,
                    exportTime: new Date().toISOString(),
                    version: config.version
                };
                
                const dataStr = JSON.stringify(userData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileName = `latency-user-${config.userId}-${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                showNotification(`用户 ${config.userId} 的数据已导出`, 'success');
            } catch (error) {
                console.error("导出用户数据时出错:", error);
                showNotification('导出用户数据失败: ' + error.message, 'error');
            }
        }

        // 更新用户数据统计
        function updateUserDataStats() {
            // 更新用户总数
            const totalUsersElement = document.getElementById('total-users');
            if (totalUsersElement) {
                // 这里可以扩展为从云端获取用户列表
                totalUsersElement.textContent = '1';
            }
            
            // 更新总数据点数
            const totalDataPointsElement = document.getElementById('total-data-points');
            if (totalDataPointsElement) {
                totalDataPointsElement.textContent = state.historyData.length;
            }
            
            // 更新平均延迟
            const avgLatencyAllElement = document.getElementById('avg-latency-all');
            if (avgLatencyAllElement) {
                const stats = calculateUserStats(state.historyData);
                const avgLatency = (stats.avgMainland + stats.avgTaiwan) / 2;
                avgLatencyAllElement.textContent = avgLatency > 0 ? avgLatency.toFixed(1) + ' ms' : '--';
            }
            
            // 更新数据覆盖率
            const dataCoverageElement = document.getElementById('data-coverage');
            if (dataCoverageElement) {
                // 这里可以计算数据的时间覆盖率
                dataCoverageElement.textContent = state.historyData.length > 0 ? '100%' : '0%';
            }
        }

        // ==================== 事件监听器设置 ====================

        // 设置事件监听器
        function setupEventListeners() {
            console.log("开始设置事件监听器");
            
            // 标签切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    
                    // 移除所有active类
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前标签
                    this.classList.add('active');
                    const tabContent = document.getElementById(tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
            
            // 保存位置
            const saveLocationBtn = document.getElementById('save-location');
            if (saveLocationBtn) {
                saveLocationBtn.addEventListener('click', saveUserLocation);
                console.log("保存位置按钮监听器已设置");
            }
            
            // 开始监控
            const startMonitoringBtn = document.getElementById('start-monitoring');
            if (startMonitoringBtn) {
                startMonitoringBtn.addEventListener('click', startMonitoring);
                console.log("开始监控按钮监听器已设置");
            }
            
            // 停止监控
            const stopMonitoringBtn = document.getElementById('stop-monitoring');
            if (stopMonitoringBtn) {
                stopMonitoringBtn.addEventListener('click', stopMonitoring);
                console.log("停止监控按钮监听器已设置");
            }
            
            // 立即测试
            const testNowBtn = document.getElementById('test-now');
            if (testNowBtn) {
                testNowBtn.addEventListener('click', () => performTest(false));
                console.log("立即测试按钮监听器已设置");
            }
            
            const testMainlandBtn = document.getElementById('test-mainland');
            if (testMainlandBtn) {
                testMainlandBtn.addEventListener('click', () => performTest('mainland'));
                console.log("测试大陆按钮监听器已设置");
            }
            
            const testTaiwanBtn = document.getElementById('test-taiwan');
            if (testTaiwanBtn) {
                testTaiwanBtn.addEventListener('click', () => performTest('taiwan'));
                console.log("测试台湾按钮监听器已设置");
            }
            
            // 添加自定义节点
            const addCustomNodeBtn = document.getElementById('add-custom-node');
            if (addCustomNodeBtn) {
                addCustomNodeBtn.addEventListener('click', addCustomNode);
                console.log("添加自定义节点按钮监听器已设置");
            }
            
            // 保存节点设置
            const saveNodeSettingsBtn = document.getElementById('save-node-settings');
            if (saveNodeSettingsBtn) {
                saveNodeSettingsBtn.addEventListener('click', saveNodeSettings);
                console.log("保存节点设置按钮监听器已设置");
            }
            
            // 清除历史
            const clearHistoryBtn = document.getElementById('clear-history');
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', clearHistory);
                console.log("清除历史按钮监听器已设置");
            }
            
            // 分页
            const prevPageBtn = document.getElementById('prev-page');
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', prevPage);
                console.log("上一页按钮监听器已设置");
            }
            
            const nextPageBtn = document.getElementById('next-page');
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', nextPage);
                console.log("下一页按钮监听器已设置");
            }
            
            // 导出数据
            const exportJsonBtn = document.getElementById('export-json');
            if (exportJsonBtn) {
                exportJsonBtn.addEventListener('click', exportJSON);
                console.log("导出JSON按钮监听器已设置");
            }
            
            const exportCsvBtn = document.getElementById('export-csv');
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', exportCSV);
                console.log("导出CSV按钮监听器已设置");
            }
            
            // 导入数据
            const importDataBtn = document.getElementById('import-data');
            if (importDataBtn) {
                importDataBtn.addEventListener('click', importData);
                console.log("导入数据按钮监听器已设置");
            }
            
            const clearImportBtn = document.getElementById('clear-import');
            if (clearImportBtn) {
                clearImportBtn.addEventListener('click', clearImport);
                console.log("清除导入按钮监听器已设置");
            }
            
            // 图表周期选择
            const chartPeriodSelect = document.getElementById('chart-period');
            if (chartPeriodSelect) {
                chartPeriodSelect.addEventListener('change', updateChart);
                console.log("图表周期选择监听器已设置");
            }
            
            // 运行分析
            const runAnalysisBtn = document.getElementById('run-analysis');
            if (runAnalysisBtn) {
                runAnalysisBtn.addEventListener('click', runAnalysis);
                console.log("运行分析按钮监听器已设置");
            }
            
            // 导出节点列表
            const exportNodesBtn = document.getElementById('export-nodes');
            if (exportNodesBtn) {
                exportNodesBtn.addEventListener('click', exportNodes);
                console.log("导出节点列表按钮监听器已设置");
            }
            
            // 上传节点列表
            const uploadNodesBtn = document.getElementById('upload-nodes');
            if (uploadNodesBtn) {
                uploadNodesBtn.addEventListener('click', uploadNodes);
                console.log("上传节点列表按钮监听器已设置");
            }
            
            // 重置节点
            const resetNodesBtn = document.getElementById('reset-nodes');
            if (resetNodesBtn) {
                resetNodesBtn.addEventListener('click', resetNodes);
                console.log("重置节点按钮监听器已设置");
            }
            
            // ==================== Cloudflare 事件监听器 ====================
            
            // 测试 Cloudflare 连接
            const testCloudflareBtn = document.getElementById('test-cloudflare');
            if (testCloudflareBtn) {
                testCloudflareBtn.addEventListener('click', testCloudflareConnection);
                console.log("测试 Cloudflare 连接按钮监听器已设置");
            }
            
            // 保存用户ID (Cloudflare标签页)
            const saveUserIdBtn = document.getElementById('save-user-id');
            if (saveUserIdBtn) {
                saveUserIdBtn.addEventListener('click', saveUserId);
                console.log("保存用户ID按钮监听器已设置");
            }
            
            // 生成新用户ID (Cloudflare标签页)
            const generateUserIdBtn = document.getElementById('generate-user-id');
            if (generateUserIdBtn) {
                generateUserIdBtn.addEventListener('click', generateNewUserId);
                console.log("生成新用户ID按钮监听器已设置");
            }
            
            // 同步到云端
            const syncToCloudBtn = document.getElementById('sync-to-cloud');
            if (syncToCloudBtn) {
                syncToCloudBtn.addEventListener('click', syncToCloud);
                console.log("同步到云端按钮监听器已设置");
            }
            
            // 从云端同步
            const syncFromCloudBtn = document.getElementById('sync-from-cloud');
            if (syncFromCloudBtn) {
                syncFromCloudBtn.addEventListener('click', syncFromCloud);
                console.log("从云端同步按钮监听器已设置");
            }
            
            // 完整备份
            const backupAllBtn = document.getElementById('backup-all');
            if (backupAllBtn) {
                backupAllBtn.addEventListener('click', backupAllData);
                console.log("完整备份按钮监听器已设置");
            }
            
            // 恢复备份
            const restoreBackupBtn = document.getElementById('restore-backup');
            if (restoreBackupBtn) {
                restoreBackupBtn.addEventListener('click', restoreFromBackup);
                console.log("恢复备份按钮监听器已设置");
            }
            
            // 自动同步切换
            const autoSyncToggleBtn = document.getElementById('auto-sync-toggle');
            if (autoSyncToggleBtn) {
                autoSyncToggleBtn.addEventListener('click', toggleAutoSync);
                console.log("自动同步切换按钮监听器已设置");
            }
            
            // 清除云端数据
            const clearCloudDataBtn = document.getElementById('clear-cloud-data');
            if (clearCloudDataBtn) {
                clearCloudDataBtn.addEventListener('click', clearCloudData);
                console.log("清除云端数据按钮监听器已设置");
            }
            
            // ==================== 用户ID管理事件监听器 ====================
            
            // 设置自定义用户ID
            const setCustomUserIdBtn = document.getElementById('set-custom-user-id');
            if (setCustomUserIdBtn) {
                setCustomUserIdBtn.addEventListener('click', setCustomUserId);
                console.log("设置自定义用户ID按钮监听器已设置");
            }
            
            // 生成随机用户ID
            const generateRandomUserIdBtn = document.getElementById('generate-random-user-id');
            if (generateRandomUserIdBtn) {
                generateRandomUserIdBtn.addEventListener('click', generateRandomUserId);
                console.log("生成随机用户ID按钮监听器已设置");
            }
            
            // 重置用户ID
            const resetUserIdBtn = document.getElementById('reset-user-id');
            if (resetUserIdBtn) {
                resetUserIdBtn.addEventListener('click', resetUserId);
                console.log("重置用户ID按钮监听器已设置");
            }
            
            // 合并用户数据
            const mergeUserDataBtn = document.getElementById('merge-user-data');
            if (mergeUserDataBtn) {
                mergeUserDataBtn.addEventListener('click', mergeUserData);
                console.log("合并用户数据按钮监听器已设置");
            }
            
            // 比较用户数据
            const compareUserDataBtn = document.getElementById('compare-user-data');
            if (compareUserDataBtn) {
                compareUserDataBtn.addEventListener('click', compareUserData);
                console.log("比较用户数据按钮监听器已设置");
            }
            
            // 导出用户数据
            const exportUserDataBtn = document.getElementById('export-user-data');
            if (exportUserDataBtn) {
                exportUserDataBtn.addEventListener('click', exportUserData);
                console.log("导出用户数据按钮监听器已设置");
            }
            
            console.log("所有事件监听器设置完成");
        }

        // ==================== 初始化函数 ====================

        // 初始化应用
        function initApp() {
            console.log("执行initApp函数");
            
            // 初始化用户ID（必须首先执行）
            initUserId();
            
            // 加载配置和历史数据
            loadConfig();
            loadHistoryData();
            
            // 加载 Cloudflare 设置
            const autoSync = localStorage.getItem('latency_monitor_auto_sync');
            if (autoSync !== null) {
                CLOUDFLARE_CONFIG.AUTO_SYNC = autoSync === 'true';
            }
            
            const lastSync = localStorage.getItem('latency_monitor_last_sync');
            if (lastSync) {
                CLOUDFLARE_CONFIG.LAST_SYNC = lastSync;
            }
            
            // 初始化图表
            initCharts();
            
            // 初始化节点列表和下拉选项
            updateNodeSelectOptions();
            renderNodesList();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 更新当前时间
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // 更新计时器显示
            updateTimerDisplays();
            setInterval(updateTimerDisplays, 1000);
            
            // 更新 Cloudflare 相关UI
            updateLastSyncTime();
            updateCloudDataStatus();
            
            // 更新自动同步状态显示
            const autoSyncStatusElement = document.getElementById('auto-sync-status');
            if (autoSyncStatusElement) {
                autoSyncStatusElement.textContent = CLOUDFLARE_CONFIG.AUTO_SYNC ? '开启' : '关闭';
            }
            
            // 更新用户数据统计
            updateUserDataStats();
            
            // 显示欢迎通知
            showNotification(`应用已初始化完成，当前用户ID: ${config.userId}。请设置您的位置并开始监控。`, 'info');
            
            // 测试 Cloudflare 连接
            setTimeout(() => {
                testCloudflareConnection().then(connected => {
                    if (connected && CLOUDFLARE_CONFIG.AUTO_SYNC) {
                        // 如果自动同步开启，立即同步一次
                        syncToCloud().catch(console.error);
                    }
                });
            }, 2000);
            
            console.log("所有初始化步骤完成");
        }

        // DOM 加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM已加载，开始初始化应用");
            try {
                initApp();
                console.log("应用初始化完成");
            } catch (error) {
                console.error("初始化应用时出错:", error);
                showNotification('应用初始化失败: ' + error.message, 'error');
            }
        });

        console.log("脚本加载完成，等待DOM加载...");
    </script>
</body>
</html>
